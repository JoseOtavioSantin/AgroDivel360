<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Formulário de Peças do Equipamento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LIBS EXTERNAS -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- CSS -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/Pages/Formularios/style-forms.css">
  
  <style>
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      background-color: #fff;
      box-sizing: border-box;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #193b7c;
      box-shadow: 0 0 0 2px rgba(25, 59, 124, 0.25);
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .btn-primary,
    .btn-secondary,
    .btn-success,
    .btn-info {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 1rem;
      gap: 8px;
    }
    
    .btn-primary {
      background-color: #193b7c;
      color: #fff;
    }
    
    .btn-primary:hover {
      background-color: #132a5a;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-success {
      background-color: #28a745;
      color: #fff;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .btn-info {
      background-color: #17a2b8;
      color: #fff;
    }
    
    .btn-info:hover {
      background-color: #138496;
    }
    
    /* Estilos para a tabela de peças */
    .pecas-section {
      margin: 30px 0;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .pecas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .pecas-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
    }
    
    .pecas-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .tabela-pecas {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: #fff;
    }
    
    .tabela-pecas th,
    .tabela-pecas td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .tabela-pecas th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
      border-top: 1px solid #ddd;
    }
    
    .tabela-pecas input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .tabela-pecas input:focus {
      border-color: #193b7c;
      outline: none;
    }
    
    .btn-remover {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .btn-remover:hover {
      background-color: #c82333;
    }
    
    /* NOVO ESTILO PARA A SEÇÃO DE VALORES */
    .valores-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 12px;
      margin-top: 25px;
      border: 1px solid #e0e0e0;
    }
    
    .valores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .valor-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #193b7c;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .valor-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    .valor-card label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    
    .valor-card input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #193b7c;
      background: #fafbfc;
      transition: all 0.3s ease;
    }
    
    .valor-card input:focus {
      outline: none;
      border-color: #193b7c;
      background: white;
      box-shadow: 0 0 0 3px rgba(25, 59, 124, 0.1);
    }
    
    .valor-card input[readonly] {
      background-color: #f8f9fa;
      color: #495057;
      border-color: #d1d5db;
      cursor: not-allowed;
    }
    
    .resumo-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      border: 2px solid #193b7c;
      box-shadow: 0 4px 12px rgba(25, 59, 124, 0.15);
    }
    
    .resumo-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .resumo-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #193b7c;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .resumo-subtitle {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }
    
    .valor-total-grande {
      text-align: center;
      padding: 15px;
    }
    
    .valor-total-label {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .valor-total {
      font-size: 2.2rem;
      font-weight: 800;
      color: #193b7c;
      line-height: 1.2;
    }
    
    .subtotal-pecas {
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, #193b7c 0%, #2c5282 100%);
      color: white;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 1.1rem;
      box-shadow: 0 2px 8px rgba(25, 59, 124, 0.3);
    }
    
    .modelo-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #193b7c;
    }
    
    .modelo-section h4 {
      margin: 0 0 10px 0;
      color: #193b7c;
    }

    /* Estilo para o input file customizado */
    .file-input-container {
      position: relative;
      display: inline-block;
    }
    
    .file-input {
      position: absolute;
      left: -9999px;
    }
    
    .file-info {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .valores-grid {
        grid-template-columns: 1fr;
      }
      
      .valor-total {
        font-size: 1.8rem;
      }
      
      .pecas-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .pecas-buttons {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>

  <nav id="sidebar-placeholder"></nav>

  <section class="home">
    <div class="text">
      <h1 id="form-title">Novo Equipamento</h1>
      <p id="form-subtitle">Preencha os dados do equipamento e suas peças.</p>
    </div>

    <div class="content-card">
      <div class="content-card-body">
        <form id="formEquipamento">
          <!-- Seção de seleção de modelo -->
          <div class="modelo-section">
            <h4>Carregar Modelo Existente</h4>
            <div class="form-group">
              <label for="selecionar-modelo">Selecionar Modelo</label>
              <select id="selecionar-modelo">
                <option value="">Selecione um modelo para carregar...</option>
              </select>
            </div>
          </div>

          <!-- Dados básicos do equipamento -->
          <div class="form-group">
            <label for="tipo-equipamento">Tipo do Equipamento *</label>
            <select id="tipo-equipamento" required>
              <option value="">Selecione o tipo...</option>
              <option value="Trator">Trator</option>
              <option value="Colheitadeira">Colheitadeira</option>
              <option value="Pulverizador">Pulverizador</option>
            </select>
          </div>

          <div class="form-group">
            <label for="nome-equipamento">Nome do Equipamento *</label>
            <input type="text" id="nome-equipamento" placeholder="Ex: CR7.90, TX 1000, MX 250" required>
          </div>

          <div class="form-group">
            <label for="parte-equipamento">Parte do Equipamento *</label>
            <select id="parte-equipamento" required>
              <option value="">Selecione uma parte...</option>
            </select>
          </div>

          <!-- Seção de peças -->
          <div class="pecas-section">
            <div class="pecas-header">
              <h3 class="pecas-title">Peças da Parte do Equipamento</h3>
              <div class="pecas-buttons">
                <div class="file-input-container">
                  <button type="button" class="btn-info" id="btn-importar-pecas">
                    <i class='bx bx-upload'></i> Importar Excel
                  </button>
                  <input type="file" id="file-excel" class="file-input" accept=".xlsx, .xls">
                </div>
                <button type="button" class="btn-success" id="btn-adicionar-peca">
                  <i class='bx bx-plus'></i> Adicionar Peça
                </button>
              </div>
            </div>

            <div class="file-info" id="file-info">
              Formato esperado: Colunas "Codigo", "Descrição", "Quantidade"
            </div>

            <table class="tabela-pecas">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Descrição</th>
                  <th>Qtd</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="lista-pecas">
                <!-- Linhas de peças serão adicionadas dinamicamente aqui -->
              </tbody>
            </table>

            <!-- Seção simplificada sem valores -->
          </div>

          <div class="form-actions">
            <a href="/Pages/Tempario/Tempario.html" class="btn-secondary" id="btn-cancelar">
              <i class='bx bx-x'></i> Cancelar
            </a> 
            <button type="submit" class="btn-primary" id="btn-salvar">
              <i class='bx bx-save'></i> Salvar Equipamento
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script type="module">
    import { garantirAutenticacao } from '/assets/js/auth-guard.js';
    import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const equipamentosCollectionName = "equipamentosPartes";
    const modelosCollectionName = "modelosEquipamentos";
    let db;
    let userData;
    let editMode = false;
    let docId = null;

    // Função para processar arquivo Excel
    function processarExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Pega a primeira planilha
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Converte para JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Encontra os índices das colunas
            const headerRow = jsonData[0];
            const codigoIndex = headerRow.findIndex(col => 
              col.toString().toLowerCase().includes('codigo') || 
              col.toString().toLowerCase().includes('código')
            );
            const descricaoIndex = headerRow.findIndex(col => 
              col.toString().toLowerCase().includes('descrição') || 
              col.toString().toLowerCase().includes('descricao')
            );
            const quantidadeIndex = headerRow.findIndex(col => 
              col.toString().toLowerCase().includes('quantidade')
            );

            if (codigoIndex === -1 || descricaoIndex === -1 || quantidadeIndex === -1) {
              reject(new Error('Colunas não encontradas. Verifique se o arquivo tem as colunas: Codigo, Descrição, Quantidade'));
              return;
            }

            // Processa as linhas de dados
            const pecas = [];
            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (row && row[codigoIndex] && row[descricaoIndex]) {
                pecas.push({
                  codigo: row[codigoIndex].toString().trim(),
                  descricao: row[descricaoIndex].toString().trim(),
                  quantidade: parseInt(row[quantidadeIndex]) || 1
                });
              }
            }

            resolve(pecas);
          } catch (error) {
            reject(error);
          }
        };
        
        reader.onerror = function(error) {
          reject(error);
        };
        
        reader.readAsArrayBuffer(file);
      });
    }

    // Função para importar peças do Excel
    async function importarPecasDoExcel(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Verifica se é um arquivo Excel
      if (!file.name.match(/\.(xlsx|xls)$/)) {
        Swal.fire('Erro', 'Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
        return;
      }

      Swal.fire({
        title: 'Importando...',
        text: 'Processando arquivo Excel...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        const pecasImportadas = await processarExcel(file);
        
        if (pecasImportadas.length === 0) {
          Swal.fire('Atenção', 'Nenhuma peça válida encontrada no arquivo.', 'warning');
          return;
        }

        // Limpar peças existentes (opcional - perguntar ao usuário)
        const { value: limparExistente } = await Swal.fire({
          title: 'Importar peças',
          text: `Encontradas ${pecasImportadas.length} peças. Deseja limpar as peças atuais?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sim, limpar e importar',
          cancelButtonText: 'Não, adicionar às existentes',
          reverseButtons: true
        });

        if (limparExistente) {
          // Limpar peças existentes
          document.getElementById('lista-pecas').innerHTML = '';
        }

        // Adicionar peças importadas
        pecasImportadas.forEach(peca => {
          adicionarPeca(peca);
        });

        // Calcular valores
        calcularValores();

        Swal.fire('Sucesso!', `${pecasImportadas.length} peças importadas com sucesso!`, 'success');
        
        // Limpar input file
        event.target.value = '';

      } catch (error) {
        console.error('Erro ao importar Excel:', error);
        Swal.fire('Erro', `Falha ao importar arquivo: ${error.message}`, 'error');
      }
    }

    // Função para carregar partes já cadastradas para o equipamento
    async function carregarPartesExistentes(tipoEquipamento, nomeEquipamento) {
      try {
        const partesSelect = document.getElementById('parte-equipamento');
        
        // Guardar as partes atuais que já estão no select
        const partesAtuais = new Set();
        for (let i = 0; i < partesSelect.options.length; i++) {
          if (partesSelect.options[i].value) {
            partesAtuais.add(partesSelect.options[i].value);
          }
        }

        if (!tipoEquipamento || !nomeEquipamento) {
          return;
        }

        // Buscar partes já cadastradas para este equipamento
        const q = query(
          collection(db, equipamentosCollectionName),
          where("tipoEquipamento", "==", tipoEquipamento.toLowerCase()),
          where("nomeEquipamento", "==", nomeEquipamento)
        );

        const querySnapshot = await getDocs(q);
        const partesExistentes = new Set(partesAtuais); // Começar com as partes atuais

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (data.parteEquipamento) {
            partesExistentes.add(data.parteEquipamento);
          }
        });

        // Limpar e recriar o select com todas as partes (modelo + existentes)
        partesSelect.innerHTML = '<option value="">Selecione uma parte</option>';
        
        // Ordenar as partes alfabeticamente
        const partesOrdenadas = Array.from(partesExistentes).sort();
        
        partesOrdenadas.forEach(parte => {
          const option = document.createElement('option');
          option.value = parte;
          option.textContent = parte;
          partesSelect.appendChild(option);
        });

        console.log('Partes carregadas:', partesOrdenadas);

      } catch (error) {
        console.error('Erro ao carregar partes:', error);
      }
    }

    // Função para carregar modelos do Firestore
    async function carregarModelos() {
      try {
        const querySnapshot = await getDocs(collection(db, modelosCollectionName));
        const selectModelo = document.getElementById('selecionar-modelo');
        
        // Limpar opções exceto a primeira
        while (selectModelo.children.length > 1) {
          selectModelo.removeChild(selectModelo.lastChild);
        }
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${data.tipoEquipamento} - ${data.nomeEquipamento}`;
          // Garantir que as partes estão sendo passadas corretamente
          option.setAttribute('data-partes', JSON.stringify(data.partes || []));
          selectModelo.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar modelos:', error);
      }
    }

    // Função para preencher dados do modelo selecionado
    function preencherDadosModelo() {
      const selectModelo = document.getElementById('selecionar-modelo');
      const selectedOption = selectModelo.options[selectModelo.selectedIndex];
      
      if (selectedOption.value) {
        const partes = JSON.parse(selectedOption.getAttribute('data-partes'));
        const [tipo, nome] = selectedOption.textContent.split(' - ');
        
        console.log('Carregando modelo:', { tipo, nome, partes }); // DEBUG
        
        document.getElementById('tipo-equipamento').value = tipo || '';
        document.getElementById('nome-equipamento').value = nome || '';
        
        // Preencher o select de partes com as partes do modelo
        const parteSelect = document.getElementById('parte-equipamento');
        parteSelect.innerHTML = '<option value="">Selecione uma parte</option>';
        
        if (partes && partes.length > 0) {
          partes.forEach(parte => {
            const option = document.createElement('option');
            option.value = parte;
            option.textContent = parte;
            parteSelect.appendChild(option);
          });
          console.log('Partes adicionadas ao select:', partes); // DEBUG
        } else {
          console.log('Nenhuma parte encontrada no modelo'); // DEBUG
        }
        
        // Também carregar partes existentes
        carregarPartesExistentes(tipo, nome);
      }
    }

    // Event listeners para carregar partes quando os campos mudarem
    function configurarEventosPartes() {
      const tipoInput = document.getElementById('tipo-equipamento');
      const nomeInput = document.getElementById('nome-equipamento');

      tipoInput.addEventListener('change', function() {
        if (nomeInput.value) {
          carregarPartesExistentes(tipoInput.value, nomeInput.value);
        }
      });

      nomeInput.addEventListener('change', function() {
        if (tipoInput.value) {
          carregarPartesExistentes(tipoInput.value, nomeInput.value);
        }
      });

      nomeInput.addEventListener('blur', function() {
        if (tipoInput.value && nomeInput.value) {
          carregarPartesExistentes(tipoInput.value, nomeInput.value);
        }
      });
    }

    // Removido: cálculos de valores (form simplificado)

    // Função para adicionar nova linha de peça
    function adicionarPeca(dadosPeca = {}) {
      const tbody = document.getElementById('lista-pecas');
      const novaLinha = document.createElement('tr');
      novaLinha.innerHTML = `
        <td>
          <input type="text" class="peca-codigo" placeholder="Código" value="${dadosPeca.codigo || ''}" required>
        </td>
        <td>
          <input type="text" class="peca-descricao" placeholder="Descrição da peça" value="${dadosPeca.descricao || ''}" required>
        </td>
        <td>
          <input type="number" class="peca-quantidade" min="1" value="${dadosPeca.quantidade || 1}" required>
        </td>
        <td>
          <button type="button" class="btn-remover">
            <i class='bx bx-trash'></i>
          </button>
        </td>
      `;
      
      tbody.appendChild(novaLinha);
      
      // Adicionar evento de remoção
      novaLinha.querySelector('.btn-remover').addEventListener('click', function() {
        novaLinha.remove();
      });
    }

    // Função para coletar dados das peças
    function coletarPecas() {
      const pecas = [];
      const linhas = document.querySelectorAll('#lista-pecas tr');
      
      linhas.forEach(linha => {
        const codigo = linha.querySelector('.peca-codigo').value.trim();
        const descricao = linha.querySelector('.peca-descricao').value.trim();
        const quantidade = parseInt(linha.querySelector('.peca-quantidade').value);
        
        if (codigo && descricao && quantidade > 0) {
          pecas.push({
            codigo,
            descricao,
            quantidade
          });
        }
      });
      
      return pecas;
    }

    async function salvarEquipamento(event) {
      event.preventDefault();

      const pecas = coletarPecas();
      
      const dadosEquipamento = {
        tipoEquipamento: document.getElementById('tipo-equipamento').value.toLowerCase().trim(),
        nomeEquipamento: document.getElementById('nome-equipamento').value.trim(),
        parteEquipamento: document.getElementById('parte-equipamento').value.trim().toUpperCase(),
        pecas: pecas,
        dataCriacao: new Date().toISOString(),
        usuario: userData.nome || 'Usuário'
      };

      // Validações
      if (!dadosEquipamento.tipoEquipamento || !dadosEquipamento.nomeEquipamento || !dadosEquipamento.parteEquipamento) {
        return Swal.fire("Atenção", "Os campos 'Tipo do Equipamento', 'Nome do Equipamento' e 'Parte do Equipamento' são obrigatórios.", "warning");
      }

      if (dadosEquipamento.pecas.length === 0) {
        return Swal.fire("Atenção", "É necessário adicionar pelo menos uma peça.", "warning");
      }

      // Removidas validações relacionadas a valores monetários

      Swal.fire({ 
        title: editMode ? 'Atualizando...' : 'Salvando...', 
        text: 'Aguarde...', 
        allowOutsideClick: false, 
        didOpen: () => Swal.showLoading() 
      });

      try {
        if (editMode) {
          const docRef = doc(db, equipamentosCollectionName, docId);
          await updateDoc(docRef, dadosEquipamento);
          await Swal.fire('Sucesso!', 'Equipamento atualizado com sucesso!', 'success');
        } else {
          const docRef = await addDoc(collection(db, equipamentosCollectionName), dadosEquipamento);
          console.log('Documento salvo com ID:', docRef.id);
          await Swal.fire('Sucesso!', 'Equipamento salvo com sucesso!', 'success');
        }
        window.location.href = '/Pages/Tempario/Tempario.html';
      } catch (error) {
        console.error('Erro ao salvar:', error);
        Swal.fire('Erro!', `Falha ao salvar: ${error.message}`, 'error');
      }
    }

    async function carregarDadosParaEdicao(id) {
      const docRef = doc(db, equipamentosCollectionName, id);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        console.log('Dados carregados para edição:', data);
        
        // Preencher todos os campos
        document.getElementById('tipo-equipamento').value = data.tipoEquipamento || '';
        document.getElementById('nome-equipamento').value = data.nomeEquipamento || '';

        // Carregar partes existentes para preencher o select
        await carregarPartesExistentes(data.tipoEquipamento, data.nomeEquipamento);
        
        // Selecionar a parte atual
        const parteSelect = document.getElementById('parte-equipamento');
        parteSelect.value = data.parteEquipamento || '';

        // Carregar peças
        if (data.pecas && Array.isArray(data.pecas)) {
          data.pecas.forEach(peca => {
            adicionarPeca({
              codigo: peca.codigo,
              descricao: peca.descricao,
              quantidade: peca.quantidade
            });
          });
        }

        // Form simplificado: sem cálculo de valores
      } else {
        Swal.fire('Erro', 'Equipamento não encontrado. Redirecionando para a lista.', 'error');
        window.location.href = '/Pages/Tempario/Tempario.html';
      }
    }

    // Função para carregar dados da URL quando em modo edição
    function carregarParametrosURL() {
      const urlParams = new URLSearchParams(window.location.search);
      docId = urlParams.get('id');
      const parteEquipamento = urlParams.get('parte');
      const maquina = urlParams.get('maquina');
      const tipo = urlParams.get('tipo');

      // Se vier da página de partes, preencher automaticamente
      if (parteEquipamento && !docId) {
        document.getElementById('parte-equipamento').value = decodeURIComponent(parteEquipamento);
      }
      if (maquina && !docId) {
        document.getElementById('nome-equipamento').value = decodeURIComponent(maquina);
      }
      if (tipo && !docId) {
        document.getElementById('tipo-equipamento').value = decodeURIComponent(tipo);
      }
    }

    async function iniciarPagina() {
      try {
        userData = await garantirAutenticacao();
        const app = getApp();
        db = getFirestore(app);

        // Carregar parâmetros da URL primeiro
        carregarParametrosURL();

        // Carregar modelos existentes
        await carregarModelos();

        // Configurar eventos
        document.getElementById('selecionar-modelo').addEventListener('change', preencherDadosModelo);
        configurarEventosPartes();

        // Configurar importação de Excel
        document.getElementById('btn-importar-pecas').addEventListener('click', function() {
          document.getElementById('file-excel').click();
        });
        document.getElementById('file-excel').addEventListener('change', importarPecasDoExcel);

        // Adicionar primeira peça por padrão
        adicionarPeca();


        if (docId) {
          editMode = true;
          document.getElementById('form-title').textContent = 'Editar Equipamento';
          document.getElementById('form-subtitle').textContent = 'Altere os dados do equipamento abaixo.';
          document.getElementById('btn-salvar').innerHTML = '<i class="bx bx-save"></i> Salvar Alterações';
          await carregarDadosParaEdicao(docId);
        } else {
          // Form simplificado: sem cálculo de valores
        }

        document.getElementById('btn-adicionar-peca').addEventListener('click', () => adicionarPeca());
        document.getElementById('formEquipamento').addEventListener('submit', salvarEquipamento);

      } catch (error) {
        console.error("Falha na inicialização da página:", error);
        document.body.innerHTML = `<div class="error-container">Ocorreu um erro ao carregar. Verifique se está logado e tente novamente.</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', iniciarPagina);
  </script>

  <!-- Scripts Globais -->
  <script type="module" src="/assets/js/firebase-config.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>
  <script src="/assets/js/main.js"></script> 
  <script src="/assets/js/components/Sidebar.js"></script>

</body>
</html>
