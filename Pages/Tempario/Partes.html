<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partes - Agro Divel</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    
    <style>
        .partes-section {
            margin: 30px 0;
            padding: 20px;
        }

        .partes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .parte-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-decoration: none;
            color: inherit;
            display: block;
            position: relative;
        }

        .parte-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            border-color: #193b7c;
        }

        .parte-name {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .parte-valor {
            font-size: 16px;
            color: #27ae60;
            font-weight: 600;
        }

        .parte-info {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #193b7c;
            text-decoration: none;
        }

        .breadcrumb span {
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            text-align: center;
            color: #dc3545;
            padding: 20px;
            background: #f8d7da;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Botão de editar */
        .btn-editar-parte {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #193b7c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: none; /* Inicialmente escondido */
        }

        .btn-editar-parte:hover {
            background: #132a5a;
        }

        .parte-card:hover .btn-editar-parte {
            display: block;
        }

        .parte-card-com-botao {
            padding-top: 50px; /* Espaço para o botão flutuante */
        }
    </style>
</head>
<body>
    <nav id="sidebar-placeholder"></nav>

    <section class="home">
        <div class="text">
            <div class="breadcrumb">
                <a href="Tempario.html">Temporários</a>
                <span>></span>
                <a href="#" id="breadcrumb-tipo">Máquinas</a>
                <span>></span>
                <span id="current-maquina">Partes</span>
            </div>
            <h1 id="page-title">Partes da Máquina</h1>
            <p id="page-subtitle">Selecione uma parte para ver suas peças e valores.</p>
        </div>

        <div class="partes-section">
            <div class="partes-grid" id="partes-grid">
                <div class="loading">Carregando partes...</div>
            </div>
        </div>
    </section>

<script type="module">
    // --- LISTA DE PERMISSÕES ---
    const EMAILS_AUTORIZADOS = [
        'admin@gmail.com',
        'angelo.murilo@agrodivel.com'
    ];
    // --- FIM DA LISTA DE PERMISSÕES ---

    async function carregarPartes() {
        const urlParams = new URLSearchParams(window.location.search);
        const tipo = urlParams.get('tipo');
        const maquina = urlParams.get('maquina');
        
        if (!tipo || !maquina) {
            window.location.href = 'Tempario.html';
            return;
        }

        // Atualizar breadcrumb e títulos
        const tipoFormatado = tipo.charAt(0).toUpperCase() + tipo.slice(1);
        document.getElementById('breadcrumb-tipo').href = `Maquinas.html?tipo=${tipo}`;
        document.getElementById('breadcrumb-tipo').textContent = tipoFormatado + 's';
        document.getElementById('current-maquina').textContent = maquina;
        document.getElementById('page-title').textContent = `Partes - ${maquina}`;
        document.getElementById('page-subtitle').textContent = `Partes disponíveis para ${maquina}`;

        try {
            // Importar usando a mesma versão do seu firebase-config.js (9.22.1)
            const { db } = await import('/assets/js/firebase-config.js');
            const { getDocs, collection } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");

            // Buscar todos os documentos da coleção
            const querySnapshot = await getDocs(collection(db, "equipamentosPartes"));
            const grid = document.getElementById('partes-grid');
            grid.innerHTML = '';

            // Filtrar partes localmente (já que o Firestore não suporta múltiplos where)
            const partesFiltradas = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                
                // Usando os campos exatos do seu documento
                const nomeEquipamento = data.nomeEquipamento;
                const tipoEquipamento = data.tipoEquipamento;
                const parteEquipamento = data.parteEquipamento;
                
                if (nomeEquipamento && tipoEquipamento && parteEquipamento) {
                    // Normalizar strings para comparação
                    const tipoNormalizado = tipoEquipamento.toLowerCase()
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "")
                        .replace(/[^a-z0-9]/g, "");
                    
                    const tipoBuscado = tipo.toLowerCase()
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "")
                        .replace(/[^a-z0-9]/g, "");
                    
                    // Verificar se corresponde ao tipo e máquina
                    if (tipoNormalizado.includes(tipoBuscado) && nomeEquipamento === maquina) {
                        partesFiltradas.push({
                            id: doc.id,
                            ...data
                        });
                    }
                }
            });

            if (partesFiltradas.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; grid-column: 1/-1; color: #666;">
                        <h3>Nenhuma parte encontrada para ${maquina}</h3>
                        <p>Não foram encontradas partes cadastradas para esta máquina.</p>
                    </div>
                `;
                return;
            }

            // Agrupar partes por nome (para evitar duplicatas)
            const partesUnicas = {};
            partesFiltradas.forEach(parte => {
                if (!partesUnicas[parte.parteEquipamento]) {
                    partesUnicas[parte.parteEquipamento] = parte;
                }
            });

            // Verificar se o usuário atual está autorizado
            let isAutorizado = false;
            try {
                const { garantirAutenticacao } = await import('/assets/js/auth-guard.js');
                const userData = await garantirAutenticacao();
                const emailUsuarioLogado = userData.email.toLowerCase();
                isAutorizado = EMAILS_AUTORIZADOS.includes(emailUsuarioLogado);
            } catch (error) {
                console.log('Usuário não autorizado para edição');
            }

            // Criar cards para cada parte única
            Object.values(partesUnicas).forEach(parte => {
                const card = document.createElement('a');
                card.href = `Pecas.html?id=${parte.id}&maquina=${encodeURIComponent(maquina)}&parte=${encodeURIComponent(parte.parteEquipamento)}`;
                card.className = 'parte-card';
                
                // Adicionar classe especial se tiver botão de editar
                if (isAutorizado) {
                    card.classList.add('parte-card-com-botao');
                }
                
                const quantidadePecas = parte.pecas ? parte.pecas.length : 0;
                
                // CORREÇÃO: Usar os campos corretos do seu documento
                const valorHora = parte.valorHora ? 
                    `R$ ${parseFloat(parte.valorHora).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 'R$ 0,00';
                
                const valorMaoObra = parte.valorHaoObra ?  // Campo com erro de digitação no Firestore
                    `R$ ${parseFloat(parte.valorHaoObra).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : null;
                
                const valorPecas = parte.valorPecas ? 
                    `R$ ${parseFloat(parte.valorPecas).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : null;
                
                const valorTotal = parte.valorTotal ? 
                    `R$ ${parseFloat(parte.valorTotal).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : null;
                
                card.innerHTML = `
                    ${isAutorizado ? `
                        <button class="btn-editar-parte" onclick="event.preventDefault(); event.stopPropagation(); window.editarParte('${parte.id}')" title="Editar Parte">
                            <i class='bx bx-edit'></i> Editar
                        </button>
                    ` : ''}
                    
                    <h3 class="parte-name">${parte.parteEquipamento}</h3>
                    <div class="parte-valor">Valor Horas: ${valorHora}</div>
                    ${valorMaoObra ? `<div class="parte-info" style="color: #f39c12;">Valor Mão de Obra: ${valorMaoObra}</div>` : ''}
                    ${valorPecas ? `<div class="parte-info" style="color: #e74c3c;">Valor Peças: ${valorPecas}</div>` : ''}
                    ${valorTotal ? `<div class="parte-info" style="color: #27ae60; font-weight: bold;">Valor Total: ${valorTotal}</div>` : ''}
                    <div class="parte-info">${quantidadePecas} peça(s) cadastrada(s)</div>
                    ${parte.horasTrabalho ? `<div class="parte-info">Horas de trabalho: ${parte.horasTrabalho}h</div>` : ''}
                `;
                grid.appendChild(card);
            });

        } catch (error) {
            console.error('Erro ao carregar partes:', error);
            document.getElementById('partes-grid').innerHTML = `
                <div class="error-message">
                    <h3>Erro ao carregar partes</h3>
                    <p><strong>Mensagem:</strong> ${error.message}</p>
                    <p style="margin-top: 15px;">
                        <a href="Maquinas.html?tipo=${tipo}" style="color: #193b7c; text-decoration: underline; font-weight: bold;">
                            ↩️ Voltar para a seleção de máquinas
                        </a>
                    </p>
                </div>
            `;
        }
    }

// Função para editar parte - CORRIGIDA
async function editarParte(parteId) {
    try {
        console.log('Editando parte ID:', parteId);
        
        // Buscar os dados completos da parte para obter a parteEquipamento
        const { db } = await import('/assets/js/firebase-config.js');
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");
        
        const parteDoc = await getDoc(doc(db, "equipamentosPartes", parteId));
        
        if (parteDoc.exists()) {
            const parteData = parteDoc.data();
            const parteEquipamento = parteData.parteEquipamento || '';
            const nomeEquipamento = parteData.nomeEquipamento || '';
            const tipoEquipamento = parteData.tipoEquipamento || '';
            
            console.log('Dados da parte:', { parteEquipamento, nomeEquipamento, tipoEquipamento });
            
            // Redirecionar para o formulário passando TODOS os parâmetros necessários
            const params = new URLSearchParams({
                id: parteId,
                parte: encodeURIComponent(parteEquipamento),
                maquina: encodeURIComponent(nomeEquipamento),
                tipo: encodeURIComponent(tipoEquipamento),
                modo: 'edicao'
            });
            
            window.location.href = `/Pages/Tempario/form-cadastropacote.html?${params.toString()}`;
            
        } else {
            throw new Error('Parte não encontrada');
        }
        
    } catch (error) {
        console.error('Erro ao redirecionar para edição:', error);
        // Usar alerta nativo se SweetAlert não estiver disponível
        if (typeof Swal !== 'undefined') {
            Swal.fire('Erro', 'Não foi possível abrir a edição da parte.', 'error');
        } else {
            alert('Erro: Não foi possível abrir a edição da parte.');
        }
    }
}

    // Tornar a função global para ser acessível pelo onclick
    window.editarParte = editarParte;

    document.addEventListener('DOMContentLoaded', carregarPartes);
</script>

    <script type="module" src="/assets/js/firebase-config.js"></script>
    <script type="module" src="/assets/js/auth-guard.js"></script>
    <script type="module" src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/components/Sidebar.js"></script>
</body>

</html>

