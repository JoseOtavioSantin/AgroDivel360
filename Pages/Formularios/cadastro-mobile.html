<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Ferramenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#F0F2F5" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- FONTES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --cor-fundo: #F0F2F5;
            --cor-container: #FFFFFF;
            --cor-input: #F9F9F9;
            --cor-texto: #333333;
            --cor-texto-label: #555555;
            --cor-borda: #DCDCDC;
            --cor-primaria-inicio: #007BFF;
            --cor-primaria-fim: #005C97;
            --cor-secundaria: #6C757D;
            --shadow-color: rgba(0, 0, 0, 0.08 );
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1.5rem 1rem;
        }

        .form-container {
            background-color: var(--cor-container);
            padding: 2rem;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 8px 20px var(--shadow-color);
            border: 1px solid #E5E5E5;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        #form-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--cor-texto);
            margin-bottom: 0.25rem;
        }
        #form-subtitle {
            font-size: 0.9rem;
            color: #777;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--cor-texto-label);
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper .lucide {
            position: absolute;
            left: 1rem;
            color: #999;
            width: 1.25rem;
            height: 1.25rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3.2rem;
            border-radius: 8px;
            border: 1px solid var(--cor-borda);
            background-color: var(--cor-input);
            color: var(--cor-texto);
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--cor-primaria-fim);
            box-shadow: 0 0 0 3px rgba(0, 92, 151, 0.2);
        }

        .uppercase-input { text-transform: uppercase; }

        /* Área de Upload */
        #ferramenta-fotos { display: none; }
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.875rem;
            border-radius: 8px;
            border: 2px dashed var(--cor-borda);
            background-color: #FAFAFA;
            color: #888;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .file-upload-label:hover {
            background-color: #F5F5F5;
            border-color: var(--cor-primaria-fim);
            color: var(--cor-primaria-fim);
        }

        /* Preview de Imagens */
        #preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .preview-item { position: relative; }
        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--cor-borda);
        }
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #E53E3E;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .preview-placeholder { color: #AAA; font-size: 0.9rem; width: 100%; text-align: center; padding: 1rem 0; }

        /* Botões */
        .form-actions {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #EEE;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .btn {
            width: 100%;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: filter 0.2s ease;
        }
        .btn .lucide { width: 1.25rem; height: 1.25rem; }
        .btn:disabled {
            cursor: not-allowed;
            filter: grayscale(0.5) brightness(0.8);
        }
        .btn-primary {
            background: linear-gradient(145deg, var(--cor-primaria-inicio), var(--cor-primaria-fim));
        }
        .btn-primary:hover:not(:disabled) {
            filter: brightness(1.1);
        }
        .btn-secondary {
            background-color: #F0F0F0;
            border: 1px solid #DCDCDC;
            color: #555;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #E5E5E5;
        }

        /* Animação de Spin */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

    <div class="form-container">
        <div class="form-header">
            <h1 id="form-title">Cadastrar Ferramenta</h1>
            <p id="form-subtitle">Preencha os dados abaixo.</p>
        </div>

        <form id="form-ferramenta">
            <div class="form-group">
                <label for="ferramenta-filial">Filial</label>
                <div class="input-wrapper">
                    <i data-lucide="map-pin"></i>
                    <select id="ferramenta-filial" required><option value="">Selecione a Filial</option><option value="Campos Novos">Campos Novos</option><option value="Rio do Sul">Rio do Sul</option><option value="Lages">Lages</option></select>
                </div>
            </div>
            <div class="form-group">
                <label for="ferramenta-grupo">Grupo</label>
                <div class="input-wrapper">
                    <i data-lucide="tag"></i>
                    <select id="ferramenta-grupo" required><option value="">Aguardando...</option></select>
                </div>
            </div>
            <div class="form-group">
                <label for="ferramenta-codigo">Código</label>
                <div class="input-wrapper">
                    <i data-lucide="hash"></i>
                    <input type="text" id="ferramenta-codigo" required class="uppercase-input">
                </div>
            </div>
            <div class="form-group">
                <label for="ferramenta-descricao">Descrição</label>
                <div class="input-wrapper">
                    <i data-lucide="file-text"></i>
                    <input type="text" id="ferramenta-descricao" required class="uppercase-input">
                </div>
            </div>
            <div class="form-group">
                <label for="ferramenta-localizacao">Localização (Ex: 14 A 9)</label>
                <div class="input-wrapper">
                    <i data-lucide="archive"></i>
                    <input type="text" id="ferramenta-localizacao" required placeholder="Prateleira e Nível">
                </div>
            </div>
            <div class="form-group">
                <label for="ferramenta-quantidade">Quantidade</label>
                <div class="input-wrapper">
                    <i data-lucide="package"></i>
                    <input type="number" id="ferramenta-quantidade" required min="1" value="1">
                </div>
            </div>
            
            <div class="form-group">
                <label for="ferramenta-fotos">Fotos</label>
                <label for="ferramenta-fotos" class="file-upload-label">
                    <i data-lucide="camera"></i>
                    <span>Adicionar Fotos</span>
                </label>
                <input type="file" id="ferramenta-fotos" accept="image/*" capture="environment" multiple>
                <div id="preview-container"><span class="preview-placeholder">Nenhuma imagem</span></div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="btn-salvar"><i data-lucide="save"></i> Salvar</button>
                <button type="button" class="btn btn-secondary" id="btn-cancelar">Limpar Campos</button>
            </div>
        </form>
    </div>

    <script type="module">
        // Importa apenas o que é necessário para o banco de dados e armazenamento
        import { db, storage } from "/assets/js/firebase-config.js"; 
        import { collection, addDoc, getDocs, query, orderBy, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        // --- VARIÁVEIS GLOBAIS ---
        let ferramentaId = null;
        let urlsImagensExistentes = [];
        let novosArquivos = [];

        const form = document.getElementById('form-ferramenta' );
        const fotosInput = document.getElementById('ferramenta-fotos');
        const previewContainer = document.getElementById('preview-container');
        const btnSalvar = document.getElementById('btn-salvar');
        const btnCancelar = document.getElementById('btn-cancelar');
        const localizacaoInput = document.getElementById('ferramenta-localizacao');

        // --- FUNÇÕES DE UI ---
        const createLucideIcons = () => lucide.createIcons();
        
        function showToast(message, icon = 'success') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            });
            Toast.fire({ icon, title: message });
        }

        function limparFormulario() {
            form.reset();
            novosArquivos = [];
            urlsImagensExistentes = [];
            atualizarPreview();
            document.getElementById('ferramenta-filial').focus();
        }

        // --- LÓGICA DE LOCALIZAÇÃO ---
        localizacaoInput.addEventListener('input', (e) => {
            let valor = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            let match = valor.match(/^(\d+)([A-Z]?)(\d*)/);
            if (match) {
                let prateleira = match[1] || '', letra = match[2] || '', nivel = match[3] || '';
                e.target.value = letra ? `${prateleira} ${letra} ${nivel}`.trim() : prateleira;
            } else {
                e.target.value = valor;
            }
        });

        // --- LÓGICA DE UPLOAD E PREVIEW ---
        function atualizarPreview() {
            previewContainer.innerHTML = '';
            const todasImagens = [...urlsImagensExistentes, ...novosArquivos];

            if (todasImagens.length === 0) {
                previewContainer.innerHTML = '<span class="preview-placeholder">Nenhuma imagem</span>';
                return;
            }

            todasImagens.forEach((item) => {
                const isUrl = typeof item === 'string';
                const src = isUrl ? item : URL.createObjectURL(item);

                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.className = 'preview-image';
                if (!isUrl) img.onload = () => URL.revokeObjectURL(src);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-image-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => handleRemoverImagem(item, isUrl);

                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                previewContainer.appendChild(previewItem);
            });
        }

        function handleRemoverImagem(item, isUrl) {
            if (isUrl) {
                urlsImagensExistentes = urlsImagensExistentes.filter(url => url !== item);
            } else {
                novosArquivos = novosArquivos.filter(file => file !== item);
            }
            atualizarPreview();
        }

        fotosInput.addEventListener('change', e => {
            novosArquivos.push(...Array.from(e.target.files));
            atualizarPreview();
        });

        // --- LÓGICA PRINCIPAL (Firebase, etc.) ---
        async function carregarGrupos() {
            const selectGrupo = document.getElementById('ferramenta-grupo');
            selectGrupo.innerHTML = '<option value="">Buscando...</option>';
            try {
                const q = query(collection(db, 'grupos'), orderBy('nome'));
                const snapshot = await getDocs(q);
                selectGrupo.innerHTML = '<option value="">Selecione um Grupo</option>';
                snapshot.forEach(doc => {
                    selectGrupo.innerHTML += `<option value="${doc.id}">${doc.data().nome}</option>`;
                });
            } catch (error) {
                console.error("ERRO ao buscar grupos:", error);
                selectGrupo.innerHTML = '<option value="">Falha ao carregar</option>';
            }
        }

        async function preencherFormularioParaEdicao(id) {
            const ferramentaRef = doc(db, 'ferramentas', id);
            const docSnap = await getDoc(ferramentaRef);
            if (!docSnap.exists()) {
                Swal.fire('Erro!', 'Ferramenta não encontrada.', 'error');
                return;
            }
            const data = docSnap.data();
            document.getElementById('ferramenta-filial').value = data.filial;
            document.getElementById('ferramenta-grupo').value = data.grupoId;
            document.getElementById('ferramenta-codigo').value = data.codigo;
            document.getElementById('ferramenta-descricao').value = data.descricao;
            document.getElementById('ferramenta-localizacao').value = data.localizacao;
            document.getElementById('ferramenta-quantidade').value = data.quantidade;
            if (data.fotosURLs && data.fotosURLs.length > 0) {
                urlsImagensExistentes = [...data.fotosURLs];
                atualizarPreview();
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalButtonHtml = btnSalvar.innerHTML;
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Salvando...';
            createLucideIcons();

            try {
                const novasFotosURLs = [];
                if (novosArquivos.length > 0) {
                    const uploadPromises = novosArquivos.map(file => {
                        const filePath = `ferramentas/${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, filePath);
                        return uploadBytes(storageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                    });
                    novasFotosURLs.push(...await Promise.all(uploadPromises));
                }

                const todasFotosURLs = [...urlsImagensExistentes, ...novasFotosURLs];
                const dados = {
                    filial: document.getElementById('ferramenta-filial').value,
                    grupoId: document.getElementById('ferramenta-grupo').value,
                    codigo: document.getElementById('ferramenta-codigo').value.toUpperCase(),
                    descricao: document.getElementById('ferramenta-descricao').value.toUpperCase(),
                    localizacao: localizacaoInput.value.toUpperCase(),
                    quantidade: parseInt(document.getElementById('ferramenta-quantidade').value, 10),
                    fotosURLs: todasFotosURLs
                };

                let mensagemSucesso = '';
                if (ferramentaId) {
                    dados.dataAtualizacao = new Date();
                    await updateDoc(doc(db, 'ferramentas', ferramentaId), dados);
                    mensagemSucesso = 'Ferramenta atualizada com sucesso!';
                    await Swal.fire('Sucesso!', mensagemSucesso, 'success');
                    // No modo de edição, é comum redirecionar de volta para a lista
                    window.location.href = "/Pages/Controles/ControleFerramentas.html";
                } else {
                    dados.dataCriacao = new Date();
                    await addDoc(collection(db, 'ferramentas'), dados);
                    mensagemSucesso = 'Nova ferramenta cadastrada!';
                    showToast(mensagemSucesso, 'success');
                    limparFormulario();
                }

            } catch (error) {
                console.error("Erro ao salvar: ", error);
                Swal.fire('Erro!', `Ocorreu uma falha: ${error.message}`, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = originalButtonHtml;
                createLucideIcons();
            }
        });

        btnCancelar.addEventListener('click', limparFormulario);

        // --- INICIALIZAÇÃO ---
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                await carregarGrupos();
                
                const params = new URLSearchParams(window.location.search);
                ferramentaId = params.get('id');

                if (ferramentaId) {
                    document.title = "Editar Ferramenta";
                    document.getElementById('form-title').textContent = "Editar Ferramenta";
                    document.getElementById('form-subtitle').textContent = "Altere os dados da ferramenta.";
                    btnSalvar.innerHTML = '<i data-lucide="save"></i> Salvar Alterações';
                    btnCancelar.textContent = "Voltar"; // Muda o texto do botão no modo de edição
                    btnCancelar.onclick = () => { window.location.href = "/Pages/Controles/ControleFerramentas.html"; };
                    await preencherFormularioParaEdicao(ferramentaId);
                }
                
                createLucideIcons();
            } catch(error) {
                console.error("Falha na inicialização:", error);
                document.body.innerHTML = `<div style="color:black; text-align:center; padding: 2rem;"><h1>Erro Crítico</h1><p>Não foi possível carregar a página. Verifique a conexão e a configuração do Firebase.</p></div>`;
            }
        });
    </script>

</body>
</html>
