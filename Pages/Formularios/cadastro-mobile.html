<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Ferramenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- Use os mesmos estilos base, mas adicione os estilos mobile abaixo -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/Pages/Formularios/style-forms.css">

    <style>
        /* ESTILOS GERAIS PARA A PÁGINA MOBILE */
        body {
            background-color: #f4f7fa; /* Um fundo mais limpo para mobile */
            padding-bottom: 100px; /* Espaço para o rodapé de ações fixo */
        }

        /* Remove a sidebar e ajusta a seção principal */
        .home {
            left: 0;
            width: 100%;
            padding: 15px;
        }

        .text h1 {
            font-size: 1.8rem;
        }

        .content-card {
            padding: 15px;
        }

        /* Layout de coluna única para o formulário */
        .form-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* Apenas uma coluna */
            gap: 15px; 
        }

        /* Preview de Imagens */
        #preview-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 10px; 
            border: 2px dashed #ccc; 
            padding: 10px; 
            border-radius: 8px; 
            min-height: 100px; 
            align-items: center; 
            justify-content: flex-start; 
            background-color: #f9f9f9; 
        }
        .preview-item { position: relative; }
        .preview-image { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
        .remove-image-btn {
            position: absolute; top: -5px; right: -5px;
            background-color: #ff4d4d; color: white; border: none;
            border-radius: 50%; width: 22px; height: 22px;
            font-size: 14px; line-height: 22px; text-align: center;
            cursor: pointer; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.3 );
        }
        .preview-placeholder { color: #888; font-size: 0.9rem; }

        /* Estilo otimizado para o botão de upload de fotos */
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: block;
            width: 100%;
            text-align: center;
        }
        .btn-upload {
            border: 2px solid #007bff;
            color: #007bff;
            background-color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* Rodapé de ações fixo */
        .mobile-actions-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        .mobile-actions-footer .btn-secondary,
        .mobile-actions-footer .btn-primary {
            flex: 1; /* Faz os botões ocuparem o espaço igualmente */
            padding: 15px;
            font-size: 1rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-container { padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; color: #D8000C; border-radius: 8px; }
    </style>
</head>
<body>

    <!-- A sidebar foi removida como solicitado -->

    <section class="home">
        <div class="text">
            <h1 id="form-title">Cadastrar Ferramenta</h1>
            <p id="form-subtitle">Preencha os dados para registrar uma nova ferramenta.</p>
        </div>

        <div class="content-card">
            <div class="content-card-body">
                <form id="form-ferramenta">
                    <!-- O grid agora é de uma coluna só -->
                    <div class="form-grid">
                        <div class="form-group"><label for="ferramenta-filial">Filial</label><select id="ferramenta-filial" required><option value="">Selecione a Filial</option><option value="Campos Novos">Campos Novos</option><option value="Rio do Sul">Rio do Sul</option><option value="Lages">Lages</option></select></div>
                        <div class="form-group"><label for="ferramenta-grupo">Grupo</label><select id="ferramenta-grupo" required><option value="">Aguardando inicialização...</option></select></div>
                        <div class="form-group"><label for="ferramenta-codigo">Código da Ferramenta</label><input type="text" id="ferramenta-codigo" required></div>
                        <div class="form-group"><label for="ferramenta-descricao">Descrição</label><input type="text" id="ferramenta-descricao" required></div>
                        <div class="form-group"><label for="ferramenta-localizacao">Localização (Ex: 14 A 9)</label><input type="text" id="ferramenta-localizacao" required placeholder="Prateleira e Nível"></div>
                        <div class="form-group"><label for="ferramenta-quantidade">Quantidade</label><input type="number" id="ferramenta-quantidade" required min="1" value="1"></div>
                    </div>

                    <!-- Campo de fotos com botão otimizado para mobile -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Fotos da Ferramenta</label>
                        <div class="upload-btn-wrapper">
                            <button type="button" class="btn-upload"><i data-lucide="camera"></i> Adicionar Fotos</button>
                            <input type="file" id="ferramenta-fotos" accept="image/*" capture="environment" multiple>
                        </div>
                        <div id="preview-container">
                            <span class="preview-placeholder">Pré-visualização das imagens</span>
                        </div>
                    </div>

                    <!-- Botões de ação no rodapé fixo -->
                    <div class="mobile-actions-footer">
                        <a href="/Pages/Controles/ControleFerramentas.html" class="btn-secondary">Cancelar</a>
                        <button type="submit" class="btn-primary" id="btn-salvar"><i data-lucide="save"></i> Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Todo o seu JavaScript permanece o mesmo, pois a lógica não muda -->
    <script type="module">
        // SEU CÓDIGO JAVASCRIPT ORIGINAL VAI AQUI, SEM ALTERAÇÕES.
        // Ele já manipula os IDs corretos do formulário.
        import { inicializarFirebase } from "/assets/js/firebase-config.js"; 
        import { collection, addDoc, getDocs, query, orderBy, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";
        import { garantirAutenticacao } from '/assets/js/auth-guard.js';

        let db, storage, auth;
        let ferramentaId = null;
        let urlsImagensExistentes = [];

        const form = document.getElementById('form-ferramenta' );
        const fotosInput = document.getElementById('ferramenta-fotos');
        const previewContainer = document.getElementById('preview-container');
        const btnSalvar = document.getElementById('btn-salvar');
        const localizacaoInput = document.getElementById('ferramenta-localizacao');

        async function carregarGrupos() {
            const selectGrupo = document.getElementById('ferramenta-grupo');
            selectGrupo.innerHTML = '<option value="">Carregando...</option>';
            try {
                const q = query(collection(db, 'grupos'), orderBy('nome'));
                const snapshot = await getDocs(q);
                selectGrupo.innerHTML = '<option value="">Selecione um Grupo</option>';
                snapshot.forEach(doc => {
                    selectGrupo.innerHTML += `<option value="${doc.id}">${doc.data().nome}</option>`;
                });
            } catch (error) {
                console.error("Erro ao carregar grupos: ", error);
                selectGrupo.innerHTML = '<option value="">Falha ao carregar</option>';
            }
        }

        function exibirPreviews(urls) {
            previewContainer.innerHTML = '';
            if (urls.length === 0) {
                previewContainer.innerHTML = '<span class="preview-placeholder">Nenhuma imagem. Adicione novas fotos.</span>';
                return;
            }
            urls.forEach(url => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = url;
                img.className = 'preview-image';
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-image-btn';
                removeBtn.textContent = 'X';
                removeBtn.onclick = () => handleRemoverImagem(url);

                item.appendChild(img);
                item.appendChild(removeBtn);
                previewContainer.appendChild(item);
            });
        }

        async function handleRemoverImagem(urlParaRemover) {
            const confirmacao = await Swal.fire({
                title: 'Tem certeza?',
                text: "Deseja remover esta imagem? A remoção será permanente ao salvar.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sim, remover!',
                cancelButtonText: 'Cancelar'
            });

            if (confirmacao.isConfirmed) {
                urlsImagensExistentes = urlsImagensExistentes.filter(url => url !== urlParaRemover);
                exibirPreviews(urlsImagensExistentes);
                showToast('Imagem marcada para remoção.', 'info');
            }
        }

        async function preencherFormularioParaEdicao(id) {
            const ferramentaRef = doc(db, 'ferramentas', id);
            const docSnap = await getDoc(ferramentaRef);

            if (!docSnap.exists()) {
                Swal.fire('Erro!', 'Ferramenta não encontrada. Redirecionando...', 'error');
                setTimeout(() => window.location.href = "/Pages/Controles/ControleFerramentas.html", 2000);
                return;
            }

            const data = docSnap.data();
            document.getElementById('ferramenta-filial').value = data.filial;
            document.getElementById('ferramenta-grupo').value = data.grupoId;
            document.getElementById('ferramenta-codigo').value = data.codigo;
            document.getElementById('ferramenta-descricao').value = data.descricao;
            document.getElementById('ferramenta-localizacao').value = data.localizacao;
            document.getElementById('ferramenta-quantidade').value = data.quantidade;
            
            if (data.fotosURLs && data.fotosURLs.length > 0) {
                urlsImagensExistentes = [...data.fotosURLs];
                exibirPreviews(urlsImagensExistentes);
            }
        }

        localizacaoInput.addEventListener('input', (e) => {
            let valor = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            const match = valor.match(/^(\d+)([A-Z])(\d+)$/);
            e.target.value = match ? `${match[1]} ${match[2]} ${match[3]}` : valor;
        });

        fotosInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                if (previewContainer.querySelector('.preview-placeholder')) {
                    previewContainer.innerHTML = ''; // Limpa o placeholder
                }
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const item = document.createElement('div');
                        item.className = 'preview-item';
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.className = 'preview-image';
                        img.style.border = '2px solid #3085d6';
                        item.appendChild(img);
                        previewContainer.appendChild(item);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalButtonHtml = btnSalvar.innerHTML;
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Salvando...';
            lucide.createIcons();

            try {
                const novasFotosFiles = fotosInput.files;
                const novasFotosURLs = [];
                if (novasFotosFiles.length > 0) {
                    const uploadPromises = Array.from(novasFotosFiles).map(file => {
                        const filePath = `ferramentas/${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, filePath);
                        return uploadBytes(storageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                    });
                    novasFotosURLs.push(...await Promise.all(uploadPromises));
                }

                const todasFotosURLs = [...urlsImagensExistentes, ...novasFotosURLs];

                const dados = {
                    filial: document.getElementById('ferramenta-filial').value,
                    grupoId: document.getElementById('ferramenta-grupo').value,
                    codigo: document.getElementById('ferramenta-codigo').value.toUpperCase(),
                    descricao: document.getElementById('ferramenta-descricao').value.toUpperCase(),
                    localizacao: localizacaoInput.value,
                    quantidade: parseInt(document.getElementById('ferramenta-quantidade').value, 10),
                    fotosURLs: todasFotosURLs
                };

                if (ferramentaId) {
                    dados.dataAtualizacao = new Date();
                    const ferramentaRef = doc(db, 'ferramentas', ferramentaId);
                    await updateDoc(ferramentaRef, dados);
                    await Swal.fire('Sucesso!', 'Ferramenta atualizada com sucesso!', 'success');
                } else {
                    dados.dataCriacao = new Date();
                    await addDoc(collection(db, 'ferramentas'), dados);
                    await Swal.fire('Sucesso!', 'Ferramenta cadastrada com sucesso!', 'success');
                }
                
                window.location.href = "/Pages/Controles/ControleFerramentas.html";

            } catch (error) {
                console.error("Erro ao salvar ferramenta: ", error);
                Swal.fire('Erro!', `Ocorreu uma falha ao salvar: ${error.message}`, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = originalButtonHtml;
                lucide.createIcons();
            }
        });

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const firebase = inicializarFirebase();
                db = firebase.db;
                storage = firebase.storage;
                auth = firebase.auth;

                await garantirAutenticacao(auth); 
                await carregarGrupos();
                
                const params = new URLSearchParams(window.location.search);
                ferramentaId = params.get('id');

                if (ferramentaId) {
                    document.title = "Editar Ferramenta";
                    document.getElementById('form-title').textContent = "Editar Ferramenta";
                    document.getElementById('form-subtitle').textContent = "Altere os dados da ferramenta abaixo.";
                    await preencherFormularioParaEdicao(ferramentaId);
                }
                
                lucide.createIcons();
            } catch(error) {
                console.error("Falha CRÍTICA na inicialização:", error);
                const homeSection = document.querySelector('.home');
                if (homeSection) {
                    homeSection.innerHTML = `<div class="error-container"><h1>Erro Crítico</h1><p>Não foi possível inicializar a página. Verifique o console.</p><p><b>Erro:</b> ${error.message}</p></div>`;
                }
            }
        });

        function showToast(message, icon = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            });
            Toast.fire({ icon, title: message });
        }

        if (!document.querySelector('#spin-animation')) {
            const style = document.createElement('style');
            style.id = 'spin-animation';
            style.innerHTML = `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } } .spin { animation: spin 1s linear infinite; }`;
            document.head.appendChild(style);
        }
    </script>

</body>
</html>
