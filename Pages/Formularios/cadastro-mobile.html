<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Ferramenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/Pages/Formularios/style-forms.css">

    <style>
        /* Seus estilos CSS permanecem os mesmos */
        body { background-color: #f4f7fa; padding-bottom: 100px; }
        .home { left: 0; width: 100%; padding: 15px; }
        .text h1 { font-size: 1.8rem; }
        .content-card { padding: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05 ); }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        #preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; border: 2px dashed #ccc; padding: 10px; border-radius: 8px; min-height: 100px; align-items: center; justify-content: flex-start; background-color: #f9f9f9; }
        .preview-item { position: relative; }
        .preview-image { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
        .remove-image-btn { position: absolute; top: -5px; right: -5px; background-color: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; line-height: 22px; text-align: center; cursor: pointer; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .preview-placeholder { color: #888; font-size: 0.9rem; width: 100%; text-align: center; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: block; width: 100%; text-align: center; }
        .btn-upload { border: 2px solid #007bff; color: #007bff; background-color: white; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .mobile-actions-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff; padding: 15px; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); display: flex; gap: 10px; z-index: 100; }
        .mobile-actions-footer .btn-secondary, .mobile-actions-footer .btn-primary { flex: 1; padding: 15px; font-size: 1rem; text-align: center; display: flex; align-items: center; justify-content: center; }
        .error-container { padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; color: #D8000C; border-radius: 8px; }
    </style>
</head>
<body>

    <section class="home">
        <div class="text">
            <h1 id="form-title">Cadastrar Ferramenta</h1>
            <p id="form-subtitle">Preencha os dados para registrar uma nova ferramenta.</p>
        </div>

        <div class="content-card">
            <div class="content-card-body">
                <form id="form-ferramenta">
                    <div class="form-grid">
                        <!-- Campos do formulário -->
                        <div class="form-group"><label for="ferramenta-filial">Filial</label><select id="ferramenta-filial" required><option value="">Selecione a Filial</option><option value="Campos Novos">Campos Novos</option><option value="Rio do Sul">Rio do Sul</option><option value="Lages">Lages</option></select></div>
                        <div class="form-group"><label for="ferramenta-grupo">Grupo</label><select id="ferramenta-grupo" required><option value="">Aguardando inicialização...</option></select></div>
                        <div class="form-group"><label for="ferramenta-codigo">Código da Ferramenta</label><input type="text" id="ferramenta-codigo" required></div>
                        <div class="form-group"><label for="ferramenta-descricao">Descrição</label><input type="text" id="ferramenta-descricao" required></div>
                        <div class="form-group"><label for="ferramenta-localizacao">Localização (Ex: 14 A 9)</label><input type="text" id="ferramenta-localizacao" required placeholder="Prateleira e Nível"></div>
                        <div class="form-group"><label for="ferramenta-quantidade">Quantidade</label><input type="number" id="ferramenta-quantidade" required min="1" value="1"></div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Fotos da Ferramenta</label>
                        <div class="upload-btn-wrapper">
                            <button type="button" class="btn-upload"><i data-lucide="camera"></i> Adicionar Fotos</button>
                            <!-- O atributo 'multiple' é mantido para navegadores que o suportam -->
                            <input type="file" id="ferramenta-fotos" accept="image/*" capture="environment" multiple>
                        </div>
                        <div id="preview-container">
                            <span class="preview-placeholder">Pré-visualização das imagens</span>
                        </div>
                    </div>

                    <div class="mobile-actions-footer">
                        <a href="/Pages/Controles/ControleFerramentas.html" class="btn-secondary">Cancelar</a>
                        <button type="submit" class="btn-primary" id="btn-salvar"><i data-lucide="save"></i> Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script type="module">
        import { inicializarFirebase } from "/assets/js/firebase-config.js"; 
        // *** NOVO: Importa o login anônimo ***
        import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { collection, addDoc, getDocs, query, orderBy, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        let db, storage, auth; // A variável 'auth' foi adicionada novamente
        let ferramentaId = null;
        let urlsImagensExistentes = [];
        
        // *** NOVO: Array para acumular os arquivos de imagem selecionados ***
        let arquivosDeFotosParaUpload = [];

        const form = document.getElementById('form-ferramenta' );
        const fotosInput = document.getElementById('ferramenta-fotos');
        const previewContainer = document.getElementById('preview-container');
        const btnSalvar = document.getElementById('btn-salvar');
        const localizacaoInput = document.getElementById('ferramenta-localizacao');

        // ... (As funções carregarGrupos, exibirPreviews, handleRemoverImagem, preencherFormularioParaEdicao permanecem as mesmas)
        async function carregarGrupos() { /* ...código sem alteração... */ }
        function exibirPreviews(urls) { /* ...código sem alteração... */ }
        async function handleRemoverImagem(urlParaRemover) { /* ...código sem alteração... */ }
        async function preencherFormularioParaEdicao(id) { /* ...código sem alteração... */ }
        localizacaoInput.addEventListener('input', (e) => { /* ...código sem alteração... */ });

        // *** ALTERADO: Lógica para acumular fotos ***
        fotosInput.addEventListener('change', (e) => {
            const novosArquivos = Array.from(e.target.files);
            if (novosArquivos.length > 0) {
                // Adiciona os novos arquivos à nossa lista de upload
                arquivosDeFotosParaUpload.push(...novosArquivos);
                
                if (previewContainer.querySelector('.preview-placeholder')) {
                    previewContainer.innerHTML = '';
                }

                // Cria o preview para os novos arquivos
                novosArquivos.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const item = document.createElement('div');
                        item.className = 'preview-item';
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.className = 'preview-image';
                        img.style.border = '2px solid #3085d6'; // Borda azul para indicar que é nova
                        item.appendChild(img);
                        previewContainer.appendChild(item);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        // *** ALTERADO: Lógica de submit para usar o array de fotos acumuladas ***
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalButtonHtml = btnSalvar.innerHTML;
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Salvando...';
            lucide.createIcons();

            try {
                const novasFotosURLs = [];
                if (arquivosDeFotosParaUpload.length > 0) {
                    const uploadPromises = arquivosDeFotosParaUpload.map(file => {
                        const filePath = `ferramentas/${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, filePath);
                        return uploadBytes(storageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                    });
                    novasFotosURLs.push(...await Promise.all(uploadPromises));
                }

                const todasFotosURLs = [...urlsImagensExistentes, ...novasFotosURLs];
                const dados = {
                    filial: document.getElementById('ferramenta-filial').value,
                    grupoId: document.getElementById('ferramenta-grupo').value,
                    codigo: document.getElementById('ferramenta-codigo').value.toUpperCase(),
                    descricao: document.getElementById('ferramenta-descricao').value.toUpperCase(),
                    localizacao: localizacaoInput.value,
                    quantidade: parseInt(document.getElementById('ferramenta-quantidade').value, 10),
                    fotosURLs: todasFotosURLs
                };

                if (ferramentaId) {
                    dados.dataAtualizacao = new Date();
                    const ferramentaRef = doc(db, 'ferramentas', ferramentaId);
                    await updateDoc(ferramentaRef, dados);
                    await Swal.fire('Sucesso!', 'Ferramenta atualizada com sucesso!', 'success');
                } else {
                    dados.dataCriacao = new Date();
                    await addDoc(collection(db, 'ferramentas'), dados);
                    await Swal.fire('Sucesso!', 'Ferramenta cadastrada com sucesso!', 'success');
                }
                
                document.body.innerHTML = `<div style="padding: 40px; text-align: center;"><h1>Operação Concluída!</h1><p>Você já pode fechar esta página.</p></div>`;

            } catch (error) {
                console.error("Erro ao salvar ferramenta: ", error);
                Swal.fire('Erro!', `Ocorreu uma falha ao salvar: ${error.message}`, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = originalButtonHtml;
                lucide.createIcons();
            }
        });

        // *** ALTERADO: Inicialização da página com login anônimo ***
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const firebase = inicializarFirebase();
                db = firebase.db;
                storage = firebase.storage;
                auth = firebase.auth; // Inicializa o serviço de autenticação

                // Faz o login anônimo
                await signInAnonymously(auth);
                console.log("Login anônimo realizado com sucesso.");

                await carregarGrupos();
                
                const params = new URLSearchParams(window.location.search);
                ferramentaId = params.get('id');

                if (ferramentaId) {
                    document.title = "Editar Ferramenta";
                    document.getElementById('form-title').textContent = "Editar Ferramenta";
                    document.getElementById('form-subtitle').textContent = "Altere os dados da ferramenta abaixo.";
                    await preencherFormularioParaEdicao(ferramentaId);
                }
                
                lucide.createIcons();
            } catch(error) {
                console.error("Falha CRÍTICA na inicialização:", error);
                const homeSection = document.querySelector('.home');
                if (homeSection) {
                    homeSection.innerHTML = `<div class="error-container"><h1>Erro Crítico</h1><p>Não foi possível inicializar a página. Verifique o console.</p><p><b>Erro:</b> ${error.message}</p></div>`;
                }
            }
        });

        // ... (A função showToast e o estilo do spinner permanecem os mesmos)
        function showToast(message, icon = 'info') { /* ...código sem alteração... */ }
        if (!document.querySelector('#spin-animation')) { /* ...código sem alteração... */ }
    </script>

</body>
</html>
