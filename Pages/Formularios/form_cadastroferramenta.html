<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Ferramenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/Pages/Formularios/style-forms.css">

    <style>
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        #preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; border: 2px dashed #ccc; padding: 10px; border-radius: 8px; min-height: 120px; align-items: center; justify-content: flex-start; background-color: #f9f9f9; }
        .preview-item { position: relative; }
        .preview-image { width: 100px; height: 100px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
        .remove-image-btn { position: absolute; top: -5px; right: -5px; background-color: #ff4d4d; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.3 ); }
        .preview-placeholder { color: #888; font-size: 0.9rem; }
        .error-container { padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; color: #D8000C; border-radius: 8px; }
        .btn-qrcode { background-color: #6c757d; color: white; display: flex; align-items: center; gap: 8px; }
        #qrcode-container { display: flex; justify-content: center; align-items: center; padding: 20px; }
        #qrcode-container img { border: 5px solid white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } } .spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

    <nav id="sidebar-placeholder"></nav>

    <section class="home">
        <div class="text">
            <h1 id="form-title">Cadastrar Nova Ferramenta</h1>
            <p id="form-subtitle">Preencha os dados para registrar uma nova ferramenta no estoque.</p>
        </div>

        <div class="content-card">
            <div class="content-card-body">
                <form id="form-ferramenta">
                    <div class="form-grid">
                        <div class="form-group"><label for="ferramenta-filial">Filial</label><select id="ferramenta-filial" required><option value="">Selecione a Filial</option><option value="Campos Novos">Campos Novos</option><option value="Rio do Sul">Rio do Sul</option><option value="Lages">Lages</option></select></div>
                        <div class="form-group"><label for="ferramenta-grupo">Grupo</label><select id="ferramenta-grupo" required><option value="">Aguardando inicialização...</option></select></div>
                        <div class="form-group"><label for="ferramenta-codigo">Código da Ferramenta</label><input type="text" id="ferramenta-codigo" required></div>
                        <div class="form-group"><label for="ferramenta-descricao">Descrição</label><input type="text" id="ferramenta-descricao" required></div>
                        <div class="form-group"><label for="ferramenta-localizacao">Localização (Ex: 14 A 9 )</label><input type="text" id="ferramenta-localizacao" required placeholder="Prateleira e Nível"></div>
                        <div class="form-group"><label for="ferramenta-quantidade">Quantidade</label><input type="number" id="ferramenta-quantidade" required min="1" value="1"></div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label for="ferramenta-fotos">Fotos da Ferramenta (Adicionar novas)</label><input type="file" id="ferramenta-fotos" accept="image/*" capture="environment" multiple><div id="preview-container"><span class="preview-placeholder">Pré-visualização das imagens</span></div></div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary btn-qrcode" id="btn-qrcode"><i data-lucide="qr-code"></i> Cadastrar pelo Celular</button>
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <a href="/Pages/Controles/ControleFerramentas.html" class="btn-secondary">Cancelar</a>
                            <button type="submit" class="btn-primary" id="btn-salvar"><i data-lucide="save"></i> Salvar Ferramenta</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script type="module">
        // 1. Importa as instâncias PRONTAS do firebase-config
        import { db, auth, storage } from "/assets/js/firebase-config.js"; 
        
        // Importa as outras funções que você precisa do SDK do Firebase
        import { collection, addDoc, getDocs, query, orderBy, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";
        import { garantirAutenticacao } from '/assets/js/auth-guard.js';

        // --- VARIÁVEIS GLOBAIS ---
        let ferramentaId = null;
        let urlsImagensExistentes = [];

        const form = document.getElementById('form-ferramenta' );
        const fotosInput = document.getElementById('ferramenta-fotos');
        const previewContainer = document.getElementById('preview-container');
        const btnSalvar = document.getElementById('btn-salvar');
        const localizacaoInput = document.getElementById('ferramenta-localizacao');
        const btnQrCode = document.getElementById('btn-qrcode');

        // --- FUNÇÃO DE CARREGAMENTO DE GRUPOS ---
        async function carregarGrupos() {
            const selectGrupo = document.getElementById('ferramenta-grupo');
            selectGrupo.innerHTML = '<option value="">Buscando grupos...</option>';
            try {
                const q = query(collection(db, 'grupos'), orderBy('nome'));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    console.log("Nenhum documento encontrado na coleção 'grupos'.");
                    selectGrupo.innerHTML = '<option value="">Nenhum grupo encontrado</option>';
                } else {
                    console.log(`Encontrados ${snapshot.size} grupos.`);
                    selectGrupo.innerHTML = '<option value="">Selecione um Grupo</option>';
                    snapshot.forEach(doc => {
                        selectGrupo.innerHTML += `<option value="${doc.id}">${doc.data().nome}</option>`;
                    });
                }
            } catch (error) {
                console.error("ERRO ao buscar grupos:", error);
                selectGrupo.innerHTML = '<option value="">Falha ao carregar</option>';
                if (error.code === 'failed-precondition') {
                    console.error("DICA: O índice para 'grupos' ordenado por 'nome' está faltando. Crie-o no console do Firebase.");
                }
            }
        }

        // --- FUNÇÃO DE GERAÇÃO DE QR CODE ---
        function mostrarQrCode() {
            const urlPaginaMobile = '/Pages/Formularios/cadastro-mobile.html';
            const urlFinal = ferramentaId ? `${window.location.origin}${urlPaginaMobile}?id=${ferramentaId}` : `${window.location.origin}${urlPaginaMobile}`;
            try {
                const qr = qrcode(4, 'L');
                qr.addData(urlFinal);
                qr.make();
                const qrCodeImage = qr.createDataURL(10, 10);
                Swal.fire({
                    title: 'Cadastrar pelo Celular',
                    html: `<p>Leia o QR Code com a câmera do seu celular para abrir o formulário.</p><div id="qrcode-container"><img src="${qrCodeImage}" alt="QR Code"></div>`,
                    confirmButtonText: 'Fechar',
                    width: 'auto'
                });
            } catch (error) {
                console.error("Erro ao gerar QR Code:", error);
                Swal.fire('Erro!', 'Não foi possível gerar o QR Code.', 'error');
            }
        }

        // --- LÓGICA DE EDIÇÃO E PREVIEWS ---
        function exibirPreviews(urls) {
            previewContainer.innerHTML = '';
            if (urls.length === 0) {
                previewContainer.innerHTML = '<span class="preview-placeholder">Nenhuma imagem. Adicione novas fotos.</span>';
                return;
            }
            urls.forEach(url => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                const img = document.createElement('img');
                img.src = url;
                img.className = 'preview-image';
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-image-btn';
                removeBtn.textContent = 'X';
                removeBtn.onclick = () => handleRemoverImagem(url);
                item.appendChild(img);
                item.appendChild(removeBtn);
                previewContainer.appendChild(item);
            });
        }

        async function handleRemoverImagem(urlParaRemover) {
            const confirmacao = await Swal.fire({ title: 'Tem certeza?', text: "Deseja remover esta imagem? A remoção será permanente ao salvar.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Sim, remover!', cancelButtonText: 'Cancelar' });
            if (confirmacao.isConfirmed) {
                urlsImagensExistentes = urlsImagensExistentes.filter(url => url !== urlParaRemover);
                exibirPreviews(urlsImagensExistentes);
                showToast('Imagem marcada para remoção.', 'info');
            }
        }

        async function preencherFormularioParaEdicao(id) {
            const ferramentaRef = doc(db, 'ferramentas', id);
            const docSnap = await getDoc(ferramentaRef);
            if (!docSnap.exists()) {
                Swal.fire('Erro!', 'Ferramenta não encontrada. Redirecionando...', 'error');
                setTimeout(() => window.location.href = "/Pages/Controles/ControleFerramentas.html", 2000);
                return;
            }
            const data = docSnap.data();
            document.getElementById('ferramenta-filial').value = data.filial;
            document.getElementById('ferramenta-grupo').value = data.grupoId;
            document.getElementById('ferramenta-codigo').value = data.codigo;
            document.getElementById('ferramenta-descricao').value = data.descricao;
            document.getElementById('ferramenta-localizacao').value = data.localizacao;
            document.getElementById('ferramenta-quantidade').value = data.quantidade;
            if (data.fotosURLs && data.fotosURLs.length > 0) {
                urlsImagensExistentes = [...data.fotosURLs];
                exibirPreviews(urlsImagensExistentes);
            }
        }

        // --- EVENT LISTENERS ---
        btnQrCode.addEventListener('click', mostrarQrCode);

        localizacaoInput.addEventListener('input', (e) => {
            let valor = e.target.value.toUpperCase().replace(/[^A-Z0-9\s]/g, '');
            const match = valor.match(/^(\d+)\s*([A-Z])\s*(\d+)$/);
            e.target.value = match ? `${match[1]} ${match[2]} ${match[3]}` : valor;
        });

        fotosInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const placeholder = previewContainer.querySelector('.preview-placeholder');
                if (placeholder) placeholder.remove();
                
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.className = 'preview-image';
                        img.style.border = '2px solid #3085d6';
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalButtonHtml = btnSalvar.innerHTML;
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Salvando...';
            lucide.createIcons();

            try {
                const novasFotosFiles = fotosInput.files;
                const novasFotosURLs = [];
                if (novasFotosFiles.length > 0) {
                    const uploadPromises = Array.from(novasFotosFiles).map(file => {
                        const filePath = `ferramentas/${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, filePath);
                        return uploadBytes(storageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                    });
                    novasFotosURLs.push(...await Promise.all(uploadPromises));
                }

                const todasFotosURLs = [...urlsImagensExistentes, ...novasFotosURLs];

                const dados = {
                    filial: document.getElementById('ferramenta-filial').value,
                    grupoId: document.getElementById('ferramenta-grupo').value,
                    codigo: document.getElementById('ferramenta-codigo').value.toUpperCase(),
                    descricao: document.getElementById('ferramenta-descricao').value.toUpperCase(),
                    localizacao: localizacaoInput.value,
                    quantidade: parseInt(document.getElementById('ferramenta-quantidade').value, 10),
                    fotosURLs: todasFotosURLs
                };

                if (ferramentaId) {
                    dados.dataAtualizacao = new Date();
                    const ferramentaRef = doc(db, 'ferramentas', ferramentaId);
                    await updateDoc(ferramentaRef, dados);
                    await Swal.fire('Sucesso!', 'Ferramenta atualizada com sucesso!', 'success');
                } else {
                    dados.dataCriacao = new Date();
                    await addDoc(collection(db, 'ferramentas'), dados);
                    await Swal.fire('Sucesso!', 'Ferramenta cadastrada com sucesso!', 'success');
                }
                
                window.location.href = "/Pages/Controles/ControleFerramentas.html";

            } catch (error) {
                console.error("Erro ao salvar ferramenta: ", error);
                Swal.fire('Erro!', `Ocorreu uma falha ao salvar: ${error.message}`, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = originalButtonHtml;
                lucide.createIcons();
            }
        });

        // --- INICIALIZAÇÃO DA PÁGINA ---
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // 1. Garante que o usuário está autenticado (db, auth, storage já foram importados)
                await garantirAutenticacao(auth); 

                // 2. Carrega os dados da página
                await carregarGrupos();
                
                // 3. Continua com a lógica da página
                const params = new URLSearchParams(window.location.search);
                ferramentaId = params.get('id');

                if (ferramentaId) {
                    document.title = "Editar Ferramenta";
                    document.getElementById('form-title').textContent = "Editar Ferramenta";
                    document.getElementById('form-subtitle').textContent = "Altere os dados da ferramenta abaixo.";
                    btnSalvar.innerHTML = '<i data-lucide="save"></i> Salvar Alterações';
                    await preencherFormularioParaEdicao(ferramentaId);
                }
                
                lucide.createIcons();
            } catch(error) {
                console.error("Falha CRÍTICA na inicialização:", error);
                const homeSection = document.querySelector('.home');
                if (homeSection) {
                    homeSection.innerHTML = `<div class="error-container"><h1>Erro Crítico</h1><p>Não foi possível inicializar a página. Verifique o console.</p><p><b>Erro:</b> ${error.message}</p></div>`;
                }
            }
        });

        // --- FUNÇÕES UTILITÁRIAS ---
        function showToast(message, icon = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            });
            Toast.fire({ icon, title: message });
        }
    </script>

    <!-- Scripts Globais -->
    <script type="module" src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script> 
    <script src="/assets/js/components/Sidebar.js"></script>
</body>
</html>
