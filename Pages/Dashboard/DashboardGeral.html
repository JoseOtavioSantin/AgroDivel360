<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Painel de Gestão (Multi-Coleções)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Seu CSS continua o mesmo, sem alterações */
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; background:#1e1e2f; color:#fff; display:flex; flex-direction:column; height:100vh; }
    header { background:#2c2f3f; padding:20px; text-align:center; font-size:20px; font-weight:bold; color:#fff; letter-spacing:1px; box-shadow:0 2px 4px rgba(0,0,0,.2 ); }
    #dynamic-title { margin-top:10px; font-size:16px; font-weight:normal; color:#ccc; }
    .main { display:flex; flex:1; overflow:hidden; }
    .sidebar { width:250px; background:#2c2f3f; padding:20px; display:flex; flex-direction:column; gap:20px; overflow-y:auto; }
    .card { padding:20px; border-radius:16px; color:white; background:linear-gradient(135deg,#2e2f4f,#1e1e2f); box-shadow:0 4px 12px rgba(0,0,0,.3); transition:transform .2s, box-shadow .2s; display:flex; flex-direction:column; gap:6px; }
    .card:hover{ transform:scale(1.02); box-shadow:0 6px 16px rgba(0,0,0,.4); }
    .card h2 { margin:0; font-size:28px; }
    .card p { margin:0; font-size:14px; color:#eee; display:flex; align-items:center; gap:8px; }
    .pink-card,.orange-card,.blue-card,.green-card,.red-card{ background:linear-gradient(238deg,#193b7c,#193b7c00); }
    .content { flex:1; padding:30px; background:#262a3d; overflow-y:auto; }
    .filters { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px; align-items:center; }
    .filters input,.filters select{ padding:8px; border-radius:6px; border:none; min-width:180px; }
    .collections-bar{ display:flex; gap:8px; align-items:center; margin-bottom:18px; flex-wrap:wrap; }
    .chip{ background:#111827; border:1px solid #374151; padding:6px 10px; border-radius:999px; font-size:12px; }
    .collections-bar input{ background:#0b0d12; color:#e5e7eb; border:1px solid #374151; padding:8px 10px; border-radius:8px; }
    .collections-bar button{ background:linear-gradient(135deg,#00205b,#009bd6); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    table{ width:100%; border-collapse:collapse; background:#2c2f3f; border-radius:12px; overflow:hidden; }
    th,td{ font-size:12px; padding:10px 15px; text-align:left; border-bottom:1px solid #444; }
    th{ background:#fff; color:#00205b; }
    .status-em-andamento{ background:#c67903; }
    .status-sem-resposta{ background:#626262; }
    .status-concluido{ background:#047857; }
    .status-cancelado{ background:#b91c1c; }
    .btn-acao{ background:linear-gradient(135deg,#00205b,#009bd6); border:none; padding:6px 10px; border-radius:6px; color:#fff; font-size:16px; cursor:pointer; transition:transform .2s, box-shadow .2s; }
    .btn-acao:hover{ transform:scale(1.05); box-shadow:0 4px 12px rgba(0,187,249,.4); }
    .logo{ height:80px; margin-left:45px; margin-right:15px; }
    @media (max-width:768px){
      header{ padding:10px; }
      .logo{ height:40px; margin-left:20px; margin-right:15px; }
      #dynamic-title, header em{ font-size:15px!important; }
      .main{ flex-direction:column; }
      .sidebar{ display:flex; flex-wrap:wrap; justify-content:center; gap:10px; padding:15px; width:100%; }
      .card{ flex:1 1; min-width:140px; text-align:center; padding:12px; border-radius:12px; font-size:14px; }
      .card h2{ font-size:22px; }
      .filters{ flex-direction:column; align-items:stretch; }
      .filters input,.filters select,.filters button{ width:100%; min-width:auto; }
      table{ font-size:10px; display:block; overflow-x:auto; white-space:nowrap; }
      th,td{ padding:6px 10px; }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <img src="/assets/images/logo.png" alt="Logo" class="logo">
      <div style="flex:1; text-align:center;">
        <em>Dashboard Agro Divel 360</em>
        <div id="dynamic-title" style="font-style: italic;">Aguardando autenticação...</div>
      </div>
      <div style="width:65px;"></div>
    </div>
  </header>

  <button onclick="window.history.back()" title="Voltar"
    style="position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #00205b, #009bd6); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 9999;">
    ← Voltar
  </button>

  <div class="main">
    <div class="sidebar">
      <div class="card pink-card"><h2 id="total-exibidos">0</h2><p><i data-lucide="list-checks"></i> Itens no painel</p></div>
      <div class="card orange-card"><h2 id="total-andamento">0</h2><p><i data-lucide="clock-6"></i> Em andamento</p></div>
      <div class="card blue-card"><h2 id="total-semresposta">0</h2><p><i data-lucide="help-circle"></i> Sem resposta</p></div>
      <div class="card green-card"><h2 id="total-concluido">0</h2><p><i data-lucide="check-circle-2"></i> Concluídos</p></div>
      <div class="card red-card"><h2 id="total-cancelado">0</h2><p><i data-lucide="x-octagon"></i> Cancelados</p></div>
    </div>

    <div class="content">
      <div class="filters">
        <input id="filtro-cliente" type="text" placeholder="Buscar cliente..." />
        <select id="filtro-status">
          <option value="">Todos os status</option>
          <option value="Em andamento">Em andamento</option>
          <option value="__SemResposta__">Sem resposta</option>
          <option value="Concluído">Concluído</option>
          <option value="Cancelado">Cancelado</option>
        </select>
        <input id="filtro-consultor" type="text" placeholder="Buscar consultor..." />
        <input id="filtro-periodo" placeholder="Selecione o período" />
        <button id="btn-exportar" class="btn-acao" style="margin-left:auto;" title="Exportar para Excel">
          <i data-lucide="download" style="width: 20px; height: 20px;"></i>
        </button>
      </div>

      <div class="collections-bar">
        <span class="chip">Coleções:</span>
        <span id="collList" class="chip"></span>
        <input id="newColl" placeholder="Adicionar coleção (ex.: checklistServicos)" />
        <button id="addCollBtn">+ Adicionar</button>
        <span id="liveChip" class="chip">conectando…</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Departamento</th><th>Data da Visita</th><th>Cliente</th><th>Município</th><th>Consultor</th><th>Modelo</th><th>Horímetro</th><th>Telefone</th><th>Observações</th><th>Resposta do responsável</th><th>Checklist</th>
          </tr>
        </thead>
        <tbody id="painel-detalhes"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    // 1. Importa a função de guarda e as funções do Firebase
    import { garantirAutenticacao } from '/assets/js/auth-guard.js?v=2';
    import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Função principal assíncrona para iniciar a página
    async function iniciarPagina( ) {
      try {
        // 2. ESPERA a autenticação ser confirmada.
        await garantirAutenticacao();
        console.log("Autenticação confirmada. Iniciando o painel de gestão...");

        // 3. Agora que a autenticação passou, podemos configurar o Firebase e a página
        const app = getApp();
        const db = getFirestore(app);

        // --- O RESTO DO SEU CÓDIGO VAI AQUI DENTRO ---

        let collectionsToWatch = ["checklistComercial", "checklistPecas", "checklistServicos"];
        const saved = JSON.parse(localStorage.getItem("gestao_colecoes") || "null");
        if (Array.isArray(saved) && saved.length) collectionsToWatch = saved;

        const byCollection = new Map();
        let allRows = [];
        let unsubs = [];

        const low = v => String(v ?? "").toLowerCase().trim();
        function mapColecaoParaDepartamento(collName){
          const map = { checklistPecas: "Peças", checklistServicos: "Serviços", checklistComercial: "Comercial", campanhasAtivas: "Campanhas", informativos: "Informativos", planosVigentes: "Planos Vigentes" };
          return map[collName] || collName;
        }
        function getCliente(d){ return d.nomeCliente || d.cliente || d.nome || "-"; }
        function getMunicipio(d){ return d.municipio || d.cidade || "-"; }
        function getConsultor(d){ return d.consultor || d.responsavel || "-"; }
        function getModelo(d){ return d.modelo || d.equipamento || d.maquina || "-"; }
        function getHorimetro(d){ return d.horimetro ?? d.horímetro ?? "-"; }
        function getTelefone(d){ return d.telefone || d.celular || d.whatsapp || ""; }
        function getObs(d){ return d.observacoes || d.observação || d.descricao || d.notas || "-"; }
        function getResp(d){ return d.comentarioResponsavel || d.respostaResponsavel || "-"; }
        function getChecklistArr(d){ return Array.isArray(d.checklist) ? d.checklist : (Array.isArray(d.checklistItens) ? d.checklistItens : []); }
        function formatDate(any){
          if(!any) return "-";
          if(typeof any === "string") return any.slice(0,10);
          if(typeof any === "object" && any.seconds){ const dt = new Date(any.seconds*1000); return dt.toISOString().slice(0,10); }
          return String(any);
        }
        function getData(d){ return formatDate(d.dataVisita || d.data || d.createdAt || d.dt || d.timestamp); }
        function statusTag(d){
          const s = low(d.statusChecklist);
          if (s === "em andamento") return "andamento";
          if (s === "concluido" || s === "concluído") return "concluido";
          if (s === "cancelado") return "cancelado";
          if (!d.statusChecklist || String(d.statusChecklist).trim() === "") return "semresposta";
          return "outro";
        }

        const painel = document.getElementById("painel-detalhes");
        const collList = document.getElementById("collList");
        const newColl = document.getElementById("newColl");
        const addCollBtn = document.getElementById("addCollBtn");
        const liveChip = document.getElementById("liveChip");

        function renderCollectionsChip(){ collList.textContent = collectionsToWatch.join(", "); }

        function startWatch(filiaisPermitidas){
          unsubs.forEach(u => u && u());
          unsubs = [];
          byCollection.clear();
          allRows = [];
          painel.innerHTML = "";
          liveChip.textContent = "conectando…";
          renderCollectionsChip();

          collectionsToWatch.forEach(collName => {
            try{
              const unsub = onSnapshot(collection(db, collName), (snap) => {
                const rows = [];
                const filtrosAtivos = Array.isArray(filiaisPermitidas) && filiaisPermitidas.length > 0;
                snap.forEach(docu => {
                  const d = docu.data();
                  const filialDoc = low(d.filial || "");
                  if (filtrosAtivos && !filiaisPermitidas.includes(filialDoc)) return;
                  const tag = statusTag(d);
                  if (tag === "outro") return;
                  rows.push({ _id: `${collName}/${docu.id}`, collection: collName, departamento: mapColecaoParaDepartamento(collName), dataVisita: getData(d), cliente: getCliente(d), municipio: getMunicipio(d), consultor: getConsultor(d), modelo: getModelo(d), horimetro: getHorimetro(d), telefone: getTelefone(d), observacoes: getObs(d), resposta: getResp(d), checklist: getChecklistArr(d), statusTag: tag });
                });
                byCollection.set(collName, rows);
                rebuildAllRows();
                aplicarFiltros();
                liveChip.textContent = "ao vivo";
              }, (err)=>console.error("Snapshot error", collName, err));
              unsubs.push(unsub);
            }catch(e){ console.error("Erro inscrevendo em", collName, e); }
          });
        }

        function rebuildAllRows(){
          allRows = [];
          for (const arr of byCollection.values()) allRows = allRows.concat(arr);
          allRows.sort((a,b)=>{
            if (a.departamento !== b.departamento) return a.departamento.localeCompare(b.departamento);
            return (b.dataVisita||"").localeCompare(a.dataVisita||"");
          });
        }

        function aplicarFiltros(){
          const clienteFiltro = document.getElementById("filtro-cliente").value.toLowerCase();
          const statusFiltroRaw = document.getElementById("filtro-status").value;
          const consultorFiltro = document.getElementById("filtro-consultor").value.toLowerCase();
          const instance = document.getElementById("filtro-periodo")._flatpickr;
          const selectedDates = instance?.selectedDates || [];
          let dataInicio="", dataFim="";
          if (selectedDates.length === 2) { dataInicio = selectedDates[0].toISOString().slice(0,10); dataFim = selectedDates[1].toISOString().slice(0,10); }
          else if (selectedDates.length === 1) { dataInicio = dataFim = selectedDates[0].toISOString().slice(0,10); }

          const filtrados = allRows.filter(r=>{
            const dentroDoPeriodo = (!dataInicio && !dataFim) || ((!dataInicio || r.dataVisita >= dataInicio) && (!dataFim || r.dataVisita <= dataFim));
            const passaStatus = statusFiltroRaw === "" ? (["andamento","semresposta","concluido","cancelado"].includes(r.statusTag)) : statusFiltroRaw === "Em andamento" ? (r.statusTag === "andamento") : statusFiltroRaw === "__SemResposta__" ? (r.statusTag === "semresposta") : statusFiltroRaw === "Concluído" ? (r.statusTag === "concluido") : statusFiltroRaw === "Cancelado" ? (r.statusTag === "cancelado") : false;
            return r.cliente.toLowerCase().includes(clienteFiltro) && r.consultor.toLowerCase().includes(consultorFiltro) && dentroDoPeriodo && passaStatus;
          });

          document.getElementById("total-exibidos").textContent = filtrados.length;
          document.getElementById("total-andamento").textContent = filtrados.filter(r=>r.statusTag==="andamento").length;
          document.getElementById("total-semresposta").textContent = filtrados.filter(r=>r.statusTag==="semresposta").length;
          document.getElementById("total-concluido").textContent = filtrados.filter(r=>r.statusTag==="concluido").length;
          document.getElementById("total-cancelado").textContent = filtrados.filter(r=>r.statusTag==="cancelado").length;

          painel.innerHTML = "";
          filtrados.forEach(r=>{
            const statusClass = r.statusTag==="andamento" ? "status-em-andamento" : r.statusTag==="semresposta" ? "status-sem-resposta" : r.statusTag==="concluido" ? "status-concluido" : r.statusTag==="cancelado" ? "status-cancelado" : "";
            const whats = r.telefone ? `<a href="https://wa.me/55${String(r.telefone ).replace(/\D/g,'')}" target="_blank" title="Chamar no WhatsApp" style="color:#25D366; font-size:22px; display:inline-block;"><i class="fa-brands fa-whatsapp"></i></a>` : "-";
            painel.innerHTML += `<tr class="${statusClass}"><td>${r.departamento}</td><td>${r.dataVisita || "-"}</td><td>${r.cliente}</td><td>${r.municipio}</td><td>${r.consultor}</td><td>${r.modelo}</td><td>${r.horimetro}</td><td style="text-align:center;">${whats}</td><td>${r.observacoes}</td><td>${r.resposta}</td><td>${r.checklist.map(item => `<span style="background:#fff; color:#00205b; padding:3px 8px; border-radius:5px; margin:2px; display:inline-block; font-size:10px">${item}</span>`).join("")}</td></tr>`;
          });
        }

        function exportarParaExcel() {
          const headers = ["Departamento","Data da Visita","Cliente","Município","Consultor","Modelo","Horímetro","Telefone","Observações","Resposta do responsável","Checklist","Status"];
          const linhas = Array.from(document.querySelectorAll("#painel-detalhes tr")).map(tr=>{
            const tds = tr.querySelectorAll("td");
            const status = tr.classList.contains("status-em-andamento") ? "Em andamento" : tr.classList.contains("status-sem-resposta") ? "Sem resposta" : tr.classList.contains("status-concluido") ? "Concluído" : tr.classList.contains("status-cancelado") ? "Cancelado" : "";
            return [tds[0]?.textContent.trim(), tds[1]?.textContent.trim(), tds[2]?.textContent.trim(), tds[3]?.textContent.trim(), tds[4]?.textContent.trim(), tds[5]?.textContent.trim(), tds[6]?.textContent.trim(), tds[7]?.textContent.trim(), tds[8]?.textContent.trim(), tds[9]?.textContent.trim(), tds[10]?.innerText.trim(), status];
          });
          const planilha = XLSX.utils.aoa_to_sheet([headers, ...linhas]);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, planilha, "Gestão");
          XLSX.writeFile(wb, "gestao_multicolecoes_completa.xlsx");
        }

        // --- Configuração final da UI e início do monitoramento ---
        lucide.createIcons();
        const filiais = JSON.parse(localStorage.getItem("gestorFilial") || "[]").map(f => low(f));
        if (filiais.length) {
            document.getElementById("dynamic-title").textContent = `Filiais: ${JSON.parse(localStorage.getItem("gestorFilial")).join(", ")}`;
        } else {
            document.getElementById("dynamic-title").textContent = 'Visualizando todas as filiais';
        }
        
        document.getElementById("filtro-cliente").addEventListener("input", aplicarFiltros);
        document.getElementById("filtro-status").addEventListener("change", aplicarFiltros);
        document.getElementById("filtro-consultor").addEventListener("input", aplicarFiltros);
        flatpickr("#filtro-periodo",{ mode:"range", dateFormat:"Y-m-d", locale:"pt", onChange:aplicarFiltros });
        document.getElementById("btn-exportar").addEventListener("click", exportarParaExcel);
        renderCollectionsChip();
        document.getElementById("addCollBtn").addEventListener("click", ()=>{
          const name = (newColl.value || "").trim();
          if (!name) return;
          if (!collectionsToWatch.includes(name)) {
            collectionsToWatch.push(name);
            localStorage.setItem("gestao_colecoes", JSON.stringify(collectionsToWatch));
            newColl.value = "";
            startWatch(filiais);
          }
        });
        
        // Inicia o monitoramento com as filiais do gestor logado
        startWatch(filiais);
        setInterval(aplicarFiltros, 60000);

      } catch (error) {
        console.error("Falha na autenticação:", error);
      }
    }

    // Inicia todo o processo
    iniciarPagina();
  </script>
</body>
</html>
