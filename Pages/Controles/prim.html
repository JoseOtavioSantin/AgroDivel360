<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Controle de Peças PRIM</title>
  <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Biblioteca para leitura de arquivos Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* Estilos baseados no sistema principal */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #1e1e2f; color: white; display: flex; flex-direction: column; height: 100vh; }
    header { background-color: #2c2f3f; padding: 20px; text-align: center; font-size: 20px; font-weight: bold; color: #ffffff; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.2 ); /* MODIFICAÇÃO: Adicionado display flex para alinhar itens */ display: flex; align-items: center; justify-content: space-between; }
    #dynamic-title { margin-top: 10px; font-size: 16px; font-weight: normal; color: #ccc; }
    .main { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 250px; background-color: #2c2f3f; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
    .card { padding: 20px; border-radius: 16px; color: white; background: #d60019; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); text-align: left; display: flex; flex-direction: column; gap: 5px; }
    .card h2 { font-size: 28px; margin: 0; }
    .card p { font-size: 14px; color: #eee; margin: 0; display: flex; align-items: center; gap: 8px; }
    .content { flex: 1; padding: 30px; background-color: #262a3d; overflow-y: auto; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .filters input, .filters select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; min-width: 180px; height: 40px; background-color: #fff; color: #333; }
    table { width: 100%; border-collapse: collapse; background-color: #2c2f3f; border-radius: 12px; overflow: hidden; }
    th, td { font-size: 12px; padding: 10px 15px; text-align: left; border-bottom: 1px solid #444; vertical-align: middle; }
    th { background-color: #ffffff; color: #00205b; }
    .acoes-topo { margin-left: auto; display: flex; gap: 10px; }
    .btn-acao { background: linear-gradient(145deg, #d60019, #d60019); border: none; height: 40px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: filter 0.2s, transform 0.2s; padding: 0 15px; font-size: 12px; font-weight: bold; }
    .btn-acao i { margin-right: 8px; }
    .btn-acao:hover { filter: brightness(1.1); transform: scale(1.05); }
    .logo { height: 80px; margin-left: 45px; margin-right: 15px; }
    
    .status-aguardando { background-color: #c67903; }
    .status-concluido { background-color: #d60019; }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background-color: #2c2f3f; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
    .modal-header h3 { margin: 0; }
    .close-button { cursor: pointer; font-size: 28px; font-weight: bold; transition: color 0.2s; }
    .close-button:hover { color: #ff6b6b; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .form-grid label, .form-grid input, .form-grid select { width: 100%; }
    .form-grid label { margin-bottom: -10px; font-size: 12px; color: #ccc; }
    .form-grid input, .form-grid select { padding: 10px; border-radius: 6px; border: none; background-color: #262a3d; color: white; }
    .form-buttons { text-align: right; }
    .form-buttons button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .btn-save { background-color: #27ae60; color: white; }
    .btn-cancel { background-color: #7f8c8d; color: white; margin-left: 10px; }
    #loader-overlay { display: none; position: fixed; z-index: 9999; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); color: white; font-size: 20px; align-items: center; justify-content: center; font-weight: bold; }
    
    .btn-edit-row { background: none; border: none; color: white; cursor: pointer; padding: 5px; }
    .btn-edit-row:hover { color: #76daff; }

    td, input[type="text"], select { text-transform: uppercase; }
    select option { text-transform: uppercase; }

    @keyframes piscar {
      0%, 100% { background-color: #228b22; }
      50% { background-color: #c67903; }
    }
    .chegou-no-estoque {
      animation: piscar 1.5s infinite;
    }

    #toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 10001;
      visibility: hidden;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
      transform: translateX(0);
    }
    #toast.sucesso { background-color: #27ae60; }
    #toast.erro { background-color: #c0392b; }
    #toast.info { background-color: #2980b9; }

    /* NOVO ESTILO PARA O BOTÃO VOLTAR NO HEADER */
    .btn-voltar-header {
        background: linear-gradient(135deg, #00205b, #009bd6);
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-right: 20px; /* Ajusta a distância da borda direita */
        font-size: 14px;
        font-weight: bold;
    }

    .btn-voltar-header:hover {
        transform: scale(1.05);
    }
  </style>
</head>
<body>
  <!-- HEADER MODIFICADO -->
  <header>
    <img src="assets/logo.png" alt="Logo" class="logo">
    <div style="flex: 1; text-align: center;">
        <em>Dashboard Agro Divel 360</em>
        <div id="dynamic-title">Controle de Peças PRIM</div>
    </div>
    <button class="btn-voltar-header" title="Voltar" onclick="window.location.href='index.html'">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Voltar
    </button>
  </header>

  <div class="main">
    <div class="sidebar">
      <div class="card">
        <h2 id="total-pedidos">0</h2>
        <p><i data-lucide="package"></i> Total de Pedidos</p>
      </div>
      <div class="card">
        <h2 id="pedidos-aguardando">0</h2>
        <p><i data-lucide="loader-circle"></i> Aguardando Peça</p>
      </div>
      <div class="card">
        <h2 id="pedidos-concluidos">0</h2>
        <p><i data-lucide="check-circle"></i> Pedido Concluído</p>
      </div>
      <!-- BOTÃO VOLTAR FOI REMOVIDO DAQUI -->
    </div>

    <div class="content">
      <div id="loader-overlay"><div style="margin: auto;">Carregando...</div></div>

      <div class="filters">
        <input id="filtro-codigo" type="text" placeholder="Buscar Código..." />
        <input id="filtro-pedido-para" type="text" placeholder="Buscar Cidade..." />
        
        <div class="acoes-topo">
          <button class="btn-acao" id="btn-importar-excel" title="Importar Pedidos via Excel">
            <i data-lucide="file-spreadsheet"></i> Importar Excel
          </button>
          <input type="file" id="excel-uploader" accept=".xlsx,.xls" style="display: none;">

          <button class="btn-acao" id="btn-add-pedido" title="Adicionar Novo Pedido">
            <i data-lucide="plus"></i> Adicionar
          </button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Qtd.</th>
            <th>Cidade</th>
            <th>Status</th>
            <th>Fornecedor</th>
            <th>Data</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabela-pedidos"></tbody>
      </table>
    </div>
  </div>

  <div id="pedido-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Adicionar Novo Pedido</h3>
        <span class="close-button">&times;</span>
      </div>
      <input type="hidden" id="form-pedido-id">
      <div class="form-grid">
        <div><label for="form-codigo">Código</label><input type="text" id="form-codigo" placeholder="Código da Peça"></div>
        <div><label for="form-quantidade">Quantidade</label><input type="number" id="form-quantidade" value="1" min="1"></div>
        <div><label for="form-pedido-para">Cidade</label><input type="text" id="form-pedido-para" placeholder="Nome da Cidade"></div>
        <div><label for="form-status">Status</label><select id="form-status"><option value="Aguardando Peça">Aguardando Peça</option><option value="Pedido Concluído">Pedido Concluído</option></select></div>
        <div><label for="form-data">Data</label><input type="date" id="form-data"></div>
        <div style="grid-column: span 2;"><label>Fornecedor: PRIM (fixo)</label></div>
      </div>
      <div class="form-buttons">
        <button class="btn-cancel">Cancelar</button>
        <button class="btn-save">Salvar</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


  const firebaseConfig = {
    apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
    authDomain: "agro-divel.firebaseapp.com",
    projectId: "agro-divel"
  };

  const app = initializeApp(firebaseConfig );
  const db = getFirestore(app);
  const pedidosCollection = collection(db, "pedidosPrim");
  const importacoesCollection = collection(db, "importacoesPrim");

  document.addEventListener("DOMContentLoaded", () => {
    const tabelaBody = document.getElementById('tabela-pedidos');
    const loaderOverlay = document.getElementById('loader-overlay');
    const pedidoModal = document.getElementById('pedido-modal');
    const modalTitle = document.getElementById('modal-title');
    const btnAddPedido = document.getElementById('btn-add-pedido');
    const closeModalButton = pedidoModal.querySelector('.close-button');
    const btnCancel = pedidoModal.querySelector('.btn-cancel');
    const btnSave = pedidoModal.querySelector('.btn-save');
    const formPedidoId = document.getElementById('form-pedido-id');
    const btnImportarExcel = document.getElementById('btn-importar-excel');
    const excelUploader = document.getElementById('excel-uploader');
    const filtroCodigo = document.getElementById('filtro-codigo');
    const filtroPedidoPara = document.getElementById('filtro-pedido-para');
    const toast = document.getElementById('toast');

    let dadosCompletos = [];
    let dadosFiltrados = [];
    let toastTimeout;

    function showToast(message, type = 'info') {
      clearTimeout(toastTimeout);
      toast.textContent = message;
      toast.className = '';
      toast.classList.add(type);
      toast.classList.add('show');
      toastTimeout = setTimeout(() => {
        toast.classList.remove('show');
      }, 5000);
    }

    async function carregarDadosDoFirebase() {
        loaderOverlay.style.display = 'flex';
        const querySnapshot = await getDocs(pedidosCollection);
        dadosCompletos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        aplicarFiltros();
        loaderOverlay.style.display = 'none';
    }

    function aplicarFiltros() {
      const codigoFiltro = filtroCodigo.value.toUpperCase();
      const pedidoParaFiltro = filtroPedidoPara.value.toUpperCase();

      dadosFiltrados = dadosCompletos.filter(pedido => 
        (pedido.codigo || '').toUpperCase().includes(codigoFiltro) &&
        (pedido.pedidoPara || '').toUpperCase().includes(pedidoParaFiltro)
      );

      dadosFiltrados.sort((a, b) => {
        if (a.chegouEstoque && !b.chegouEstoque) return -1;
        if (!a.chegouEstoque && b.chegouEstoque) return 1;
        return new Date(b.data) - new Date(a.data);
      });

      renderizarTabela();
      atualizarCards();
    }

    function renderizarTabela() {
      tabelaBody.innerHTML = '';
      dadosFiltrados.forEach(pedido => {
        const tr = document.createElement('tr');
        tr.dataset.id = pedido.id;
        
        if (pedido.status === 'AGUARDANDO PEÇA') {
            if (pedido.chegouEstoque) {
                tr.classList.add('chegou-no-estoque');
            } else {
                tr.classList.add('status-aguardando');
            }
        } else if (pedido.status === 'PEDIDO CONCLUÍDO') {
            tr.classList.add('status-concluido');
        }
        
        tr.innerHTML = `
          <td>${pedido.codigo || ''}</td>
          <td>${pedido.quantidade || ''}</td>
          <td>${pedido.pedidoPara || ''}</td>
          <td>${pedido.status || ''}</td>
          <td>PRIM</td>
          <td>${formatarData(pedido.data)}</td>
          <td>
            <button class="btn-edit-row" title="Editar Pedido">
              <i data-lucide="pencil" style="width:16px; height:16px;"></i>
            </button>
          </td>
        `;
        tabelaBody.appendChild(tr);
      });
      adicionarEventosTabela();
      lucide.createIcons();
    }

    function adicionarEventosTabela() {
        tabelaBody.querySelectorAll('.btn-edit-row').forEach(button => {
            button.addEventListener('click', (e) => {
                const row = e.currentTarget.closest('tr');
                const pedidoId = row.dataset.id;
                const pedido = dadosCompletos.find(p => p.id === pedidoId);
                abrirModalParaEdicao(pedido);
            });
        });
    }

    function atualizarCards() {
        const total = dadosFiltrados.length;
        const aguardando = dadosFiltrados.filter(k => k.status === 'AGUARDANDO PEÇA').length;
        const concluidos = total - aguardando;
        document.getElementById('total-pedidos').textContent = total;
        document.getElementById('pedidos-aguardando').textContent = aguardando;
        document.getElementById('pedidos-concluidos').textContent = concluidos;
    }

    function formatarData(dataString) {
        if (!dataString || !dataString.includes('-')) {
            return 'DATA INVÁLIDA';
        }
        const [ano, mes, dia] = dataString.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    function abrirModalParaAdicionar() {
        formPedidoId.value = '';
        modalTitle.textContent = 'Adicionar Novo Pedido';
        document.getElementById('form-data').valueAsDate = new Date();
        document.getElementById('form-codigo').value = '';
        document.getElementById('form-quantidade').value = '1';
        document.getElementById('form-pedido-para').value = '';
        document.getElementById('form-status').value = 'Aguardando Peça';
        pedidoModal.style.display = 'flex';
    }

    function abrirModalParaEdicao(pedido) {
        formPedidoId.value = pedido.id;
        modalTitle.textContent = 'Editar Pedido';
        document.getElementById('form-data').value = pedido.data || '';
        document.getElementById('form-codigo').value = pedido.codigo || '';
        document.getElementById('form-quantidade').value = pedido.quantidade || '1';
        document.getElementById('form-pedido-para').value = pedido.pedidoPara || '';
        document.getElementById('form-status').value = pedido.status.replace('PEDIDO CONCLUÍDO', 'Pedido Concluído').replace('AGUARDANDO PEÇA', 'Aguardando Peça');
        pedidoModal.style.display = 'flex';
    }

    function fecharModal() {
        pedidoModal.style.display = 'none';
    }

    async function salvarPedido() {
        const id = formPedidoId.value;
        const statusForm = document.getElementById('form-status').value.toUpperCase();
        const pedidoOriginal = id ? dadosCompletos.find(p => p.id === id) : null;

        const dadosDoPedido = {
            codigo: document.getElementById('form-codigo').value.trim().toUpperCase(),
            quantidade: parseInt(document.getElementById('form-quantidade').value, 10),
            pedidoPara: document.getElementById('form-pedido-para').value.trim().toUpperCase(),
            status: statusForm,
            fornecedor: 'PRIM',
            data: document.getElementById('form-data').value,
            chegouEstoque: statusForm === 'PEDIDO CONCLUÍDO' ? false : (pedidoOriginal ? pedidoOriginal.chegouEstoque : false)
        };

        if (statusForm === 'PEDIDO CONCLUÍDO' && (!pedidoOriginal || !pedidoOriginal.dataRecebimento)) {
            dadosDoPedido.dataRecebimento = new Date().toISOString().split('T')[0];
        } else if (pedidoOriginal && pedidoOriginal.dataRecebimento) {
            dadosDoPedido.dataRecebimento = pedidoOriginal.dataRecebimento;
        }

        if (!dadosDoPedido.data || !dadosDoPedido.codigo) {
            showToast("Os campos 'Data' e 'Código' são obrigatórios.", 'erro');
            return;
        }

        if (id) {
            await updateDoc(doc(db, "pedidosPrim", id), dadosDoPedido);
        } else {
            await addDoc(pedidosCollection, dadosDoPedido);
        }
        
        fecharModal();
        showToast('Pedido salvo com sucesso!', 'sucesso');
        await carregarDadosDoFirebase();
    }

    async function processarExcel(file) {
        loaderOverlay.style.display = 'flex';
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                
                let dataRelatorio = null;
                for (let i = 0; i < 20; i++) {
                    if (!jsonData[i]) continue;
                    const row = jsonData[i];
                    const cellIndex = row.findIndex(cell => typeof cell === 'string' && cell.includes('Data do Relatório'));
                    
                    if (cellIndex !== -1) {
                        const valorData = row[cellIndex + 1];
                        if (valorData instanceof Date) {
                            const ano = valorData.getFullYear();
                            const mes = String(valorData.getMonth() + 1).padStart(2, '0');
                            const dia = String(valorData.getDate()).padStart(2, '0');
                            dataRelatorio = `${ano}-${mes}-${dia}`;
                        } else if (typeof valorData === 'string') {
                            const partes = valorData.split('/');
                            if (partes.length === 3) {
                                dataRelatorio = `${partes[2]}-${partes[1]}-${partes[0]}`;
                            }
                        }
                        break; 
                    }
                }

                if (!dataRelatorio) {
                    showToast('Não foi possível encontrar ou formatar a "Data do Relatório" no arquivo.', 'erro');
                    loaderOverlay.style.display = 'none';
                    return;
                }

                const docIdData = dataRelatorio;
                const docRefVerificacao = doc(importacoesCollection, docIdData);
                const docSnap = await getDoc(docRefVerificacao);

                if (docSnap.exists()) {
                    showToast(`O relatório do dia ${dataRelatorio.split('-').reverse().join('/')} já foi importado.`, 'erro');
                    loaderOverlay.style.display = 'none';
                    return;
                }

                let headerRowIndex = -1;
                for (let i = 0; i < jsonData.length; i++) {
                    if (jsonData[i] && jsonData[i].includes('Código da Peça')) {
                        headerRowIndex = i;
                        break;
                    }
                }

                if (headerRowIndex === -1) {
                    showToast('Cabeçalho "Código da Peça" não encontrado.', 'erro');
                    loaderOverlay.style.display = 'none';
                    return;
                }

                const headers = jsonData[headerRowIndex];
                const codigoIndex = headers.indexOf('Código da Peça');
                const quantidadeIndex = headers.indexOf('Quantidade Modificada');
                const cidadeIndex = headers.indexOf('Cidade');

                if (codigoIndex === -1 || quantidadeIndex === -1 || cidadeIndex === -1) {
                    showToast('Colunas necessárias não encontradas no Excel.', 'erro');
                    loaderOverlay.style.display = 'none';
                    return;
                }

                const batch = writeBatch(db);
                let pedidosImportados = 0;

                for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;

                    const codigo = row[codigoIndex];
                    const quantidade = row[quantidadeIndex];
                    const cidade = row[cidadeIndex];

                    if (codigo && quantidade && Number(quantidade) > 0 && cidade) {
                        const novoPedido = {
                            codigo: String(codigo).trim().toUpperCase(),
                            quantidade: parseInt(quantidade, 10),
                            pedidoPara: String(cidade).trim().toUpperCase(),
                            status: 'AGUARDANDO PEÇA',
                            fornecedor: 'PRIM',
                            data: dataRelatorio,
                            chegouEstoque: false
                        };
                        const novoDocRef = doc(pedidosCollection);
                        batch.set(novoDocRef, novoPedido);
                        pedidosImportados++;
                    }
                }

                if (pedidosImportados > 0) {
                    const docRefRegistro = doc(importacoesCollection, docIdData);
                    batch.set(docRefRegistro, { importadoEm: new Date(), nomeArquivo: file.name });

                    await batch.commit();
                    showToast(`${pedidosImportados} pedidos do relatório de ${dataRelatorio.split('-').reverse().join('/')} importados!`, 'sucesso');
                    await carregarDadosDoFirebase();
                } else {
                    showToast('Nenhum pedido válido encontrado no arquivo Excel.', 'info');
                }

            } catch (error) {
                console.error("Erro ao processar Excel:", error);
                showToast("Erro crítico ao processar o arquivo Excel. Verifique o console.", 'erro');
            } finally {
                loaderOverlay.style.display = 'none';
            }
        };
        
        reader.onerror = () => {
            showToast("Erro ao ler o arquivo Excel.", 'erro');
            loaderOverlay.style.display = 'none';
        };
        
        reader.readAsArrayBuffer(file);
    }

    // --- EVENTOS ---
    btnAddPedido.addEventListener('click', abrirModalParaAdicionar);
    closeModalButton.addEventListener('click', fecharModal);
    btnCancel.addEventListener('click', fecharModal);
    btnSave.addEventListener('click', salvarPedido);
    window.addEventListener('click', (e) => { if (e.target == pedidoModal) fecharModal(); });

    filtroCodigo.addEventListener('input', aplicarFiltros);
    filtroPedidoPara.addEventListener('input', aplicarFiltros);

    btnImportarExcel.addEventListener('click', () => { excelUploader.click(); });
    excelUploader.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        processarExcel(file);
      }
      event.target.value = null; 
    });

    carregarDadosDoFirebase();
  });
</script>

</body>
</html>
