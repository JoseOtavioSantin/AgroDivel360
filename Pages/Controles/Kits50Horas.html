<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Controle de Kits 50 Horas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ... Estilos anteriores ... */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #1e1e2f; color: white; display: flex; flex-direction: column; height: 100vh; }
    header { background-color: #2c2f3f; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2  ); display: flex; align-items: center; justify-content: space-between; }
    .logo { height: 80px; margin-left: 45px; margin-right: 15px; }
    .header-center { flex: 1; text-align: center; font-size: 20px; font-weight: bold; color: #ffffff; letter-spacing: 1px; }
    #dynamic-title { margin-top: 10px; font-size: 16px; font-weight: normal; color: #ccc; font-style: italic; }
    .btn-voltar { background: linear-gradient(135deg, #00205b, #009bd6); border: none; padding: 10px 16px; border-radius: 8px; color: white; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 8px; margin-right: 20px; font-size: 14px; }
    .btn-voltar:hover { transform: scale(1.05); }
    .main { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 250px; background-color: #2c2f3f; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
    .card { padding: 20px; border-radius: 16px; color: white; background: linear-gradient(145deg, #3a3d5e, #2c2f4f); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); text-align: left; display: flex; flex-direction: column; gap: 5px; }
    .card h2 { font-size: 28px; margin: 0; }
    .card p { font-size: 14px; color: #ccc; margin: 0; display: flex; align-items: center; gap: 8px; }
    .content { flex: 1; padding: 30px; background-color: #262a3d; overflow-y: auto; }
    .filters-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; }
    .filters input, .filters select { padding: 8px; border-radius: 6px; border: none; min-width: 180px; height: 40px; background-color: #fff; color: #333; }
    .acoes-topo { margin-left: auto; display: flex; gap: 10px; }
    .btn-acao-topo { background: linear-gradient(135deg, #00205b, #009bd6); border: none; width: 40px; height: 40px; border-radius: 8px; color: white; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
    .btn-acao-topo:hover { transform: scale(1.05); }
    table { width: 100%; border-collapse: collapse; background-color: #2c2f3f; border-radius: 12px; overflow: hidden; }
    th, td { font-size: 12px; padding: 12px 15px; text-align: left; border-bottom: 1px solid #444; }
    th { background-color: #ffffff; color: #00205b; }
    
    /* NOVO: Estilo para a célula de ações */
    td.acoes-cell { display: flex; align-items: center; gap: 8px; }

    /* NOVO: Estilos para os botões de ação na linha */
    .btn-row-action { background: transparent; border: none; width: 32px; height: 32px; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .btn-edit { background-color: #f39c12; } /* Laranja */
    .btn-edit:hover { background-color: #e67e22; }
    .btn-save-row { background-color: #27ae60; } /* Verde */
    .btn-save-row:hover { background-color: #229954; }
    .btn-print { background-color: #3498db; } /* Azul */
    .btn-print:hover { background-color: #2980b9; }

    /* NOVO: Estilo para células em modo de edição */
    td[contenteditable="true"] { background-color: #4a4e6d; outline: 2px solid #009bd6; }

    .status-select { background-color: transparent; color: white; border: none; border-radius: 4px; padding: 4px 6px; font-weight: bold; cursor: pointer; width: 100%; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .status-select:disabled { opacity: 0.7; cursor: not-allowed; }
    .status-select option { background-color: #2c2f3f; color: white; }
    .status-em-andamento { background-color: #c67903; }
    .status-concluido { background-color: #193b7c; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background-color: #2c2f3f; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
    .modal-header h3 { margin: 0; }
    .close-button { cursor: pointer; font-size: 28px; font-weight: bold; transition: color 0.2s; }
    .close-button:hover { color: #ff6b6b; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .form-grid label { display: block; margin-bottom: 5px; font-size: 14px; }
    .form-grid input, .form-grid select { width: 100%; padding: 10px; border-radius: 6px; border: none; }
    .form-buttons { text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
    .btn-acao { border: none; padding: 10px 20px; border-radius: 8px; color: white; font-size: 14px; cursor: pointer; transition: transform 0.2s; }
    .btn-concluir { background: #1e8a4a; }
    .btn-cancelar { background: #c72c41; }
    #loader-overlay { display: none; position: fixed; z-index: 9999; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); color: white; font-size: 20px; align-items: center; justify-content: center; font-weight: bold; }
  </style>
</head>
<body>
  <header>
    <img src="/assets/images/logo.png" alt="Logo" class="logo">
    <div class="header-center">
        <em>Controle de Kits 50 Horas</em>
        <div id="dynamic-title">Aguardando autenticação...</div>
    </div>
    <button class="btn-voltar" title="Voltar" onclick="window.history.back()">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Voltar
    </button>
  </header>

  <div class="main">
    <div class="sidebar">
      <div class="card"><h2 id="total-kits">0</h2><p><i data-lucide="package"></i> Total de Kits</p></div>
      <div class="card"><h2 id="kits-andamento">0</h2><p><i data-lucide="loader-circle"></i> Em Andamento</p></div>
      <div class="card"><h2 id="kits-concluidos">0</h2><p><i data-lucide="check-circle"></i> Concluídos</p></div>
    </div>

    <div class="content">
      <div id="loader-overlay"><div style="margin: auto;">Carregando...</div></div>
      <div class="filters-container">
        <div class="filters">
            <input id="filtro-chassi" type="text" placeholder="Buscar por chassi..." />
            <input id="filtro-modelo" type="text" placeholder="Buscar por modelo..." />
            <input id="filtro-descricao" type="text" placeholder="Buscar por descrição..." />
        </div>
        <div class="acoes-topo">
          <button class="btn-acao-topo" id="btn-add-kit" title="Adicionar Novo Kit">
            <i data-lucide="plus"></i>
          </button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Data da Entrega</th><th>Chassi</th><th>Modelo</th><th>Descrição</th><th>OS</th><th>Quem Entregou</th><th>Quem Retirou</th><th>Status</th><th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabela-kits"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de Adicionar Kit (sem alterações) -->
  <div id="kit-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Adicionar Novo Kit</h3>
        <span class="close-button" onclick="fecharModal()">&times;</span>
      </div>
      <div class="form-grid">
        <div><label for="form-data-entrega">Data da Entrega</label><input type="date" id="form-data-entrega"></div>
        <div><label for="form-chassi">Chassi</label><input type="text" id="form-chassi" placeholder="Nº do Chassi"></div>
        <div><label for="form-modelo">Modelo</label><input type="text" id="form-modelo" placeholder="Modelo do Veículo"></div>
        <div><label for="form-descricao">Descrição</label><input type="text" id="form-descricao" placeholder="Ex: Kit 50h, Filtro..."></div>
        <div><label for="form-os">OS</label><input type="text" id="form-os" placeholder="Nº da Ordem de Serviço"></div>
        <div><label for="form-quem-entregou">Quem Entregou</label><input type="text" id="form-quem-entregou" placeholder="Nome do funcionário"></div>
        <div><label for="form-quem-pegou">Quem Retirou</label><input type="text" id="form-quem-pegou" placeholder="Nome do cliente/responsável"></div>
        <div><label for="form-status">Status</label><select id="form-status"><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></div>
      </div>
      <div class="form-buttons">
        <button class="btn-acao btn-cancelar" onclick="fecharModal()">Cancelar</button>
        <button class="btn-acao btn-concluir" id="btn-save">Salvar</button>
      </div>
    </div>
  </div>

<script type="module">
  import { garantirAutenticacao } from '/assets/js/auth-guard.js';
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const { jsPDF } = window.jspdf;

  async function iniciarPagina( ) {
    try {
      await garantirAutenticacao();
      const app = getApp();
      const db = getFirestore(app);
      const kitsCollection = collection(db, "kits50Horas");

      // NOVO: Pega os grupos do usuário do localStorage
      const userGroups = JSON.parse(localStorage.getItem("userGroups") || "[]");
      const podeEditar = userGroups.includes("pecas");

      let logoBase64 = null;
      async function carregarLogoParaPDF() { /* ...código do logo sem alterações... */ }
      await carregarLogoParaPDF();
      lucide.createIcons();

      const tabelaBody = document.getElementById('tabela-kits');
      const loaderOverlay = document.getElementById('loader-overlay');
      const kitModal = document.getElementById('kit-modal');
      const btnAddKit = document.getElementById('btn-add-kit');
      const btnSave = document.getElementById('btn-save');
      let dadosCompletos = [], dadosFiltrados = [];
      const filtroChassi = document.getElementById('filtro-chassi');
      const filtroModelo = document.getElementById('filtro-modelo');
      const filtroDescricao = document.getElementById('filtro-descricao');

      async function carregarDadosDoFirebase() {
          loaderOverlay.style.display = 'flex';
          try {
              const filiaisLogadas = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
              if (filiaisLogadas.length === 0) throw new Error("Nenhuma filial associada.");
              document.getElementById('dynamic-title').textContent = `Filial: ${filiaisLogadas.join(", ")}`;
              const q = query(kitsCollection, orderBy("dataEntrega", "desc"));
              const querySnapshot = await getDocs(q);
              const todosOsKits = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              dadosCompletos = todosOsKits.filter(kit => {
                  const filialDoKit = (kit.filial || "").toLowerCase().trim();
                  return filiaisLogadas.some(f => f.toLowerCase().trim() === filialDoKit);
              });
              aplicarFiltros();
          } catch (error) {
              console.error("Erro ao carregar dados:", error);
              loaderOverlay.innerHTML = `<div style="margin: auto;">Erro ao carregar.</div>`;
          } finally {
              loaderOverlay.style.display = 'none';
          }
      }

      function aplicarFiltros() {
        const chassiFiltro = filtroChassi.value.toLowerCase();
        const modeloFiltro = filtroModelo.value.toLowerCase();
        const descricaoFiltro = filtroDescricao.value.toLowerCase();
        dadosFiltrados = dadosCompletos.filter(kit => 
          (kit.chassi || '').toLowerCase().includes(chassiFiltro) &&
          (kit.modelo || '').toLowerCase().includes(modeloFiltro) &&
          (kit.descricao || '').toLowerCase().includes(descricaoFiltro)
        );
        dadosFiltrados.sort((a, b) => (a.status !== b.status) ? (a.status === 'Em Andamento' ? -1 : 1) : 0);
        renderizarTabela();
        atualizarCards();
      }

      // FUNÇÃO RENDERIZAR TABELA ATUALIZADA
      function renderizarTabela() {
        tabelaBody.innerHTML = '';
        if (dadosFiltrados.length === 0) {
            tabelaBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhum registro encontrado.</td></tr>';
            return;
        }
        dadosFiltrados.forEach(kit => {
          const tr = document.createElement('tr');
          tr.dataset.id = kit.id;
          tr.className = kit.status === 'Em Andamento' ? 'status-em-andamento' : 'status-concluido';
          
          // Gera o botão de edição apenas se o usuário tiver permissão
          const editButtonHTML = podeEditar 
            ? `<button class="btn-row-action btn-edit" title="Editar"><i data-lucide="pencil" style="width: 16px;"></i></button>` 
            : '';

          // Células não são mais 'contenteditable' por padrão
          tr.innerHTML = `
            <td data-field="dataEntrega">${formatarData(kit.dataEntrega)}</td>
            <td data-field="chassi">${kit.chassi || ''}</td>
            <td data-field="modelo">${kit.modelo || ''}</td>
            <td data-field="descricao">${kit.descricao || ''}</td>
            <td data-field="os">${kit.os || ''}</td>
            <td data-field="quemEntregou">${kit.quemEntregou || ''}</td>
            <td data-field="quemPegou">${kit.quemPegou || ''}</td>
            <td>
                <select class="status-select" data-field="status" ${!podeEditar ? 'disabled' : ''}>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Concluído">Concluído</option>
                </select>
            </td>
            <td class="acoes-cell">
                ${editButtonHTML}
                <button class="btn-row-action btn-print" title="Gerar PDF"><i data-lucide="printer" style="width: 16px;"></i></button>
            </td>
          `;
          tabelaBody.appendChild(tr);
          tr.querySelector('select[data-field="status"]').value = kit.status;
        });
        lucide.createIcons();
        adicionarEventosTabela();
      }

      function gerarPDF(kit) { /* ...código do PDF sem alterações... */ }

      // FUNÇÃO DE EVENTOS ATUALIZADA
      function adicionarEventosTabela() {
          tabelaBody.querySelectorAll('tr').forEach(row => {
              const id = row.dataset.id;
              if (!id) return;

              // Evento para o botão de Editar/Salvar
              const editButton = row.querySelector('.btn-edit');
              if (editButton) {
                  editButton.addEventListener('click', () => toggleEditMode(row, id));
              }

              // Evento para o botão de Imprimir
              row.querySelector('.btn-print').addEventListener('click', () => {
                  const kitData = dadosFiltrados.find(k => k.id === id);
                  if (kitData) gerarPDF(kitData);
              });

              // Evento para o select de status (se o usuário puder editar)
              const statusSelect = row.querySelector('.status-select');
              if (!statusSelect.disabled) {
                  statusSelect.addEventListener('change', async (e) => {
                      await atualizarDocumento(id, { status: e.target.value });
                      aplicarFiltros(); // Re-renderiza para ordenar e atualizar cores
                  });
              }
          });
      }

      // NOVA FUNÇÃO: GERENCIA O MODO DE EDIÇÃO
      async function toggleEditMode(row, id) {
          const isEditing = row.classList.contains('editing');
          const editButton = row.querySelector('.btn-row-action');
          const cellsToEdit = row.querySelectorAll('td[data-field]:not([data-field="dataEntrega"])');

          if (isEditing) { // SALVAR ALTERAÇÕES
              const dataToUpdate = {};
              cellsToEdit.forEach(cell => {
                  dataToUpdate[cell.dataset.field] = cell.textContent.trim();
                  cell.contentEditable = 'false';
              });

              await atualizarDocumento(id, dataToUpdate);

              row.classList.remove('editing');
              editButton.classList.remove('btn-save-row');
              editButton.classList.add('btn-edit');
              editButton.title = 'Editar';
              editButton.innerHTML = '<i data-lucide="pencil" style="width: 16px;"></i>';
              lucide.createIcons();

          } else { // ENTRAR NO MODO DE EDIÇÃO
              cellsToEdit.forEach(cell => {
                  cell.contentEditable = 'true';
              });
              row.classList.add('editing');
              editButton.classList.remove('btn-edit');
              editButton.classList.add('btn-save-row');
              editButton.title = 'Salvar';
              editButton.innerHTML = '<i data-lucide="save" style="width: 16px;"></i>';
              lucide.createIcons();
              // Foca na primeira célula editável
              cellsToEdit[0].focus();
          }
      }

      async function atualizarDocumento(id, data) {
          await updateDoc(doc(db, "kits50Horas", id), data);
      }

      function atualizarCards() { /* ...sem alterações... */ }
      function formatarData(dataString) { /* ...sem alterações... */ }
      window.abrirModal = () => { /* ...sem alterações... */ }
      window.fecharModal = () => { /* ...sem alterações... */ }
      async function salvarKit() { /* ...sem alterações... */ }

      // Listeners
      btnAddKit.addEventListener('click', abrirModal);
      btnSave.addEventListener('click', salvarKit);
      window.addEventListener('click', (e) => { if (e.target == kitModal) fecharModal(); });
      filtroChassi.addEventListener('input', aplicarFiltros);
      filtroModelo.addEventListener('input', aplicarFiltros);
      filtroDescricao.addEventListener('input', aplicarFiltros);

      carregarDadosDoFirebase();

    } catch (error) {
      console.error("Falha na inicialização da página:", error);
    }
  }

  iniciarPagina();
</script>

</body>
</html>
