<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Controle de Kits 50 Horas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Seus estilos permanecem os mesmos */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #1e1e2f; color: white; display: flex; flex-direction: column; height: 100vh; }
    header { background-color: #2c2f3f; padding: 20px; text-align: center; font-size: 20px; font-weight: bold; color: #ffffff; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.2 ); }
    #dynamic-title { margin-top: 10px; font-size: 16px; font-weight: normal; color: #ccc; }
    .main { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 250px; background-color: #2c2f3f; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
    .card { padding: 20px; border-radius: 16px; color: white; background: #193b7c; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); text-align: left; display: flex; flex-direction: column; gap: 5px; }
    .card h2 { font-size: 28px; margin: 0; }
    .card p { font-size: 14px; color: #eee; margin: 0; display: flex; align-items: center; gap: 8px; }
    .content { flex: 1; padding: 30px; background-color: #262a3d; overflow-y: auto; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .filters input, .filters select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; min-width: 180px; height: 40px; background-color: #fff; color: #333; }
    table { width: 100%; border-collapse: collapse; background-color: #2c2f3f; border-radius: 12px; overflow: hidden; }
    th, td { font-size: 12px; padding: 10px 15px; text-align: left; border-bottom: 1px solid #444; vertical-align: middle; }
    th { background-color: #ffffff; color: #00205b; }
    .acoes-topo { margin-left: auto; display: flex; gap: 10px; }
    .btn-acao { background: linear-gradient(145deg, #005c97, #363795); border: none; width: 40px; height: 40px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: filter 0.2s, transform 0.2s; }
    .btn-acao:hover { filter: brightness(1.1); transform: scale(1.05); }
    .logo { height: 80px; margin-left: 45px; margin-right: 15px; }
    .status-select { background-color: transparent; color: white; border: none; border-radius: 4px; padding: 4px 6px; font-weight: bold; cursor: pointer; width: 100%; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .status-select option { background-color: #2c2f3f; color: white; }
    .status-em-andamento { background-color: #c67903; }
    .status-concluido { background-color: #193b7c; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background-color: #2c2f3f; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
    .modal-header h3 { margin: 0; }
    .close-button { cursor: pointer; font-size: 28px; font-weight: bold; transition: color 0.2s; }
    .close-button:hover { color: #ff6b6b; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .form-grid label, .form-grid input, .form-grid select { width: 100%; }
    .form-grid label { margin-bottom: -10px; font-size: 12px; color: #ccc; }
    .form-grid input, .form-grid select { padding: 10px; border-radius: 6px; border: none; background-color: #262a3d; color: white; }
    .form-buttons { text-align: right; }
    .form-buttons button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .btn-save { background-color: #27ae60; color: white; }
    .btn-cancel { background-color: #7f8c8d; color: white; margin-left: 10px; }
    #loader-overlay { display: none; position: fixed; z-index: 9999; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); color: white; font-size: 20px; align-items: center; justify-content: center; font-weight: bold; }
    .btn-print { background: #007bff; border: none; width: 32px; height: 32px; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .btn-print:hover { background: #0056b3; }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <img src="/assets/images/logo.png" alt="Logo" class="logo">
      <div style="flex: 1; text-align: center;">
        <em>Dashboard Agro Divel 360</em>
        <div id="dynamic-title">Controle de Kits 50 Horas</div>
      </div>
      <div style="width: 65px;"></div>
    </div>
  </header>

  <div class="main">
    <div class="sidebar">
      <div class="card">
        <h2 id="total-kits">0</h2>
        <p><i data-lucide="package"></i> Total de Kits</p>
      </div>
      <div class="card">
        <h2 id="kits-andamento">0</h2>
        <p><i data-lucide="loader-circle"></i> Em Andamento</p>
      </div>
      <div class="card">
        <h2 id="kits-concluidos">0</h2>
        <p><i data-lucide="check-circle"></i> Concluídos</p>
      </div>
    </div>

    <div class="content">
      <div id="loader-overlay"><div style="margin: auto;">Carregando...</div></div>
      <div class="filters">
        <input id="filtro-chassi" type="text" placeholder="Buscar chassi..." />
        <input id="filtro-modelo" type="text" placeholder="Buscar modelo..." />
        <input id="filtro-descricao" type="text" placeholder="Buscar descrição..." />
        <div class="acoes-topo">
          <button class="btn-acao" id="btn-add-kit" title="Adicionar Novo Kit">
            <i data-lucide="plus"></i>
          </button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Data da Entrega</th>
            <th>Chassi</th>
            <th>Modelo</th>
            <th>Descrição</th>
            <th>OS</th>
            <th>Quem Entregou</th>
            <th>Quem Retirou</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabela-kits"></tbody>
      </table>
    </div>
  </div>

  <div id="kit-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Adicionar Novo Kit</h3>
        <span class="close-button">&times;</span>
      </div>
      <div class="form-grid">
        <div><label for="form-data-entrega">Data da Entrega</label><input type="date" id="form-data-entrega"></div>
        <div><label for="form-chassi">Chassi</label><input type="text" id="form-chassi" placeholder="Nº do Chassi"></div>
        <div><label for="form-modelo">Modelo</label><input type="text" id="form-modelo" placeholder="Modelo do Veículo"></div>
        <div><label for="form-descricao">Descrição</label><input type="text" id="form-descricao" placeholder="Ex: Kit 50h, Filtro..."></div>
        <div><label for="form-os">OS</label><input type="text" id="form-os" placeholder="Nº da Ordem de Serviço"></div>
        <div><label for="form-quem-entregou">Quem Entregou</label><input type="text" id="form-quem-entregou" placeholder="Nome do funcionário"></div>
        <div><label for="form-quem-pegou">Quem Retirou</label><input type="text" id="form-quem-pegou" placeholder="Nome do cliente/responsável"></div>
        <div><label for="form-status">Status</label><select id="form-status"><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></div>
      </div>
      <div class="form-buttons">
        <button class="btn-cancel">Cancelar</button>
        <button class="btn-save">Salvar</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const { jsPDF } = window.jspdf;

  const firebaseConfig = {
    apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
    authDomain: "agro-divel.firebaseapp.com",
    projectId: "agro-divel"
  };

  const app = initializeApp(firebaseConfig );
  const db = getFirestore(app);
  const kitsCollection = collection(db, "kits50Horas");

  let logoBase64 = null;
  async function carregarLogoParaPDF() {
    try {
      // *** CORREÇÃO APLICADA AQUI: Carregando logo de alta qualidade da internet ***
      const response = await fetch('https://i.imgur.com/7UjN7Vn.png' );
      
      if (!response.ok) throw new Error('Imagem do logo não encontrada.');
      const blob = await response.blob();
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      return new Promise(resolve => {
        reader.onloadend = () => {
          logoBase64 = reader.result;
          console.log("Logo de alta qualidade para PDF carregado com sucesso.");
          resolve();
        };
      });
    } catch (error) {
      console.error("Erro ao carregar o logo para o PDF:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    
    await carregarLogoParaPDF();

    if (localStorage.getItem("gestorLogado") !== "true") {
        alert("Acesso restrito! Faça login como gestor.");
        window.location.href = "index.html";
        return;
    }

    try {
      lucide.createIcons();
    } catch (error) {
      console.error("Falha ao carregar os ícones Lucide.", error);
    }

    const tabelaBody = document.getElementById('tabela-kits');
    const loaderOverlay = document.getElementById('loader-overlay');
    
    const kitModal = document.getElementById('kit-modal');
    const btnAddKit = document.getElementById('btn-add-kit');
    const closeModalButton = kitModal.querySelector('.close-button');
    const btnCancel = kitModal.querySelector('.btn-cancel');
    const btnSave = kitModal.querySelector('.btn-save');

    let dadosCompletos = [];
    let dadosFiltrados = [];

    const filtroChassi = document.getElementById('filtro-chassi');
    const filtroModelo = document.getElementById('filtro-modelo');
    const filtroDescricao = document.getElementById('filtro-descricao');

    async function carregarDadosDoFirebase() {
        loaderOverlay.style.display = 'flex';
        try {
            const filiaisLogadas = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
            if (filiaisLogadas.length === 0) {
                throw new Error("Nenhuma filial associada a este gestor.");
            }

            const dynamicTitle = document.getElementById('dynamic-title');
            dynamicTitle.textContent = `Controle de Kits 50 Horas - Filial: ${filiaisLogadas.join(", ")}`;

            const q = query(kitsCollection, orderBy("dataEntrega", "desc"));
            const querySnapshot = await getDocs(q);
            
            const todosOsKits = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            dadosCompletos = todosOsKits.filter(kit => {
                const filialDoKit = (kit.filial || "").toLowerCase().trim();
                return filiaisLogadas.some(f => f.toLowerCase().trim() === filialDoKit);
            });

            aplicarFiltros();
        } catch (error) {
            console.error("Erro ao carregar dados do Firebase:", error);
            loaderOverlay.innerHTML = `<div style="margin: auto; text-align: center;">Erro ao carregar. Verifique o console (F12).</div>`;
        } finally {
            loaderOverlay.style.display = 'none';
        }
    }

    function aplicarFiltros() {
      const chassiFiltro = filtroChassi.value.toLowerCase();
      const modeloFiltro = filtroModelo.value.toLowerCase();
      const descricaoFiltro = filtroDescricao.value.toLowerCase();
    
      // 1. Filtra os dados como antes
      dadosFiltrados = dadosCompletos.filter(kit => 
        (kit.chassi || '').toLowerCase().includes(chassiFiltro) &&
        (kit.modelo || '').toLowerCase().includes(modeloFiltro) &&
        (kit.descricao || '').toLowerCase().includes(descricaoFiltro)
      );
    
      // *** 2. A MÁGICA ACONTECE AQUI: Ordena os dados filtrados ***
      // A função sort() reorganiza o array.
      dadosFiltrados.sort((a, b) => {
        // Se os status forem diferentes, ordena por status
        if (a.status !== b.status) {
          // 'Em Andamento' vem antes de 'Concluído'
          return a.status === 'Em Andamento' ? -1 : 1;
        }
        // Se os status forem iguais, mantém a ordenação original por data (que já veio do Firebase)
        return 0; 
      });
    
      // 3. Renderiza a tabela com os dados já ordenados
      renderizarTabela();
      atualizarCards();
    }

    function renderizarTabela() {
      tabelaBody.innerHTML = '';
      dadosFiltrados.forEach(kit => {
        const tr = document.createElement('tr');
        tr.dataset.id = kit.id;
        
        if (kit.status === 'Em Andamento') {
            tr.classList.add('status-em-andamento');
        } else if (kit.status === 'Concluído') {
            tr.classList.add('status-concluido');
        }
        
        const statusOptions = `<option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option>`;
        
        tr.innerHTML = `
          <td>${formatarData(kit.dataEntrega)}</td>
          <td contenteditable="true" data-field="chassi">${kit.chassi || ''}</td>
          <td contenteditable="true" data-field="modelo">${kit.modelo || ''}</td>
          <td contenteditable="true" data-field="descricao">${kit.descricao || ''}</td>
          <td contenteditable="true" data-field="os">${kit.os || ''}</td>
          <td contenteditable="true" data-field="quemEntregou">${kit.quemEntregou || ''}</td>
          <td contenteditable="true" data-field="quemPegou">${kit.quemPegou || ''}</td>
          <td><select class="status-select" data-field="status">${statusOptions}</select></td>
          <td>
            <button class="btn-print" title="Gerar PDF">
              <i data-lucide="printer" style="width: 18px; height: 18px;"></i>
            </button>
          </td>
        `;
        tabelaBody.appendChild(tr);

        const statusSelect = tr.querySelector('select[data-field="status"]');
        statusSelect.value = kit.status;

        tr.querySelector('.btn-print').addEventListener('click', () => gerarPDF(kit));
      });
      
      try {
        lucide.createIcons();
      } catch (e) { console.error(e); }

      adicionarEventosTabela();
    }

    function gerarPDF(kit) {
    const doc = new jsPDF();

    if (logoBase64) {
        // *** A SOLUÇÃO DEFINITIVA ESTÁ AQUI ***

        // 1. Definimos a largura desejada para o logo no PDF.
        const logoWidth = 45; 
        
        // 2. Como a imagem original é quadrada (300x300), a altura no PDF
        //    deve ser igual à largura para manter a proporção e não distorcer.
        const logoHeight = logoWidth; 

        // 3. Adicionamos a imagem com as dimensões corretas.
        //    A imagem ficará na posição x=15, y=15, com 45 de largura e 45 de altura.
        doc.addImage(logoBase64, 'PNG', 15, 15, logoWidth, logoHeight, undefined, 'NONE');
    } else {
        console.warn("Logo não carregado, PDF será gerado sem ele.");
    }

    doc.setFont('Helvetica', 'bold');
    doc.setFontSize(12);

    // Ajustamos a posição inicial do texto para começar abaixo da imagem.
    // Como a imagem agora tem 45 de altura, começamos o texto em y=70.
    let y = 70; 
    const lineHeight = 12;

    doc.text('CLIENTE:', 15, y);
    doc.setFont('Helvetica', 'normal');
    doc.text('AGRO DIVEL', 55, y);
    y += lineHeight;

    doc.setFont('Helvetica', 'bold');
    doc.text('MODELO:', 15, y);
    doc.setFont('Helvetica', 'normal');
    doc.text(kit.modelo || '-', 55, y);
    y += lineHeight;

    doc.setFont('Helvetica', 'bold');
    doc.text('CHASSI:', 15, y);
    doc.setFont('Helvetica', 'normal');
    doc.text(kit.chassi || '-', 55, y);
    y += lineHeight;

    doc.setFont('Helvetica', 'bold');
    doc.text('DESCRIÇÃO:', 15, y);
    doc.setFont('Helvetica', 'normal');
    doc.text(kit.descricao || '-', 55, y);
    y += lineHeight;

    doc.setFont('Helvetica', 'bold');
    doc.text('RESPONSÁVEL:', 15, y);
    doc.setFont('Helvetica', 'normal');
    doc.text(kit.quemEntregou || '-', 55, y);
    y += lineHeight;

    doc.setFont('Helvetica', 'bold');
    doc.text('DATA:', 15, y);
    doc.setFont('Helvetica', 'normal');
    doc.text(formatarData(kit.dataEntrega) || '-', 55, y);
    y += lineHeight;

    doc.setFont('Helvetica', 'bold');
    doc.text('ORDEM SERVIÇO:', 15, y);
    doc.setFont('Helvetica', 'normal');
    doc.text(kit.os || '-', 55, y);

    doc.save(`Comprovante_${kit.chassi || 'kit'}.pdf`);
}

    function adicionarEventosTabela() {
        tabelaBody.querySelectorAll('tr').forEach(row => {
            const id = row.dataset.id;
            
            row.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
                cell.addEventListener('blur', async () => {
                    const field = cell.dataset.field;
                    const value = cell.textContent.trim();
                    await atualizarDocumento(id, { [field]: value });
                });
            });

            row.querySelector('.status-select').addEventListener('change', async (e) => {
                const value = e.target.value;
                await atualizarDocumento(id, { status: value });
                
                row.className = '';
                if (value === 'Em Andamento') {
                    row.classList.add('status-em-andamento');
                } else if (value === 'Concluído') {
                    row.classList.add('status-concluido');
                }
                
                atualizarCards();
            });
        });
    }

    async function atualizarDocumento(id, data) {
        const docRef = doc(db, "kits50Horas", id);
        await updateDoc(docRef, data);
    }

    function atualizarCards() {
        const total = dadosFiltrados.length;
        const andamento = dadosFiltrados.filter(k => k.status === 'Em Andamento').length;
        const concluidos = total - andamento;

        document.getElementById('total-kits').textContent = total;
        document.getElementById('kits-andamento').textContent = andamento;
        document.getElementById('kits-concluidos').textContent = concluidos;
    }

    function formatarData(dataString) {
        if (!dataString) return '-';
        const [ano, mes, dia] = dataString.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    function abrirModal() {
        document.getElementById('form-data-entrega').valueAsDate = new Date();
        document.getElementById('form-chassi').value = '';
        document.getElementById('form-modelo').value = '';
        document.getElementById('form-descricao').value = '';
        document.getElementById('form-os').value = '';
        document.getElementById('form-quem-entregou').value = '';
        document.getElementById('form-quem-pegou').value = '';
        document.getElementById('form-status').value = 'Em Andamento';
        kitModal.style.display = 'flex';
    }

    function fecharModal() {
        kitModal.style.display = 'none';
    }

    async function salvarKit() {
        const filiaisDoGestor = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
        const filialPrincipal = filiaisDoGestor.length > 0 ? filiaisDoGestor[0] : "";

        if (!filialPrincipal) {
            alert("Não foi possível identificar a sua filial. Faça o login novamente.");
            return;
        }

        const novoKit = {
            dataEntrega: document.getElementById('form-data-entrega').value,
            chassi: document.getElementById('form-chassi').value.trim(),
            modelo: document.getElementById('form-modelo').value.trim(),
            descricao: document.getElementById('form-descricao').value.trim(),
            os: document.getElementById('form-os').value.trim(),
            quemEntregou: document.getElementById('form-quem-entregou').value.trim(),
            quemPegou: document.getElementById('form-quem-pegou').value.trim(),
            status: document.getElementById('form-status').value,
            filial: filialPrincipal
        };

        if (!novoKit.dataEntrega || !novoKit.chassi) {
            alert("Os campos 'Data da Entrega' e 'Chassi' são obrigatórios.");
            return;
        }

        await addDoc(kitsCollection, novoKit);
        fecharModal();
        await carregarDadosDoFirebase();
    }

    btnAddKit.addEventListener('click', abrirModal);
    closeModalButton.addEventListener('click', fecharModal);
    btnCancel.addEventListener('click', fecharModal);
    btnSave.addEventListener('click', salvarKit);
    window.addEventListener('click', (e) => { if (e.target == kitModal) fecharModal(); });

    filtroChassi.addEventListener('input', aplicarFiltros);
    filtroModelo.addEventListener('input', aplicarFiltros);
    filtroDescricao.addEventListener('input', aplicarFiltros);

    carregarDadosDoFirebase();
  });
</script>

</body>
</html>





