<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Controle de Kits 50 Horas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LIBS EXTERNAS -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- CSS -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/Pages/Dashboard/Principal.css">

</head>
<body>

  <nav id="sidebar-placeholder"></nav>

  <!-- Conteúdo Principal da Página -->
  <section class="home">
    <div class="text">
      <h1>Controle de Kits 50 Horas</h1>
      <p id="dynamic-title">Carregando...</p>
    </div>

    <!-- CARDS DE RESUMO -->
    <div class="dashboard-cards">
      <div class="dashboard-card pink-card">
        <h2 id="total-kits">0</h2>
        <p><i data-lucide="package"></i> Total de Kits</p>
      </div>
      <div class="dashboard-card orange-card">
        <h2 id="kits-andamento">0</h2>
        <p><i data-lucide="loader-circle"></i> Em Andamento</p>
      </div>
      <div class="dashboard-card green-card">
        <h2 id="kits-concluidos">0</h2>
        <p><i data-lucide="check-circle"></i> Concluídos</p>
      </div>
    </div>

    <!-- CONTAINER PRINCIPAL DO DASHBOARD -->
    <div class="content-card">
      <div class="content-card-header">
        <h3>Acompanhamento de Kits</h3>
        <button id="btn-add-kit" class="btn-acao" style="margin-left:auto;" title="Adicionar Novo Kit">
          <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
        </button>
      </div>
      <div class="content-card-body">
        <div class="filters">
          <input id="filtro-chassi" type="text" placeholder="Buscar por chassi..." />
          <input id="filtro-modelo" type="text" placeholder="Buscar por modelo..." />
          <input id="filtro-descricao" type="text" placeholder="Buscar por descrição..." />
        </div>

        <table>
          <thead>
            <tr>
              <th>Data da Entrega</th><th>Chassi</th><th>Modelo</th><th>Descrição</th><th>OS</th><th>NF</th><th>Quem Entregou</th><th>Quem Retirou</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabela-kits"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- MODAL (POPUP ) DE ADIÇÃO/EDIÇÃO -->
  <div id="kit-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 id="modal-title">Adicionar Novo Kit</h3>
        <button class="modal-close-btn" onclick="fecharModal()">&times;</button>
      </div>
      <div class="modal-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <input type="hidden" id="kit-id">
        <div class="form-group"><label for="form-data-entrega">Data da Entrega</label><input type="date" id="form-data-entrega"></div>
        <div class="form-group"><label for="form-chassi">Chassi</label><input type="text" id="form-chassi" placeholder="Nº do Chassi"></div>
        <div class="form-group"><label for="form-modelo">Modelo</label><input type="text" id="form-modelo" placeholder="Modelo do Veículo"></div>
        <div class="form-group"><label for="form-descricao">Descrição</label><input type="text" id="form-descricao" placeholder="Ex: Kit 50h, Filtro..."></div>
        <div class="form-group"><label for="form-os">OS</label><input type="text" id="form-os" placeholder="Nº da Ordem de Serviço"></div>
        <div class="form-group"><label for="form-nf">Nota Fiscal (NF)</label><input type="text" id="form-nf" placeholder="Nº da Nota Fiscal"></div>
        <div class="form-group"><label for="form-quem-entregou">Quem Entregou</label><input type="text" id="form-quem-entregou" placeholder="Nome do funcionário"></div>
        <div class="form-group"><label for="form-quem-pegou">Quem Retirou</label><input type="text" id="form-quem-pegou" placeholder="Nome do cliente/responsável"></div>
        <div class="form-group"><label for="form-status">Status</label><select id="form-status"><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn btn-cancel" onclick="fecharModal()">Cancelar</button>
        <button class="modal-btn btn-save" id="btn-save">Salvar</button>
      </div>
    </div>
  </div>

<script type="module">
  import { garantirAutenticacao } from '/assets/js/auth-guard.js';
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const { jsPDF } = window.jspdf;

  async function iniciarPagina( ) {
    try {
      const userData = await garantirAutenticacao();
      const app = getApp();
      const db = getFirestore(app);
      const kitsCollection = collection(db, "kits50Horas");

      let podeEditar = userData.grupo?.includes("pecas") || false;
      let podeApagar = userData.grupo?.includes("admin") || false;
      let dadosCompletos = [], dadosFiltrados = [];
      let logoBase64 = null;

      async function carregarLogoParaPDF() {
        try {
          const response = await fetch('/assets/images/logoPDF.png');
          if (!response.ok) throw new Error(`Imagem do logo não encontrada: ${response.statusText}`);
          const blob = await response.blob();
          const reader = new FileReader();
          reader.readAsDataURL(blob);
          return new Promise(resolve => {
            reader.onloadend = () => { logoBase64 = reader.result; resolve(); };
          });
        } catch (error) {
          console.error("Erro ao carregar o logo para o PDF:", error);
        }
      }

      function setupListeners() {
        document.getElementById('filtro-chassi').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-modelo').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-descricao').addEventListener('input', aplicarFiltros);
        document.getElementById('btn-add-kit').addEventListener('click', () => abrirModal());
        document.getElementById('btn-save').addEventListener('click', salvarKit);
        document.getElementById('kit-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) fecharModal();
        });
      }

      async function carregarDadosDoFirebase() {
        const filiaisLogadas = userData.filial || [];
        document.getElementById('dynamic-title').textContent = `Filial: ${filiaisLogadas.join(", ")}`;
        
        const q = query(kitsCollection, orderBy("dataEntrega", "desc"));
        const querySnapshot = await getDocs(q);
        const todosOsKits = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        
        dadosCompletos = todosOsKits.filter(kit => {
            const filialDoKit = (kit.filial || "").toLowerCase().trim();
            return filiaisLogadas.some(f => f.toLowerCase().trim() === filialDoKit);
        });

        aplicarFiltros();
        atualizarCards(dadosCompletos);
      }

      function aplicarFiltros() {
        const chassiFiltro = document.getElementById('filtro-chassi').value.toLowerCase();
        const modeloFiltro = document.getElementById('filtro-modelo').value.toLowerCase();
        const descricaoFiltro = document.getElementById('filtro-descricao').value.toLowerCase();
        
        dadosFiltrados = dadosCompletos.filter(kit => 
          (kit.chassi || '').toLowerCase().includes(chassiFiltro) &&
          (kit.modelo || '').toLowerCase().includes(modeloFiltro) &&
          (kit.descricao || '').toLowerCase().includes(descricaoFiltro)
        );
        
        dadosFiltrados.sort((a, b) => a.status === 'Em Andamento' ? -1 : 1);
        renderizarTabela();
      }

      function renderizarTabela() {
        const tabelaBody = document.getElementById('tabela-kits');
        tabelaBody.innerHTML = '';
        if (dadosFiltrados.length === 0) {
            tabelaBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Nenhum registro encontrado.</td></tr>';
            return;
        }
        dadosFiltrados.forEach(kit => {
          const statusClass = kit.status === 'Concluído' ? 'status-concluido' : 'status-em-andamento';
          const tr = document.createElement('tr');
          tr.className = statusClass;
          tr.dataset.id = kit.id;
          
          const editButtonHTML = podeEditar ? `<button class="btn-acao btn-edit" data-id="${kit.id}" title="Editar"><i data-lucide="pencil" style="width: 15px; pointer-events: none;"></i></button>` : '';
          const deleteButtonHTML = podeApagar ? `<button class="btn-acao btn-delete" data-id="${kit.id}" title="Apagar"><i data-lucide="trash-2" style="width: 15px; pointer-events: none;"></i></button>` : '';

          tr.innerHTML = `
            <td>${formatarData(kit.dataEntrega)}</td><td>${kit.chassi || ''}</td><td>${kit.modelo || ''}</td><td>${kit.descricao || ''}</td><td>${kit.os || ''}</td><td>${kit.nf || ''}</td><td>${kit.quemEntregou || ''}</td><td>${kit.quemPegou || ''}</td>
            <td><select class="status-select" data-id="${kit.id}" ${!podeEditar ? 'disabled' : ''}><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></td>
            <td class="acoes-cell">
                ${editButtonHTML}
                <button class="btn-acao btn-print" data-id="${kit.id}" title="Gerar PDF"><i data-lucide="printer" style="width: 15px; pointer-events: none;"></i></button>
                ${deleteButtonHTML}
            </td>
          `;
          tabelaBody.appendChild(tr);
          const statusSelect = tr.querySelector('select.status-select');
          statusSelect.value = kit.status;
          statusSelect.addEventListener('change', () => atualizarStatus(kit.id, statusSelect.value));
        });
        lucide.createIcons();
        
        // Adiciona listeners aos botões de ação da tabela
        tabelaBody.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', (e) => abrirModal(e.currentTarget.dataset.id)));
        tabelaBody.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', (e) => apagarKit(e.currentTarget.dataset.id)));
        tabelaBody.querySelectorAll('.btn-print').forEach(b => b.addEventListener('click', (e) => gerarPDF(e.currentTarget.dataset.id)));
      }

      async function atualizarStatus(id, novoStatus) {
        try {
            await updateDoc(doc(db, "kits50Horas", id), { status: novoStatus });
            await carregarDadosDoFirebase(); // Recarrega para atualizar cards e ordenação
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Status atualizado!', showConfirmButton: false, timer: 2000 });
        } catch (error) {
            console.error("Erro ao atualizar status:", error);
            Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: 'Erro ao atualizar!', showConfirmButton: false, timer: 2000 });
        }
      }

      function atualizarCards(dados) {
          const total = dados.length;
          const andamento = dados.filter(k => k.status === 'Em Andamento').length;
          document.getElementById('total-kits').textContent = total;
          document.getElementById('kits-andamento').textContent = andamento;
          document.getElementById('kits-concluidos').textContent = total - andamento;
      }
      
      async function abrirModal(id = null) {
        const modal = document.getElementById('kit-modal');
        const modalTitle = document.getElementById('modal-title');
        const kitIdInput = document.getElementById('kit-id');
        
        // Limpa o formulário
        document.querySelectorAll('.modal-body input, .modal-body select').forEach(el => el.value = '');
        document.getElementById('form-status').value = 'Em Andamento';

        if (id) { // Modo Edição
            modalTitle.textContent = 'Editar Kit';
            kitIdInput.value = id;
            const docRef = doc(db, "kits50Horas", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('form-data-entrega').value = data.dataEntrega || '';
                document.getElementById('form-chassi').value = data.chassi || '';
                document.getElementById('form-modelo').value = data.modelo || '';
                document.getElementById('form-descricao').value = data.descricao || '';
                document.getElementById('form-os').value = data.os || '';
                document.getElementById('form-nf').value = data.nf || '';
                document.getElementById('form-quem-entregou').value = data.quemEntregou || '';
                document.getElementById('form-quem-pegou').value = data.quemPegou || '';
                document.getElementById('form-status').value = data.status || 'Em Andamento';
            }
        } else { // Modo Adição
            modalTitle.textContent = 'Adicionar Novo Kit';
            kitIdInput.value = '';
            document.getElementById('form-data-entrega').valueAsDate = new Date();
        }
        modal.classList.add('visible');
      }

      window.fecharModal = () => document.getElementById('kit-modal').classList.remove('visible');

      async function salvarKit() {
          const id = document.getElementById('kit-id').value;
          const filiaisDoUsuario = userData.filial || [];
          if (filiaisDoUsuario.length === 0) {
              return Swal.fire('Erro', 'Filial do usuário não identificada. Contate o administrador.', 'error');
          }
          const dadosKit = {
              dataEntrega: document.getElementById('form-data-entrega').value,
              chassi: document.getElementById('form-chassi').value.trim(),
              modelo: document.getElementById('form-modelo').value.trim(),
              descricao: document.getElementById('form-descricao').value.trim(),
              os: document.getElementById('form-os').value.trim(),
              nf: document.getElementById('form-nf').value.trim(),
              quemEntregou: document.getElementById('form-quem-entregou').value.trim(),
              quemPegou: document.getElementById('form-quem-pegou').value.trim(),
              status: document.getElementById('form-status').value,
              filial: id ? undefined : filiaisDoUsuario[0] // Adiciona filial apenas na criação
          };

          if (!dadosKit.dataEntrega || !dadosKit.chassi) {
              return Swal.fire('Atenção', 'Os campos "Data da Entrega" e "Chassi" são obrigatórios.', 'warning');
          }

          try {
              if (id) { // Atualizar
                  delete dadosKit.filial; // Não sobrescrever a filial original
                  await updateDoc(doc(db, "kits50Horas", id), dadosKit);
              } else { // Adicionar
                  await addDoc(kitsCollection, dadosKit);
              }
              fecharModal();
              await carregarDadosDoFirebase();
              Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Kit salvo com sucesso!', showConfirmButton: false, timer: 2000 });
          } catch (error) {
              console.error("Erro ao salvar kit:", error);
              Swal.fire('Erro', 'Ocorreu um erro ao salvar o kit. Tente novamente.', 'error');
          }
      }
      
      async function apagarKit(id) {
        const kitParaApagar = dadosFiltrados.find(k => k.id === id);
        const chassi = kitParaApagar?.chassi || 'este item';
        
        const result = await Swal.fire({
            title: 'Tem certeza?',
            text: `Você realmente deseja apagar o kit do chassi "${chassi}"? Esta ação não pode ser desfeita.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, apagar!',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                await deleteDoc(doc(db, "kits50Horas", id));
                await carregarDadosDoFirebase();
                Swal.fire('Apagado!', 'O registro foi apagado com sucesso.', 'success');
            } catch (error) {
                console.error("Erro ao apagar registro:", error);
                Swal.fire('Erro!', 'Não foi possível apagar o registro.', 'error');
            }
        }
      }

      function gerarPDF(id) {
          const kit = dadosFiltrados.find(k => k.id === id);
          if (!kit) return;
          const docPDF = new jsPDF();
          if (logoBase64) {
              docPDF.addImage(logoBase64, 'PNG', 15, 15, 45, 45, undefined, 'NONE');
          }
          docPDF.setFont('Helvetica', 'bold');
          docPDF.setFontSize(12);
          docPDF.text('Comprovante de Entrega - Kit 50 Horas', 105, 20, { align: 'center' });
          let y = 70;
          const lineHeight = 10;
          const addLine = (label, value) => {
              docPDF.setFont('Helvetica', 'bold'); docPDF.text(label, 15, y);
              docPDF.setFont('Helvetica', 'normal'); docPDF.text(value || '-', 55, y);
              y += lineHeight;
          };
          addLine('CLIENTE:', 'AGRO DIVEL');
          addLine('MODELO:', kit.modelo);
          addLine('CHASSI:', kit.chassi);
          addLine('DESCRIÇÃO:', kit.descricao);
          addLine('NOTA FISCAL:', kit.nf);
          addLine('ORDEM SERVIÇO:', kit.os);
          addLine('RESPONSÁVEL:', kit.quemEntregou);
          addLine('DATA:', formatarData(kit.dataEntrega));
          docPDF.save(`Comprovante_${kit.chassi || 'kit'}.pdf`);
      }

      function formatarData(dataString) {
          if (!dataString) return '-';
          const [ano, mes, dia] = dataString.split('-');
          return `${dia}/${mes}/${ano}`;
      }
      
      // --- INÍCIO DA EXECUÇÃO ---
      lucide.createIcons();
      setupListeners();
      await carregarLogoParaPDF();
      await carregarDadosDoFirebase();
      // Disponibiliza funções globais para serem chamadas pelo HTML (onclick)
      window.abrirModal = abrirModal;

    } catch (error) {
      console.error("Falha na inicialização da página:", error);
      document.body.innerHTML = `<div style="color: white; text-align: center; padding: 50px;">Ocorreu um erro ao carregar a página. Verifique o console e tente novamente. <a href="/login.html">Voltar ao login</a></div>`;
    }
  }

  iniciarPagina();
</script>

  <!-- Scripts Globais -->
  <script type="module" src="/assets/js/firebase-config.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>
  <script src="/assets/js/main.js"></script> 
  <script src="/assets/js/components/Sidebar.js"></script>

</body>
</html>
