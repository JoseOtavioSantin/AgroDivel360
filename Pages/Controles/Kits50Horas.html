<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Controle de Kits 50 Horas</title>
  <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LIBS EXTERNAS -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- CSS -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/Pages/Dashboard/Principal.css">

  <style>
    /* Estilos dos botões de ação na tabela */
    .btn-acao {
        display: inline-flex; align-items: center; justify-content: center;
        background-color: #193b7c; color: white; border: none;
        border-radius: 6px; padding: 6px; cursor: pointer;
        transition: background-color 0.2s ease; text-decoration: none;
        margin: 0 2px;
    }
    .btn-acao:hover { background-color: #132a5a; }
    .btn-acao i { width: 15px; height: 15px; pointer-events: none; }
  </style>

</head>
<body>

  <nav id="sidebar-placeholder"></nav>

  <!-- Conteúdo Principal da Página -->
  <section class="home">
    <div class="text">
      <h1>Controle de Kits 50 Horas</h1>
      <p id="dynamic-title">Carregando...</p>
    </div>

    <!-- CARDS DE RESUMO -->
    <div class="dashboard-cards">
      <div class="dashboard-card pink-card"><h2 id="total-kits">0</h2><p><i data-lucide="package"></i> Total de Kits</p></div>
      <div class="dashboard-card orange-card"><h2 id="kits-andamento">0</h2><p><i data-lucide="loader-circle"></i> Em Andamento</p></div>
      <div class="dashboard-card green-card"><h2 id="kits-concluidos">0</h2><p><i data-lucide="check-circle"></i> Concluídos</p></div>
    </div>

    <!-- CONTAINER PRINCIPAL DO DASHBOARD -->
    <div class="content-card">
      <div class="content-card-header">
        <h3>Acompanhamento de Kits</h3>
        <a href="/Pages/Formularios/form-kit50horas.html" class="btn-acao" style="margin-left:auto;" title="Adicionar Novo Kit">
          <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
        </a>
      </div>
      <div class="content-card-body">
        <div class="filters">
          <input id="filtro-chassi" type="text" placeholder="Buscar por chassi..." />
          <input id="filtro-modelo" type="text" placeholder="Buscar por modelo..." />
          <input id="filtro-descricao" type="text" placeholder="Buscar por descrição..." />
        </div>

        <table>
          <thead>
            <tr>
              <th>Data da Entrega</th><th>Chassi</th><th>Modelo</th><th>Descrição</th><th>OS</th><th>NF</th><th>Quem Entregou</th><th>Quem Retirou</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabela-kits"></tbody>
        </table>
      </div>
    </div>
  </section>

<script type="module">
  import { garantirAutenticacao } from '/assets/js/auth-guard.js';
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const { jsPDF } = window.jspdf;

  async function iniciarPagina( ) {
    try {
      const userData = await garantirAutenticacao();
      const app = getApp();
      const db = getFirestore(app);
      const kitsCollection = collection(db, "kits50Horas");

      let podeEditar = userData.grupo?.includes("pecas") || userData.grupo?.includes("admin") || false;
      let podeApagar = userData.grupo?.includes("admin") || false;
      let dadosCompletos = [], dadosFiltrados = [];
      let logoBase64 = null;

      async function carregarLogoParaPDF() {
        try {
          const response = await fetch('/assets/images/logoPDF.png');
          if (!response.ok) throw new Error(`Imagem do logo não encontrada: ${response.statusText}`);
          const blob = await response.blob();
          const reader = new FileReader();
          reader.readAsDataURL(blob);
          return new Promise(resolve => {
            reader.onloadend = () => { logoBase64 = reader.result; resolve(); };
          });
        } catch (error) { console.error("Erro ao carregar o logo para o PDF:", error); }
      }

      function setupListeners() {
        document.getElementById('filtro-chassi').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-modelo').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-descricao').addEventListener('input', aplicarFiltros);
        
        // Listeners de clique na tabela para delegação de eventos
        document.getElementById('tabela-kits').addEventListener('click', (e) => {
            const target = e.target;
            if (target.closest('.btn-delete')) {
                apagarKit(target.closest('.btn-delete').dataset.id);
            } else if (target.closest('.btn-print')) {
                gerarPDF(target.closest('.btn-print').dataset.id);
            }
        });
      }

      async function carregarDadosDoFirebase() {
        const filiaisLogadas = userData.filial || [];
        document.getElementById('dynamic-title').textContent = `Filial: ${filiaisLogadas.join(", ")}`;
        
        const q = query(kitsCollection, orderBy("dataEntrega", "desc"));
        const querySnapshot = await getDocs(q);
        const todosOsKits = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        
        dadosCompletos = todosOsKits.filter(kit => {
            const filialDoKit = (kit.filial || "").toLowerCase().trim();
            return filiaisLogadas.some(f => f.toLowerCase().trim() === filialDoKit);
        });

        aplicarFiltros();
        atualizarCards(dadosCompletos);
      }

      function aplicarFiltros() {
        const chassiFiltro = document.getElementById('filtro-chassi').value.toLowerCase();
        const modeloFiltro = document.getElementById('filtro-modelo').value.toLowerCase();
        const descricaoFiltro = document.getElementById('filtro-descricao').value.toLowerCase();
        
        dadosFiltrados = dadosCompletos.filter(kit => 
          (kit.chassi || '').toLowerCase().includes(chassiFiltro) &&
          (kit.modelo || '').toLowerCase().includes(modeloFiltro) &&
          (kit.descricao || '').toLowerCase().includes(descricaoFiltro)
        );
        
        dadosFiltrados.sort((a, b) => {
            if (a.status === 'Em Andamento' && b.status !== 'Em Andamento') return -1;
            if (a.status !== 'Em Andamento' && b.status === 'Em Andamento') return 1;
            return 0; // Mantém a ordem original para status iguais
        });
        renderizarTabela();
      }

      function renderizarTabela() {
        const tabelaBody = document.getElementById('tabela-kits');
        tabelaBody.innerHTML = '';
        if (dadosFiltrados.length === 0) {
            tabelaBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Nenhum registro encontrado.</td></tr>';
            return;
        }
        dadosFiltrados.forEach(kit => {
          const statusClass = kit.status === 'Concluído' ? 'status-concluido' : 'status-em-andamento';
          
          const editButtonHTML = podeEditar ? `<a href="/Pages/Formularios/form-kit50horas.html?id=${kit.id}" class="btn-acao" title="Editar"><i data-lucide="pencil"></i></a>` : '';
          const deleteButtonHTML = podeApagar ? `<button class="btn-acao btn-delete" data-id="${kit.id}" title="Apagar"><i data-lucide="trash-2"></i></button>` : '';

          const tr = document.createElement('tr');
          tr.className = statusClass;
          tr.innerHTML = `
            <td>${formatarData(kit.dataEntrega)}</td><td>${kit.chassi || ''}</td><td>${kit.modelo || ''}</td><td>${kit.descricao || ''}</td><td>${kit.os || ''}</td><td>${kit.nf || ''}</td><td>${kit.quemEntregou || ''}</td><td>${kit.quemPegou || ''}</td>
            <td><select class="status-select" data-id="${kit.id}" ${!podeEditar ? 'disabled' : ''}><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></td>
            <td class="acoes-cell">
                ${editButtonHTML}
                <button class="btn-acao btn-print" data-id="${kit.id}" title="Gerar PDF"><i data-lucide="printer"></i></button>
                ${deleteButtonHTML}
            </td>
          `;
          tabelaBody.appendChild(tr);
          const statusSelect = tr.querySelector('select.status-select');
          statusSelect.value = kit.status;
          statusSelect.addEventListener('change', () => atualizarStatus(kit.id, statusSelect.value));
        });
        lucide.createIcons();
      }

      async function atualizarStatus(id, novoStatus) {
        try {
            await updateDoc(doc(db, "kits50Horas", id), { status: novoStatus });
            await carregarDadosDoFirebase();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Status atualizado!', showConfirmButton: false, timer: 2000 });
        } catch (error) {
            Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: 'Erro ao atualizar!', showConfirmButton: false, timer: 2000 });
        }
      }

      function atualizarCards(dados) {
          const total = dados.length;
          const andamento = dados.filter(k => k.status === 'Em Andamento').length;
          document.getElementById('total-kits').textContent = total;
          document.getElementById('kits-andamento').textContent = andamento;
          document.getElementById('kits-concluidos').textContent = total - andamento;
      }
      
      async function apagarKit(id) {
        const kitParaApagar = dadosCompletos.find(k => k.id === id);
        const chassi = kitParaApagar?.chassi || 'este item';
        
        const result = await Swal.fire({
            title: 'Tem certeza?', text: `Deseja apagar o kit do chassi "${chassi}"?`,
            icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33',
            confirmButtonText: 'Sim, apagar!', cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                await deleteDoc(doc(db, "kits50Horas", id));
                await carregarDadosDoFirebase();
                Swal.fire('Apagado!', 'O registro foi apagado.', 'success');
            } catch (error) {
                Swal.fire('Erro!', 'Não foi possível apagar o registro.', 'error');
            }
        }
      }

      function gerarPDF(id) {
          const kit = dadosCompletos.find(k => k.id === id);
          if (!kit) return;
          const docPDF = new jsPDF();
          if (logoBase64) {
              docPDF.addImage(logoBase64, 'PNG', 15, 15, 45, 45, undefined, 'NONE');
          }
          docPDF.setFont('Helvetica', 'bold');
          docPDF.setFontSize(12);
          docPDF.text('Comprovante de Entrega - Kit 50 Horas', 105, 20, { align: 'center' });
          let y = 70;
          const lineHeight = 10;
          const addLine = (label, value) => {
              docPDF.setFont('Helvetica', 'bold'); docPDF.text(label, 15, y);
              docPDF.setFont('Helvetica', 'normal'); docPDF.text(value || '-', 55, y);
              y += lineHeight;
          };
          addLine('CLIENTE:', 'AGRO DIVEL');
          addLine('MODELO:', kit.modelo);
          addLine('CHASSI:', kit.chassi);
          addLine('DESCRIÇÃO:', kit.descricao);
          addLine('NOTA FISCAL:', kit.nf);
          addLine('ORDEM SERVIÇO:', kit.os);
          addLine('RESPONSÁVEL:', kit.quemEntregou);
          addLine('DATA:', formatarData(kit.dataEntrega));
          docPDF.save(`Comprovante_${kit.chassi || 'kit'}.pdf`);
      }

      function formatarData(dataString) {
          if (!dataString) return '-';
          const [ano, mes, dia] = dataString.split('-');
          return `${dia}/${mes}/${ano}`;
      }
      
      // --- INÍCIO DA EXECUÇÃO ---
      lucide.createIcons();
      setupListeners();
      await carregarLogoParaPDF();
      await carregarDadosDoFirebase();

    } catch (error) {
      console.error("Falha na inicialização da página:", error);
      document.body.innerHTML = `<div style="color: white; text-align: center; padding: 50px;">Ocorreu um erro ao carregar a página. Verifique o console e tente novamente. <a href="/login.html">Voltar ao login</a></div>`;
    }
  }

  iniciarPagina();
</script>

  <!-- Scripts Globais -->
  <script type="module" src="/assets/js/firebase-config.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>
  <script src="/assets/js/main.js"></script> 
  <script src="/assets/js/components/Sidebar.js"></script>

</body>
</html>
