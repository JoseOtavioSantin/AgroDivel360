<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle e Análise de Estoque</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- PASSO 1: Adicionado arquivo de tradução para Português -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Arial, sans-serif; background-color: #1e1e2f; color: white; display: flex; flex-direction: column; height: 100vh; }
        header { background-color: #2c2f3f; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2  ); }
        .header-content { display: flex; align-items: center; justify-content: space-between; }
        .header-title { flex: 1; text-align: center; }
        #dynamic-title { margin-top: 10px; font-size: 16px; font-weight: normal; color: #ccc; }
        .logo { height: 80px; margin-left: 45px; margin-right: 15px; margin-top: 10px; }
        .main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background-color: #2c2f3f; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .card { padding: 15px; border-radius: 16px; color: white; background: linear-gradient(238deg, #193b7c, #193b7c00); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); text-align: left; display: flex; flex-direction: column; gap: 5px; }
        .card h2 { font-size: 26px; margin: 0; }
        .card p { font-size: 13px; color: #eee; margin: 0; display: flex; align-items: center; gap: 8px; }
        .card .percentage { font-size: 12px; color: #aaa; font-weight: bold; margin-top: 4px; }
        .content { flex: 1; padding: 30px; background-color: #262a3d; overflow-y: auto; }
        .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
        .filters input, .filters select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; min-width: 180px; height: 40px; background-color: #fff; color: #333; }
        table { width: 100%; border-collapse: collapse; background-color: #2c2f3f; border-radius: 12px; overflow: hidden; }
        th, td { font-size: 12px; padding: 10px 15px; text-align: left; border-bottom: 1px solid #444; vertical-align: middle; }
        th { background-color: #ffffff; color: #00205b; }
        .acoes-topo { margin-left: auto; display: flex; gap: 10px; }
        .btn-acao { background: linear-gradient(145deg, #005c97, #363795); border: none; width: 40px; height: 40px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: filter 0.2s, transform 0.2s; }
        .btn-acao:hover { filter: brightness(1.1); transform: scale(1.05); }
        .quantidade-input { background-color: transparent; color: white; border: 1px solid #555; border-radius: 4px; padding: 4px 6px; width: 80px; text-align: center; }
        .quantidade-input:focus { outline: none; border-color: #009bd6; background-color: #3a3f5c; }
        #loader-overlay { display: none; position: fixed; z-index: 9999; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); color: white; font-size: 20px; align-items: center; justify-content: center; font-weight: bold; }
        .sobra-estoque { background-color: #2c4a3b !important; }
        .falta-estoque { background-color: #4a2c2c !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content {
            background-color: #2c2f3f;
            padding: 25px;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid #444;
            /* --- ADICIONE ESTAS DUAS LINHAS --- */
            max-height: 85vh; /* Limita a altura a 85% da altura da tela */
            overflow-y: auto; /* Adiciona rolagem vertical se necessário */
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .modal-header h3 { margin: 0; font-size: 20px; }
        .close-button { cursor: pointer; font-size: 28px; font-weight: bold; transition: color 0.2s; }
        .close-button:hover { color: #ff6b6b; }
        #analise-info p { margin: 2px 0; font-size: 14px; color: #ccc; }
        #analise-info strong { color: #fff; }
        #analise-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .kpi-card { background-color: #262a3d; padding: 15px; border-radius: 8px; text-align: center; }
        .kpi-card .value { font-size: 24px; font-weight: bold; }
        .kpi-card .value.positive { color: #40c057; }
        .kpi-card .value.negative { color: #fa5252; }
        .kpi-card .label { font-size: 12px; color: #aaa; margin-top: 5px; }
        #analise-tabela-container { max-height: 200px; overflow-y: auto; }
        .highlight-row { background-color: #495057 !important; }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/assets/images/logo.png" alt="Logo" class="logo">
            <div class="header-title">
                <em>Dashboard Agro Divel 360</em>
                <div id="dynamic-title">Controle e Análise de Estoque</div>
            </div>
            <div style="width: 110px;"></div>
        </div>
    </header>

    <div class="main">
        <div class="sidebar">
            <div class="card">
                <h2 id="total-itens">0</h2>
                <p><i data-lucide="package"></i> Total de Itens</p>
            </div>

            <div class="card">
                <h2 id="sobra-estoque">0</h2>
                <p><i data-lucide="arrow-up-circle"></i> Sobra de Estoque</p>
                <div class="percentage" id="sobra-percent"></div>
            </div>
            <div class="card">
                <h2 id="falta-estoque">0</h2>
                <p><i data-lucide="arrow-down-circle"></i> Falta de Estoque</p>
                <div class="percentage" id="falta-percent"></div>
            </div>
        </div>

        <div class="content">
            <div id="loader-overlay"><div style="margin: auto;">Carregando dados...</div></div>
            <div class="filters">
                <input id="filtro-codigo" type="text" placeholder="Buscar código..." />
                <input id="filtro-descricao" type="text" placeholder="Buscar descrição..." />
                <select id="filtro-status">
                    <option value="">Todos os Status</option>
                    <option value="ok">Contagem OK</option>
                    <option value="sobra">Sobra de Estoque (+)</option>
                    <option value="falta">Falta de Estoque (-)</option>
                </select>
                <input type="text" id="filtro-data" placeholder="Selecione o período">
                <div class="acoes-topo">
                    <button class="btn-acao" id="btn-download-modelo" title="Baixar modelo"><i data-lucide="download"></i></button>
                    <label for="file-input" class="btn-acao" title="Carregar Planilha"><i data-lucide="upload"></i></label>
                    <input type="file" id="file-input" accept=".csv, .xlsx, .xls" style="display:none;">
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Cód. Produto</th><th>Descrição</th><th>Prateleira</th><th>Estoque Sistema</th><th>Estoque Contado</th><th>Diferença</th><th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela-estoque"></tbody>
            </table>
        </div>
    </div>

    <div id="analise-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Análise de Item</h3><span class="close-button">&times;</span></div>
            <div id="analise-info"></div>
            <div id="analise-kpis"></div>
            
            <!-- MODIFICAÇÃO AQUI: Adicione um div ao redor do canvas -->
            <div id="grafico-container" style="position: relative; height: 300px;">
                <canvas id="analise-grafico"></canvas>
            </div>
            
            <div id="analise-tabela-container"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
            authDomain: "agro-divel.firebaseapp.com",
            projectId: "agro-divel",
            storageBucket: "agro-divel.appspot.com",
            messagingSenderId: "583977436505",
            appId: "1:583977436505:web:3754ec029aebb3d9d67848"
        };

        firebase.initializeApp(firebaseConfig  );
        const db = firebase.firestore();
        const inventarioCollection = db.collection('inventario');

        const loaderOverlay = document.getElementById('loader-overlay');
        const tabelaBody = document.getElementById('tabela-estoque');
        const fileInput = document.getElementById('file-input');
        let dadosLocais = {};
        let unsubscribe = null;
        
        function escutarAtualizacoesInventario() {
            loaderOverlay.style.display = 'flex';
            if (unsubscribe) unsubscribe();

            unsubscribe = inventarioCollection.onSnapshot(snapshot => {
                dadosLocais = {};
                snapshot.forEach(doc => {
                    dadosLocais[doc.id] = doc.data();
                });
                console.log("Dados sincronizados do Firebase.");
                popularFiltroData();
                aplicarFiltros();
                loaderOverlay.style.display = 'none';
            }, error => {
                console.error("Erro ao escutar atualizações:", error);
                alert("Não foi possível conectar ao banco de dados.");
                loaderOverlay.style.display = 'none';
            });
        }

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            loaderOverlay.style.display = 'flex';
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    let jsonData;
                    if (file.name.endsWith('.csv')) {
                        const text = e.target.result;
                        const separador = text.includes(';') ? ';' : ',';
                        const lines = text.split(/\r\n|\n/);
                        const headers = lines[0].split(separador).map(h => h.trim());
                        jsonData = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(separador);
                                const row = {};
                                headers.forEach((header, index) => { row[header] = values[index] ? values[index].trim() : ''; });
                                jsonData.push(row);
                            }
                        }
                    } else {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(worksheet);
                    }

                    const matchData = file.name.match(/(\d{2}-\d{2}-\d{4})/);
                    const dataContagem = matchData ? matchData[0].replace(/-/g, '/') : new Date().toLocaleDateString('pt-BR');
                    
                    const batch = db.batch();
                    let totalItens = 0;

                    jsonData.forEach(row => {
                        const codigoOriginal = (row['Cod. produto'] || row['Código'] || '').toString().trim();
                        const codigoSeguro = codigoOriginal.replace(/\//g, '-');
                        if (!codigoSeguro) return;

                        const descricao = row['Descrição'] || row['Descricao'] || row['descrição'] || row['descricao'] || '';
                        const estoqueSistema = parseFloat((row['Estoque Hoje Quantidade'] || '0').toString().replace(',', '.')) || 0;
                        const docRef = inventarioCollection.doc(codigoSeguro);
                        
                        const itemLocal = dadosLocais[codigoSeguro];
                        const registroExistente = itemLocal?.historico.find(h => h.data === dataContagem);

                        if (registroExistente) {
                            const novoHistorico = itemLocal.historico.map(h => 
                                h.data === dataContagem ? { ...h, estoqueSistema: estoqueSistema, user: 'upload' } : h
                            );
                            batch.update(docRef, { 
                                'info.descricao': descricao, 
                                'info.prateleira': (row['Prateleira'] || '').toString().trim(),
                                'info.codigoOriginal': codigoOriginal,
                                historico: novoHistorico 
                            });
                        } else {
                            batch.set(docRef, {
                                info: {
                                    descricao: descricao,
                                    prateleira: (row['Prateleira'] || '').toString().trim(),
                                    codigoOriginal: codigoOriginal
                                },
                                historico: firebase.firestore.FieldValue.arrayUnion({
                                    data: dataContagem,
                                    estoqueSistema: estoqueSistema,
                                    estoqueContado: estoqueSistema,
                                    user: 'upload'
                                })
                            }, { merge: true });
                        }
                        totalItens++;
                    });

                    await batch.commit();
                    alert(`${totalItens} itens foram processados para a data ${dataContagem}.`);

                } catch (error) {
                    console.error("Erro ao processar o arquivo:", error);
                    alert("Ocorreu um erro ao processar o arquivo. Verifique o console para mais detalhes.");
                } finally {
                    loaderOverlay.style.display = 'none';
                    fileInput.value = '';
                }
            };

            if (file.name.endsWith('.csv')) { reader.readAsText(file, 'UTF-8'); } 
            else { reader.readAsArrayBuffer(file); }
        });
        
        tabelaBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('quantidade-input')) {
                const codigoSeguro = e.target.dataset.codigo;
                const dataContagem = e.target.dataset.data;
                const novoValor = parseInt(e.target.value) || 0;
                const item = dadosLocais[codigoSeguro];
                if (!item) return;
                const novoHistorico = item.historico.map(h => 
                    h.data === dataContagem ? { ...h, estoqueContado: novoValor, user: 'manual' } : h
                );
                inventarioCollection.doc(codigoSeguro).update({ historico: novoHistorico })
                    .catch(err => console.error("Erro ao atualizar contagem:", err));
            }
        });

        const filtroCodigo = document.getElementById('filtro-codigo');
        const filtroDescricao = document.getElementById('filtro-descricao');
        const filtroStatus = document.getElementById('filtro-status');
        const filtroData = document.getElementById("filtro-data");
        const totalItensEl = document.getElementById("total-itens");
        const sobraEstoqueEl = document.getElementById("sobra-estoque");
        const faltaEstoqueEl = document.getElementById("falta-estoque");
        const sobraPercentEl = document.getElementById('sobra-percent');
        const faltaPercentEl = document.getElementById('falta-percent');
        const analiseModal = document.getElementById('analise-modal');
        const closeModalButton = analiseModal.querySelector('.close-button');
        let graficoAnalise = null;

        // PASSO 2: Ativada a tradução na inicialização do Flatpickr
        flatpickr(filtroData, {
            locale: "pt", // Ativa a localização para português
            dateFormat: "d/m/Y",
            mode: "range", // Permite seleção de período
            onChange: function(selectedDates, dateStr, instance) {
                aplicarFiltros();
            }
        });

        function popularFiltroData() {
            const datas = new Set();
            Object.values(dadosLocais).forEach(item => {
                if (item.historico) {
                    item.historico.forEach(registro => datas.add(registro.data));
                }
            });

            const fp = filtroData._flatpickr;
            if (!fp) return;

            fp.set("enable", [
                function(date) {
                    const dataFormatada = `${('0' + date.getDate()).slice(-2)}/${('0' + (date.getMonth() + 1)).slice(-2)}/${date.getFullYear()}`;
                    return datas.has(dataFormatada);
                }
            ]);

            const datasOrdenadas = Array.from(datas).sort((a, b) => {
                const [da, ma, aa] = a.split('/').map(Number);
                const [db, mb, ab] = b.split('/').map(Number);
                return new Date(ab, mb - 1, db) - new Date(aa, ma - 1, da);
            });

            if (datasOrdenadas.length > 0 && !filtroData.value) {
                fp.setDate(datasOrdenadas[0], true);
            }
        }

        function aplicarFiltros() {
            const codigoFiltro = filtroCodigo.value.toLowerCase();
            const descricaoFiltro = filtroDescricao.value.toLowerCase();
            const statusFiltro = filtroStatus.value;
            const periodoSelecionado = filtroData.value;

            let dadosParaFiltrar = [];
            if (periodoSelecionado) {
                // Se for um período (contém " até "), dividir as datas
                if (periodoSelecionado.includes(" até ")) {
                    const [dataInicio, dataFim] = periodoSelecionado.split(" até ");
                    
                    dadosParaFiltrar = Object.keys(dadosLocais).map(codigoSeguro => {
                        const item = dadosLocais[codigoSeguro];
                        if (!item.historico) return null;
                        
                        // Filtrar registros dentro do período
                        const registrosDoPeriodo = item.historico.filter(h => {
                            const dataRegistro = h.data;
                            
                            // Converter datas para formato comparável
                            const [dReg, mReg, aReg] = dataRegistro.split('/').map(Number);
                            const [dIni, mIni, aIni] = dataInicio.split('/').map(Number);
                            const [dFim, mFim, aFim] = dataFim.split('/').map(Number);
                            
                            const dateReg = new Date(aReg, mReg - 1, dReg);
                            const dateIni = new Date(aIni, mIni - 1, dIni);
                            const dateFim = new Date(aFim, mFim - 1, dFim);
                            
                            return dateReg >= dateIni && dateReg <= dateFim;
                        });
                        
                        if (registrosDoPeriodo.length === 0) return null;
                        
                        // Usar o registro mais recente do período
                        const registroMaisRecente = registrosDoPeriodo.sort((a, b) => {
                            const [da, ma, aa] = a.data.split('/').map(Number);
                            const [db, mb, ab] = b.data.split('/').map(Number);
                            return new Date(ab, mb - 1, db) - new Date(aa, ma - 1, da);
                        })[0];
                        
                        return { codigoSeguro, ...item.info, ...registroMaisRecente };
                    }).filter(Boolean);
                } else {
                    // Se for uma data única
                    dadosParaFiltrar = Object.keys(dadosLocais).map(codigoSeguro => {
                        const item = dadosLocais[codigoSeguro];
                        if (!item.historico) return null;
                        const registro = item.historico.find(h => h.data === periodoSelecionado);
                        if (!registro) return null;
                        return { codigoSeguro, ...item.info, ...registro };
                    }).filter(Boolean);
                }
            }

            const dadosFiltrados = dadosParaFiltrar.filter(item => {
                const sobra = item.estoqueContado > item.estoqueSistema;
                const falta = item.estoqueContado < item.estoqueSistema;
                const ok = item.estoqueContado === item.estoqueSistema;
                let statusOk = true;
                if (statusFiltro === 'ok') statusOk = ok;
                else if (statusFiltro === 'sobra') statusOk = sobra;
                else if (statusFiltro === 'falta') statusOk = falta;
                return statusOk &&
                    (item.codigoOriginal.toLowerCase().includes(codigoFiltro)) &&
                    item.descricao.toLowerCase().includes(descricaoFiltro);
            });

            renderizarTabela(dadosFiltrados);
            atualizarCards(dadosFiltrados);
        }

        function renderizarTabela(dados) {
            tabelaBody.innerHTML = '';
            dados.forEach(item => {
                const tr = document.createElement('tr');
                const diferenca = item.estoqueContado - item.estoqueSistema;
                let classeCor = '';
                if (diferenca > 0) classeCor = 'sobra-estoque';
                else if (diferenca < 0) classeCor = 'falta-estoque';
                tr.innerHTML = `
                    <td>${item.codigoOriginal}</td>
                    <td>${item.descricao}</td>
                    <td>${item.prateleira}</td>
                    <td style="text-align: center;">${item.estoqueSistema}</td>
                    <td style="text-align: center;" class="${classeCor}">
                        <input type="number" class="quantidade-input" value="${item.estoqueContado}" min="0" data-codigo="${item.codigoSeguro}" data-data="${item.data}">
                    </td>
                    <td style="text-align: center; font-weight: bold;">${diferenca > 0 ? '+' : ''}${diferenca}</td>
                    <td style="text-align: center;">
                        <button class="btn-acao analise-btn" title="Analisar Histórico" data-codigo="${item.codigoSeguro}"><i data-lucide="area-chart"></i></button>
                    </td>`;
                tabelaBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function atualizarCards(dadosExibidos) {
            const totalItens = dadosExibidos.length;
            
            const sobras = dadosExibidos.filter(p => p.estoqueContado > p.estoqueSistema).length;
            const faltas = dadosExibidos.filter(p => p.estoqueContado < p.estoqueSistema).length;

            totalItensEl.textContent = totalItens;
            sobraEstoqueEl.textContent = sobras;
            faltaEstoqueEl.textContent = faltas;

            const sobraPercent = totalItens > 0 ? ((sobras / totalItens) * 100).toFixed(1) : 0;
            const faltaPercent = totalItens > 0 ? ((faltas / totalItens) * 100).toFixed(1) : 0;

            sobraPercentEl.textContent = `${sobraPercent}% do total`;
            faltaPercentEl.textContent = `${faltaPercent}% do total`;
        }

        document.getElementById('btn-download-modelo').addEventListener('click', () => {
            const csvContent = "Cod. produto,Descrição,Prateleira,Estoque Hoje Quantidade\n" +
                               "001,Produto Exemplo,A1,10\n" +
                               "002,Outro Produto,B2,5";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "modelo_inventario.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        tabelaBody.addEventListener('click', (e) => {
            if (e.target.closest('.analise-btn')) {
                const codigoSeguro = e.target.closest('.analise-btn').dataset.codigo;
                abrirModalAnalise(codigoSeguro);
            }
        });

        function abrirModalAnalise(codigoSeguro) {
            const item = dadosLocais[codigoSeguro];
            if (!item || !item.historico) return;

            const analiseInfo = document.getElementById('analise-info');
            const analiseKpis = document.getElementById('analise-kpis');
            const analiseTabelaContainer = document.getElementById('analise-tabela-container'); // Corrigido para pegar o container da tabela

            analiseInfo.innerHTML = `
                <p><strong>Código:</strong> ${item.info.codigoOriginal}</p>
                <p><strong>Descrição:</strong> ${item.info.descricao}</p>
                <p><strong>Prateleira:</strong> ${item.info.prateleira}</p>
            `;

            // Ordena o histórico do mais antigo para o mais recente para o gráfico e KPIs
            const historico = item.historico.sort((a, b) => {
                const [da, ma, aa] = a.data.split('/').map(Number);
                const [db, mb, ab] = b.data.split('/').map(Number);
                return new Date(aa, ma - 1, da) - new Date(ab, mb - 1, db);
            });

            const totalRegistros = historico.length;
            const ultimoRegistro = historico[historico.length - 1]; // Pega o registro mais recente
            const diferencaAtual = ultimoRegistro.estoqueContado - ultimoRegistro.estoqueSistema;
            const mediaEstoqueSistema = (historico.reduce((sum, h) => sum + h.estoqueSistema, 0) / totalRegistros).toFixed(1);

            analiseKpis.innerHTML = `
                <div class="kpi-card">
                    <div class="value">${totalRegistros}</div>
                    <div class="label">Total de Registros</div>
                </div>
                <div class="kpi-card">
                    <div class="value ${diferencaAtual > 0 ? 'positive' : diferencaAtual < 0 ? 'negative' : ''}">${diferencaAtual > 0 ? '+' : ''}${diferencaAtual}</div>
                    <div class="label">Diferença Atual</div>
                </div>
                <div class="kpi-card">
                    <div class="value">${mediaEstoqueSistema}</div>
                    <div class="label">Média Estoque Sistema</div>
                </div>
            `;

            // --- INÍCIO DA SEÇÃO DA TABELA DE HISTÓRICO ---
            // Ordena o histórico do mais recente para o mais antigo para exibição na tabela
            const historicoParaTabela = [...historico].sort((a, b) => {
                const [da, ma, aa] = a.data.split('/').map(Number);
                const [db, mb, ab] = b.data.split('/').map(Number);
                return new Date(ab, mb - 1, db) - new Date(aa, ma - 1, da);
            });

            let tabelaHtml = `
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: #ccc;">Últimos Registros</h4>
                <table style="width: 100%; border-collapse: collapse; background-color: #2c2f3f; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background-color: #ffffff; color: #00205b;">
                            <th style="padding: 8px; text-align: left;">Data</th>
                            <th style="padding: 8px; text-align: center;">Sistema</th>
                            <th style="padding: 8px; text-align: center;">Contado</th>
                            <th style="padding: 8px; text-align: center;">Diferença</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            historicoParaTabela.forEach(h => {
                const diff = h.estoqueContado - h.estoqueSistema;
                const rowClass = diff > 0 ? 'sobra-estoque' : diff < 0 ? 'falta-estoque' : '';
                tabelaHtml += `
                    <tr class="${rowClass}" style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">${h.data}</td>
                        <td style="padding: 8px; text-align: center;">${h.estoqueSistema}</td>
                        <td style="padding: 8px; text-align: center;">${h.estoqueContado}</td>
                        <td style="padding: 8px; text-align: center; font-weight: bold;">${diff > 0 ? '+' : ''}${diff}</td>
                    </tr>
                `;
            });

            tabelaHtml += '</tbody></table>';
            analiseTabelaContainer.innerHTML = tabelaHtml;
            // --- FIM DA SEÇÃO DA TABELA DE HISTÓRICO ---

            // --- INÍCIO DA SEÇÃO DO GRÁFICO DE PIZZA ---
            const ctx = document.getElementById('analise-grafico').getContext('2d');
            if (graficoAnalise) {
                graficoAnalise.destroy();
            }

            graficoAnalise = new Chart(ctx, {
                type: 'pie', // MUDANÇA: tipo de gráfico para 'pie'
                data: {
                    labels: ['Estoque Sistema', 'Estoque Contado'],
                    datasets: [{
                        label: 'Comparativo de Estoque (Último Registro)',
                        // Usando os dados do último registro para o gráfico de pizza
                        data: [ultimoRegistro.estoqueSistema, ultimoRegistro.estoqueContado],
                        backgroundColor: [
                            '#36a2eb', // Cor para 'Estoque Sistema'
                            '#ff6384'  // Cor para 'Estoque Contado'
                        ],
                        borderColor: '#2c2f3f',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Permite que o gráfico se ajuste melhor ao container
                    plugins: {
                        legend: {
                            position: 'top', // Posição da legenda
                            labels: { 
                                color: 'white',
                                font: { size: 14 }
                            }
                        },
                        title: { // Adiciona um título ao gráfico
                            display: true,
                            text: `Análise do dia ${ultimoRegistro.data}`,
                            color: 'white',
                            font: { size: 16 }
                        }
                    }
                }
            });
            // --- FIM DA SEÇÃO DO GRÁFICO DE PIZZA ---

            analiseModal.style.display = 'flex';
        }

        closeModalButton.addEventListener('click', () => {
            analiseModal.style.display = 'none';
        });

        analiseModal.addEventListener('click', (e) => {
            if (e.target === analiseModal) {
                analiseModal.style.display = 'none';
            }
        });

        filtroCodigo.addEventListener('input', aplicarFiltros);
        filtroDescricao.addEventListener('input', aplicarFiltros);
        filtroStatus.addEventListener('change', aplicarFiltros);

        escutarAtualizacoesInventario();
        lucide.createIcons();
    </script>
</body>
</html>

