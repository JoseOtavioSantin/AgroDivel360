<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Controle de Telemetria</title>
  <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LIBS EXTERNAS -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- CSS -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/assets/css/style.css">
  
  <style>
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: #2c3e50;
      border-radius: 12px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease;
      border-left: 4px solid #193b7c;
    }

    .stat-card:nth-child(1) {
      border-left-color: #e74c3c;
    }

    .stat-card:nth-child(2) {
      border-left-color: #f39c12;
    }

    .stat-card:nth-child(3) {
      border-left-color: #3498db;
    }

    .stat-card:nth-child(4) {
      border-left-color: #2ecc71;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-card h2 {
      font-size: 32px;
      margin: 0 0 8px 0;
      font-weight: 700;
    }

    .stat-card p {
      font-size: 14px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.95;
    }

    .acompanhamento-header {
      background: linear-gradient(135deg, #00205b 0%, #193b7c 100%);
      border-radius: 12px 12px 0 0;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .acompanhamento-header h3 {
      color: white;
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .telemetria-content {
      background: white;
      border-radius: 0 0 12px 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .filters-section {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 25px;
      align-items: center;
    }

    .filter-input, .filter-select {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      min-width: 180px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: #193b7c;
      box-shadow: 0 0 0 3px rgba(25, 59, 124, 0.1);
    }

    .actions-group {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }

    .btn-action {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      width: 42px;
      height: 42px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }

    .btn-action:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .telemetria-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .telemetria-table th,
    .telemetria-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #e8eef5;
      font-size: 14px;
      line-height: 1.6;
    }

    .telemetria-table th {
      background: linear-gradient(135deg, #193b7c 0%, #2850a0 100%);
      font-weight: 600;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(25, 59, 124, 0.15);
      white-space: nowrap;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .telemetria-table tbody tr {
      transition: all 0.2s ease;
    }

    .telemetria-table tbody tr:hover {
      background-color: #f0f7ff;
      transform: scale(1.001);
      box-shadow: 0 2px 8px rgba(25, 59, 124, 0.08);
    }

    .telemetria-table tbody tr:nth-child(even) {
      background-color: #fafbfc;
    }

    .telemetria-table tbody tr:last-child td {
      border-bottom: none;
    }

    .status-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      color: white;
      width: 100%;
      min-width: 120px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .status-select:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .status-select option {
      background-color: white;
      color: #333;
    }

    .status-pendente {
      background-color: #e74c3c;
    }

    .status-em-andamento {
      background-color: #f39c12;
    }

    .status-nao-responde {
      background-color: #f1c40f;
      color: #333;
    }

    .status-concluido {
      background-color: #2ecc71;
    }

    .whatsapp-icon {
      color: #25D366;
      cursor: pointer;
      transition: transform 0.2s;
      visibility: hidden;
    }

    .whatsapp-icon.visible {
      visibility: visible;
    }

    .whatsapp-icon:hover {
      transform: scale(1.2);
    }

    .history-icon {
      color: #3498db;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .history-icon:hover {
      transform: scale(1.2);
    }

    .editable-cell {
      cursor: text;
      border-radius: 6px;
      padding: 8px 10px;
      transition: all 0.2s ease;
      min-height: 20px;
      background-color: transparent;
    }

    .editable-cell:hover {
      background-color: #f0f7ff;
    }

    .editable-cell:focus {
      outline: 2px solid #193b7c;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(25, 59, 124, 0.1);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
      font-size: 20px;
    }

    .close-button {
      cursor: pointer;
      font-size: 28px;
      font-weight: bold;
      color: #999;
      transition: color 0.2s;
      background: none;
      border: none;
    }

    .close-button:hover {
      color: #e74c3c;
    }

    #history-list {
      list-style: none;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    #history-list li {
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      color: #333;
      border-left: 3px solid #193b7c;
    }

    .loader-overlay {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 18px;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    @media (max-width: 1200px) {
      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-cards {
        grid-template-columns: 1fr;
      }

      .filters-section {
        flex-direction: column;
      }

      .filter-input, .filter-select {
        width: 100%;
      }

      .actions-group {
        margin-left: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <nav id="sidebar-placeholder"></nav>

  <section class="home">
    <div class="text">
      <h1>Controle de Telemetria</h1>
      <p id="dynamic-title">Carregando...</p>
    </div>

    <div class="loader-overlay" id="loader-overlay">
      <div>Carregando dados...</div>
    </div>

    <div class="stats-cards">
      <div class="stat-card">
        <h2 id="total-pendentes">0</h2>
        <p><i data-lucide="alert-circle"></i> Pendentes</p>
      </div>
      <div class="stat-card">
        <h2 id="sem-conta-digital">0</h2>
        <p><i data-lucide="user-x"></i> Contas Pendentes</p>
      </div>
      <div class="stat-card">
        <h2 id="eula-vazio">0</h2>
        <p><i data-lucide="file-x"></i> EULAs Pendentes</p>
      </div>
      <div class="stat-card">
        <h2 id="total-registros">0</h2>
        <p><i data-lucide="database"></i> Total de Registros</p>
      </div>
    </div>

    <div class="acompanhamento-header">
        <h3>Acompanhamento de Telemetria</h3>
        <div class="header-actions">
          <button class="btn-action" id="btn-download-modelo" title="Baixar modelo da planilha">
            <i data-lucide="download"></i>
          </button>
          <label for="file-input" class="btn-action" style="cursor: pointer;" title="Carregar Planilha Excel">
            <i data-lucide="upload"></i>
          </label>
          <input type="file" id="file-input" accept=".xlsx, .xls" style="display:none;">
        </div>
      </div>

      <div class="telemetria-content">
        <div class="filters-section">
          <input id="filtro-chassi" type="text" class="filter-input" placeholder="Buscar chassi..." />
          <input id="filtro-cliente" type="text" class="filter-input" placeholder="Buscar cliente..." />
          <input id="filtro-modelo" type="text" class="filter-input" placeholder="Buscar modelo..." />
          
          <select id="filtro-cidade" class="filter-select">
            <option value="">Todas as Filiais</option>
            <option value="CAMPOS NOVOS">CAMPOS NOVOS</option>
            <option value="LAGES">LAGES</option>
            <option value="RIO DO SUL">RIO DO SUL</option>
            <option value="S√ÉO MIGUEL DO OESTE">S√ÉO MIGUEL DO OESTE</option>
          </select>
          
          <select id="filtro-visualizacao" class="filter-select">
            <option value="pendentes">Visualizar Pendentes</option>
            <option value="concluidos">Visualizar Conclu√≠dos</option>
            <option value="todos">Visualizar Todos</option>
          </select>
        </div>

        <div class="table-wrapper">
          <table class="telemetria-table">
            <thead>
              <tr>
                <th>Nome Cliente</th>
                <th>Chassi</th>
                <th>Filial</th>
                <th>Modelo</th>
                <th>Telefone</th>
                <th>E-mail</th>
                <th>Senha</th>
                <th style="width: 30px;">Conta?</th>
                <th style="width: 30px;">EULA?</th>
                <th style="width: 30px;">Mensagens</th>
              </tr>
            </thead>
            <tbody id="tabela-telemetria"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div id="history-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Hist√≥rico de Contatos</h3>
        <button class="close-button">&times;</button>
      </div>
      <ul id="history-list"></ul>
    </div>
  </div>

  <!-- Modal de Envio via WhatsApp -->
  <div id="email-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>üí¨ Enviar Credenciais por WhatsApp</h3>
        <button class="close-button" id="close-email-modal">&times;</button>
      </div>
      
      <div class="form-group">
        <label>Telefone:</label>
        <input type="text" id="email-destinatario" placeholder="(00) 00000-0000" readonly>
      </div>

      <div class="form-group">
        <label>Mensagem:</label>
        <textarea id="email-mensagem"></textarea>
      </div>

      <div style="display: flex; gap: 10px;">
        <button class="btn-copy" onclick="copiarCredenciais()">
          <i data-lucide="copy"></i> Copiar Texto
        </button>
        <button class="btn-send-email" onclick="enviarWhatsApp()">
          <i data-lucide="send"></i> Enviar via WhatsApp
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts Globais -->
  <script type="module" src="/assets/js/firebase-config.js"></script>
  <script type="module" src="/assets/js/auth-guard.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/components/Sidebar.js"></script>

  <script type="module">
  import { garantirAutenticacao } from '/assets/js/auth-guard.js';
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  let db;
  let userData;
  let telemetriaCollection;

  async function iniciarPagina() {
    try {
      userData = await garantirAutenticacao();
      const app = getApp();
      db = getFirestore(app);
      telemetriaCollection = collection(db, "telemetria");
      
      // Verificar se usu√°rio tem filiais associadas
      if (!userData.filial || userData.filial.length === 0) {
        document.body.innerHTML = `<div class="error-container">Acesso negado. Nenhuma filial associada.</div>`;
        return;
      }
      
      lucide.createIcons();

    const tabelaBody = document.getElementById('tabela-telemetria');
    const loaderOverlay = document.getElementById('loader-overlay');
    const historyModal = document.getElementById('history-modal');
    const historyList = document.getElementById('history-list');
    const closeModalButton = historyModal.querySelector('.close-button');
    
    let dadosCompletos = [];
    let dadosFiltrados = [];

    const fileInput = document.getElementById('file-input');
    const totalPendentesEl = document.getElementById('total-pendentes');
    const semContaDigitalEl = document.getElementById('sem-conta-digital');
    const eulaVazioEl = document.getElementById('eula-vazio');
    const totalRegistrosEl = document.getElementById('total-registros');
    const filtroChassi = document.getElementById('filtro-chassi');
    const filtroCliente = document.getElementById('filtro-cliente');
    const filtroModelo = document.getElementById('filtro-modelo');
    const filtroCidade = document.getElementById('filtro-cidade');
    const filtroVisualizacao = document.getElementById('filtro-visualizacao');

    // Filiais do usu√°rio logado
    const filiaisLogadas = userData.filial || [];
    
    // Atualizar t√≠tulo com filiais do usu√°rio
    document.getElementById('dynamic-title').textContent = `Filiais: ${filiaisLogadas.join(", ")}`;
      
    // Atualizar op√ß√µes do select de filial
    filtroCidade.innerHTML = '<option value="">Todas as Filiais</option>';
    filiaisLogadas.forEach(filial => {
      const option = document.createElement('option');
      option.value = filial.toLowerCase();
      option.textContent = filial;
      filtroCidade.appendChild(option);
    });

    async function carregarDadosDoFirebase() {
        loaderOverlay.style.display = 'flex';
        
        const querySnapshot = await getDocs(telemetriaCollection);
        const filiaisDoUsuarioLowerCase = filiaisLogadas.map(f => f.toLowerCase().trim());
        
        // Filtrar apenas registros das filiais do usu√°rio
        dadosCompletos = [];
        querySnapshot.forEach(docItem => {
          const dados = { id: docItem.id, ...docItem.data() };
          const filialDoDocumento = (dados.cidade || "").toLowerCase().trim();
          if (filiaisDoUsuarioLowerCase.includes(filialDoDocumento)) {
            dadosCompletos.push(dados);
          }
        });
        
        aplicarFiltros();
        loaderOverlay.style.display = 'none';
    }

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;
      loaderOverlay.style.display = 'flex';
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: false });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
          const chassisExistentes = new Set(dadosCompletos.map(d => d.chassi));
          let novosRegistros = 0;
          let ignorados = 0;

          for (const row of jsonData) {
            const chassi = row['Chassi /Chasi'];
            if (!chassi) continue;
            if (chassisExistentes.has(chassi)) {
              ignorados++;
              continue;
            }

            const contaDigital = row['Conta Digital do Cliente? / ¬øCuenta Digital del Cliente?'];
            const eula = row['Eula Respondido / Eula Respondio'];
            const cidade = row['Cidade / Ciudad'] || '-';

            const contaPendente = !contaDigital || String(contaDigital).trim() === '' || String(contaDigital).toLowerCase().trim() === 'n√£o';
            const eulaPendente = !eula || String(eula).trim() === '' || String(eula).toLowerCase() === 'nan';

            const novoRegistro = {
              dataEntrega: row['Data da Entrega / Fecha de Entrega'] || '-',
              chassi: chassi,
              cidade: cidade,
              nomeCliente: '',
              telefone: '',
              modelo: row['Modelo do Ve√≠culo / Modelo de Veh√≠culo'] || '-',
              statusConta: contaPendente ? 'Pendente' : 'Conclu√≠do',
              statusEula: eulaPendente ? 'Pendente' : 'Conclu√≠do',
              historicoContato: []
            };

            await addDoc(telemetriaCollection, novoRegistro);
            novosRegistros++;
          }
          
          Swal.fire({
            icon: 'success',
            title: 'Importa√ß√£o Conclu√≠da',
            html: `<strong>${novosRegistros}</strong> novos registros adicionados.<br><strong>${ignorados}</strong> registros existentes ignorados.`,
            confirmButtonColor: '#193b7c'
          });
          await carregarDadosDoFirebase();

        } catch (error) {
          console.error("Erro ao processar o arquivo:", error);
          Swal.fire({
            icon: 'error',
            title: 'Erro na Importa√ß√£o',
            text: 'Erro ao processar o arquivo. Verifique o formato.',
            confirmButtonColor: '#193b7c'
          });
        } finally {
          loaderOverlay.style.display = 'none';
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function aplicarFiltros() {
      const chassiFiltro = filtroChassi.value.toLowerCase();
      const clienteFiltro = filtroCliente.value.toLowerCase();
      const modeloFiltro = filtroModelo.value.toLowerCase();
      const cidadeFiltro = filtroCidade.value.toLowerCase();
      const visualizacao = filtroVisualizacao.value;

      dadosFiltrados = dadosCompletos.filter(registro => {
        const isConcluido = registro.statusConta === 'Conclu√≠do' && registro.statusEula === 'Conclu√≠do';
        
        let condicaoVisualizacao;
        if (visualizacao === 'pendentes') condicaoVisualizacao = !isConcluido;
        else if (visualizacao === 'concluidos') condicaoVisualizacao = isConcluido;
        else condicaoVisualizacao = true;

        const condicaoCidade = cidadeFiltro === '' || (registro.cidade || '').toLowerCase() === cidadeFiltro;

        return condicaoVisualizacao &&
               condicaoCidade &&
               (registro.chassi || '').toLowerCase().includes(chassiFiltro) &&
               (registro.nomeCliente || '').toLowerCase().includes(clienteFiltro) &&
               (registro.modelo || '').toLowerCase().includes(modeloFiltro);
      });

      renderizarTabela();
      atualizarCards();
    }

    function renderizarTabela() {
      tabelaBody.innerHTML = '';
      
      dadosFiltrados.forEach((registro) => {
        const tr = document.createElement('tr');
        tr.dataset.id = registro.id;
        const hasNumber = String(registro.telefone).replace(/\D/g, '').length > 0;
        const contaDigital = registro.statusConta === 'Conclu√≠do' ? 'Sim' : 'N√£o';
        const eula = registro.statusEula === 'Conclu√≠do' ? 'Sim' : 'N√£o';
        
        tr.innerHTML = `
          <td contenteditable="true" data-field="nomeCliente" class="editable-cell">${registro.nomeCliente || ''}</td>
          <td>${registro.chassi}</td>
          <td>${registro.cidade || '-'}</td>
          <td>${registro.modelo}</td>
          <td contenteditable="true" data-field="telefone" class="editable-cell">${registro.telefone || ''}</td>
          <td contenteditable="true" data-field="email" class="editable-cell">${registro.email || ''}</td>
          <td contenteditable="true" data-field="senha" class="editable-cell">${registro.senha || ''}</td>
          <td>
            <select class="status-select-simples" data-field="statusConta">
              <option value="N√£o">N√£o</option>
              <option value="Sim">Sim</option>
            </select>
          </td>
          <td>
            <select class="status-select-simples" data-field="statusEula">
              <option value="N√£o">N√£o</option>
              <option value="Sim">Sim</option>
            </select>
          </td>
          <td style="display: flex; gap: 8px; justify-content: center;">
            <button class="btn-acao-tabela" data-acao="solicitar" title="Solicitar e-mail para cadastro">
              <i data-lucide="mail-plus"></i>
            </button>
            <button class="btn-acao-tabela" data-acao="credenciais" title="Enviar credenciais de acesso">
              <i data-lucide="key-round"></i>
            </button>
          </td>`;
        tabelaBody.appendChild(tr);

        const selectConta = tr.querySelector('select[data-field="statusConta"]');
        selectConta.value = contaDigital;

        const selectEula = tr.querySelector('select[data-field="statusEula"]');
        selectEula.value = eula;
      });
      lucide.createIcons();
      adicionarEventosTabela();
    }

    async function atualizarDocumento(id, campo, valor) {
        const docRef = doc(db, "telemetria", id);
        await updateDoc(docRef, { [campo]: valor });
    }

    function adicionarEventosTabela() {
      tabelaBody.querySelectorAll('tr').forEach(row => {
        const id = row.dataset.id;
        const registro = dadosCompletos.find(d => d.id === id);
        if (!registro) return;

        // Evento para nome do cliente
        row.querySelector('td[data-field="nomeCliente"]').addEventListener('blur', async (e) => {
            const value = e.target.textContent.trim();
            if (registro.nomeCliente !== value) {
                registro.nomeCliente = value;
                await atualizarDocumento(id, 'nomeCliente', value);
            }
        });

        // Evento para telefone
        row.querySelector('td[data-field="telefone"]').addEventListener('blur', async (e) => {
            const value = e.target.textContent.trim();
            if (registro.telefone !== value) {
                registro.telefone = value;
                await atualizarDocumento(id, 'telefone', value);
            }
        });

        // Evento para email
        row.querySelector('td[data-field="email"]').addEventListener('blur', async (e) => {
          const value = e.target.textContent.trim();
          if (registro.email !== value) {
            registro.email = value;
            await atualizarDocumento(id, 'email', value);
          }
        });

        // Evento para senha
        row.querySelector('td[data-field="senha"]').addEventListener('blur', async (e) => {
          const value = e.target.textContent.trim();
          if (registro.senha !== value) {
            registro.senha = value;
            await atualizarDocumento(id, 'senha', value);
          }
        });

        // Eventos para selects Sim/N√£o
        row.querySelectorAll('.status-select-simples').forEach(select => {
          select.addEventListener('change', async () => {
            const field = select.dataset.field;
            const value = select.value;
            const dbValue = value === 'Sim' ? 'Conclu√≠do' : 'Pendente';
            
            if (field === 'statusConta') {
              registro.statusConta = dbValue;
              await atualizarDocumento(id, 'statusConta', dbValue);
            } else if (field === 'statusEula') {
              registro.statusEula = dbValue;
              await atualizarDocumento(id, 'statusEula', dbValue);
            }
            
            aplicarFiltros();
          });
        });

        // Bot√µes de a√ß√£o
        const btnSolicitar = row.querySelector('button[data-acao="solicitar"]');
        const btnCredenciais = row.querySelector('button[data-acao="credenciais"]');

        btnSolicitar.addEventListener('click', () => {
          enviarMensagemSolicitacao(registro);
        });

        btnCredenciais.addEventListener('click', () => {
          enviarCredenciaisWhatsApp(registro);
        });
      });
    }

    function atualizarCorSelect(select) {
      select.className = 'status-select'; // Reseta a classe
      switch (select.value) {
        case 'Pendente': select.classList.add('status-pendente'); break;
        case 'Em Andamento': select.classList.add('status-em-andamento'); break;
        case 'Cliente n√£o responde': select.classList.add('status-nao-responde'); break;
        case 'Conclu√≠do': select.classList.add('status-concluido'); break;
      }
    }

    function atualizarCards() {
        const totalRegistros = dadosFiltrados.length;
        const contaConcluida = dadosFiltrados.filter(r => r.statusConta === 'Conclu√≠do').length;
        const eulaConcluida = dadosFiltrados.filter(r => r.statusEula === 'Conclu√≠do').length;
        const totalPendentes = dadosFiltrados.filter(r => r.statusConta !== 'Conclu√≠do' || r.statusEula !== 'Conclu√≠do').length;
        
        totalRegistrosEl.textContent = totalRegistros;
        totalPendentesEl.textContent = totalPendentes;
        semContaDigitalEl.textContent = totalRegistros - contaConcluida;
        eulaVazioEl.textContent = totalRegistros - eulaConcluida;
    }

    function abrirModalHistorico(historico) {
      historyList.innerHTML = '';
      [...historico].reverse().forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        historyList.appendChild(li);
      });
      historyModal.style.display = 'flex';
    }

    // Vari√°vel global para guardar os dados do cliente atual
    let clienteAtual = null;

    function enviarMensagemSolicitacao(registro) {
      const telefone = registro.telefone ? registro.telefone.replace(/\D/g, '') : '';
      
      if (!telefone || telefone.length < 10) {
        Swal.fire({
          icon: 'error',
          title: 'Telefone inv√°lido',
          text: 'Por favor, preencha o telefone do cliente antes de enviar a mensagem',
          confirmButtonColor: '#193b7c'
        });
        return;
      }

      const mensagem = `Ol√° ${registro.nomeCliente || 'Cliente'}! üëã

Estamos entrando em contato para realizar o cadastro da telemetria do seu equipamento.

üöú *Equipamento:* ${registro.modelo}
üìã *Chassi:* ${registro.chassi}

Para darmos continuidade ao cadastro, precisamos de um *e-mail* que voc√™ utilize. Por favor, nos envie o e-mail que deseja cadastrar.

üìß Aguardamos seu retorno!

Atenciosamente,
*Agro Divel*`;

      const mensagemEncoded = encodeURIComponent(mensagem);
      const whatsappLink = `https://wa.me/55${telefone}?text=${mensagemEncoded}`;
      
      window.open(whatsappLink, '_blank');

      Swal.fire({
        icon: 'success',
        title: 'WhatsApp aberto!',
        text: 'Complete o envio da mensagem no WhatsApp',
        timer: 2000,
        showConfirmButton: false
      });
    }

    function enviarCredenciaisWhatsApp(registro) {
      const telefone = registro.telefone ? registro.telefone.replace(/\D/g, '') : '';
      
      if (!telefone || telefone.length < 10) {
        Swal.fire({
          icon: 'error',
          title: 'Telefone inv√°lido',
          text: 'Por favor, preencha o telefone do cliente antes de enviar as credenciais',
          confirmButtonColor: '#193b7c'
        });
        return;
      }

      if (!registro.email || !registro.senha) {
        Swal.fire({
          icon: 'error',
          title: 'Dados incompletos',
          text: 'Por favor, preencha o e-mail e senha antes de enviar as credenciais',
          confirmButtonColor: '#193b7c'
        });
        return;
      }


      const mensagem = `Ol√° ${registro.nomeCliente || 'Cliente'}! üëã\n\nSeu cadastro no sistema de telemetria foi realizado com sucesso!\nAgora voc√™ pode acessar o FieldOps da New Holland e acompanhar seu equipamento em tempo real.\n\nüîó *Acesse pelo computador:*\nhttps://fieldops.newholland.com/\n\nüì± *Baixe o aplicativo:*\n- Android: https://play.google.com/store/apps/details?id=com.cnh.newholland.fieldops&pcampaignid=web_share\n- iOS: https://apps.apple.com/us/app/new-holland-fieldops/id6503120987\n\n---\n\n*Seus dados de acesso:*\nüìß E-mail: ${registro.email}\nüîë Senha: ${registro.senha}\n\n*Equipamento:* ${registro.modelo}\n*Chassi:* ${registro.chassi}\n\n---\n\nEm caso de d√∫vidas, estamos √† disposi√ß√£o para ajudar!\nAtenciosamente,\nEquipe AgroDivel360`;

      const mensagemEncoded = encodeURIComponent(mensagem);
      const whatsappLink = `https://wa.me/55${telefone}?text=${mensagemEncoded}`;
      
      window.open(whatsappLink, '_blank');

      Swal.fire({
        icon: 'success',
        title: 'WhatsApp aberto!',
        text: 'Complete o envio das credenciais no WhatsApp',
        timer: 2000,
        showConfirmButton: false
      });
    }

    function abrirModalEmail(registro) {
      clienteAtual = registro;
      const emailModal = document.getElementById('email-modal');
      const emailDestinatario = document.getElementById('email-destinatario');
      const emailMensagem = document.getElementById('email-mensagem');

      emailDestinatario.value = registro.telefone || '';
      
      const mensagemPadrao = `Ol√° ${registro.nomeCliente || 'Cliente'}! üëã

Seguem suas credenciais de acesso ao sistema de telemetria:

üìß *E-mail:* ${registro.email}
üîë *Senha:* ${registro.senha}

üöú *Equipamento:* ${registro.modelo}
üìã *Chassi:* ${registro.chassi}

üåê Para acessar o sistema, utilize o link:
[Inserir link do sistema aqui]

üí¨ Em caso de d√∫vidas, entre em contato conosco.

Atenciosamente,
*Equipe AgroDivel360*`;

      emailMensagem.value = mensagemPadrao;
      emailModal.style.display = 'flex';
      lucide.createIcons();
    }

    function copiarCredenciais() {
      const emailMensagem = document.getElementById('email-mensagem');
      navigator.clipboard.writeText(emailMensagem.value).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Copiado!',
          text: 'Texto copiado para a √°rea de transfer√™ncia',
          timer: 2000,
          showConfirmButton: false
        });
      });
    }

    function enviarWhatsApp() {
      const telefone = document.getElementById('email-destinatario').value;
      const mensagem = document.getElementById('email-mensagem').value;

      const telefoneLimpo = telefone.replace(/\D/g, '');
      
      if (!telefoneLimpo || telefoneLimpo.length < 10) {
        Swal.fire({
          icon: 'error',
          title: 'Telefone inv√°lido',
          text: 'Por favor, informe um n√∫mero de telefone v√°lido',
          confirmButtonColor: '#193b7c'
        });
        return;
      }

      const mensagemEncoded = encodeURIComponent(mensagem);
      const whatsappLink = `https://wa.me/55${telefoneLimpo}?text=${mensagemEncoded}`;
      
      window.open(whatsappLink, '_blank');

      Swal.fire({
        icon: 'success',
        title: 'WhatsApp aberto!',
        text: 'Complete o envio da mensagem no WhatsApp',
        timer: 2500,
        showConfirmButton: false
      });

      document.getElementById('email-modal').style.display = 'none';
    }

    closeModalButton.onclick = () => { historyModal.style.display = 'none'; };
    document.getElementById('close-email-modal').onclick = () => { document.getElementById('email-modal').style.display = 'none'; };
    
    window.onclick = (event) => { 
      if (event.target == historyModal) { 
        historyModal.style.display = 'none'; 
      }
      if (event.target.id === 'email-modal') {
        event.target.style.display = 'none';
      }
    };

    filtroVisualizacao.addEventListener('change', aplicarFiltros);
    filtroChassi.addEventListener('input', aplicarFiltros);
    filtroCliente.addEventListener('input', aplicarFiltros);
    filtroModelo.addEventListener('input', aplicarFiltros);
    filtroCidade.addEventListener('change', aplicarFiltros);

    carregarDadosDoFirebase();
    
    } catch (error) {
      console.error("Falha na inicializa√ß√£o:", error);
      Swal.fire('Erro', 'Erro ao carregar p√°gina. Verifique sua autentica√ß√£o.', 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', iniciarPagina);
</script>

</body>
</html>