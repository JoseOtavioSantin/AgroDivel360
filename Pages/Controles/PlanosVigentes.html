<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Dashboard com Filtros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #1e1e2f;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background-color: #2c2f3f;
      padding: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #ffffff;
      letter-spacing: 1px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #dynamic-title {
      margin-top: 10px;
      font-size: 16px;
      font-weight: normal;
      color: #ccc;
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 250px;
      background-color: #2c2f3f;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    .card {
      padding: 20px;
      border-radius: 16px;
      color: white;
      background: linear-gradient(135deg, #2e2f4f, #1e1e2f);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .card:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .card h2 {
      font-size: 28px;
      margin: 0;
    }

    .card p {
      font-size: 14px;
      color: #eee;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pink-card    { background: linear-gradient(238deg, #193b7c, #193b7c00); }
    .orange-card  { background: linear-gradient(238deg, #193b7c, #193b7c00); }
    .blue-card    { background: linear-gradient(238deg, #193b7c, #193b7c00); }
    .purple-card  { background: linear-gradient(358deg, #626262, #62626259); }

    .content {
      flex: 1;
      padding: 30px;
      background-color: #262a3d;
      overflow-y: auto;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .filters input,
    .filters select {
      padding: 8px;
      border-radius: 6px;
      border: none;
      min-width: 180px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #2c2f3f;
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      font-size: 12px;
      padding: 10px 15px;
      text-align: left;
      border-bottom: 1px solid #444;
    }

    th {
      background-color: #ffffff;
      color: #00205b;
    }

    .acoes button {
      background: #ffffff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      color: rgb(46, 60, 250);
      cursor: pointer;
      transition: background 0.2s;
    }

    .acoes button:hover {
      background: #ffffff;
    }

    .status-em-andamento { background-color: #c67903; }
    .status-concluido { background-color: #193b7c; }
    .status-cancelado { background-color: #626262; }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main { flex-direction: column; }
      .content { padding: 15px; }
    }
  
    .btn-acao {
      background: linear-gradient(135deg, #00205b, #009bd6);
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-acao:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 187, 249, 0.4);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    #btn-exportar {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      padding: 0 10px;
    }

   .logo {
    height: 80px;
    margin-left: 45px;
    margin-right: 15px;
  }

  @media (max-width: 768px) {
    header {
      padding: 10px;
    }

    .logo {
      height: 40px;
      margin-left: 20px;
      margin-right: 15px;
    }

    #dynamic-title {
      font-size: 15px !important;
    }

    header em {
      font-size: 15px !important;
    }

    .main {
      flex-direction: column;
    }

    .sidebar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      width: 100%;
    }

    .card {
      flex: 1 1;
      min-width: 140px;
      text-align: center;
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
    }

    .card h2 {
      font-size: 22px;
    }

    .card p {
      font-size: 13px;
    }

    .filters {
      flex-direction: column;
      align-items: stretch;
    }

    .filters input,
    .filters select,
    .filters button {
      width: 100%;
      min-width: auto;
    }

    table {
      font-size: 10px;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }

    th,
    td {
      padding: 6px 10px;
    }

    #popup {
      padding: 20px;
    }
  }

  .linha-alerta {
  animation: pulsarAlerta 1.2s ease-in-out infinite alternate;
}

@keyframes pulsarAlerta {
  from {
    background-color: #950000; /* Laranja padr√£o */
  }
  to {
    background-color: #c67903; /* Laranja mais claro */
  }
}

/* üîß Estiliza a scrollbar para navegadores baseados em Webkit (Chrome, Edge, Opera, Brave...) */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #1e1e2f;
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: #009bd6;
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: #00bfff;
}

/* üîß Para Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: #009bd6 #1e1e2f;
}

</style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <img src="/assets/images/logo.png" alt="Logo" class="logo">
    <div style="flex: 1; text-align: center;">
      <em>Dashboard Agro Divel 360 - Planos Vigentes</em>
      <div id="dynamic-title" style="font-style: italic;">Carregando...</div>
    </div>
      <div style="width: 65px;"></div>
    </div>
  </header>

  <button onclick="window.history.back()" title="Voltar"
  style="
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #00205b, #009bd6);
    color: white;
    border: none;
    margin-right: 10px;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    z-index: 9999;
  ">
  ‚Üê Voltar
</button>

  <div class="main">
    <div class="sidebar">
        <div class="card blue-card">
          <h2 id="total-clientes">0</h2>
          <p><i data-lucide="users"></i> Total de Clientes</p>
        </div>

        <div class="card orange-card">
          <h2 id="em-andamento">0</h2>
          <p><i data-lucide="loader-circle"></i> Em Andamento</p>
        </div>

        <div class="card green-card">
          <h2 id="total-concluidos">0</h2>
          <p><i data-lucide="check-circle"></i> Conclu√≠dos</p>
        </div>

        <div class="card purple-card">
          <h2 id="valor-total">R$ 0,00</h2>
          <p><i data-lucide="dollar-sign"></i> Valor Total (R$)</p>
        </div>
    </div>

    <div class="content">
        <div class="filters">
          <input id="filtro-cliente" type="text" placeholder="Buscar cliente..." />
          <select id="filtro-status">
            <option value="">Todos os status</option>
            <option value="Conclu√≠do">Conclu√≠do</option>
            <option value="Em andamento">Em andamento</option>
            <option value="Cancelado">Cancelado</option>
          </select>
          <input id="filtro-consultor" type="text" placeholder="Buscar consultor..." />
          <input id="filtro-periodo" placeholder="Selecione o per√≠odo" />

        <div style="margin-left: auto; display: flex; gap: 10px;" class="acoes-topo">
          <button id="btn-exportar" class="btn-acao" title="Exportar para Excel">
            <i data-lucide="download" style="width: 20px; height: 20px;"></i>
          </button>

          <button id="btn-importar" class="btn-acao" title="Importar">
            <input type="file" id="arquivo-importar" accept=".xlsx" style="display:none;">
            <i data-lucide="upload" style="width: 20px; height: 20px;"></i>
          </button>

          <button class="btn-acao" onclick="abrirFormularioNovoPlano()" style="height: 40px;" title="Novo Plano">
            <i data-lucide="plus-circle"></i>
          </button>
        </div>

        </div>

      <table>
        <thead>
          <tr>
            <th>Data In√≠cio</th>
            <th>Data Fim</th>
            <th>Cliente</th>
            <th>Plano Vendido</th>
            <th>Chassi</th>
            <th>Modelo</th>
            <th>Horas Iniciais</th>
            <th>Horas Finais</th>
            <th>Horas Atuais</th>
            <th>Checklist</th>
          </tr>
        </thead>
        <tbody id="painel-detalhes"></tbody>
      </table>
    </div>
  </div>

  

<!-- POPUP DE A√á√ÉO -->
<div id="popup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#2c2f3f;padding:20px;border-radius:12px;width:90%;max-width:400px;">
    <h3>Atualizar Checklist</h3>
    <input type="hidden" id="docIdSelecionado">
    <label>Coment√°rio do Respons√°vel</label>
    <textarea id="comentario" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;"></textarea>
    <label>Status</label>
    <select id="statusChecklist" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">
      <option value="Em andamento">Em andamento</option>
      <option value="Conclu√≠do">Conclu√≠do</option>
      <option value="Cancelado">Cancelado</option>
    </select>
    <label>Valor Negociado (R$)</label>
    <input type="number" id="valorNegociado" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">
    <div style="text-align:right;">
      <button onclick="salvarPopup()" style="background:#00205b;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;">Salvar</button>
      <button onclick="fecharPopup()" style="background:#444;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;margin-left:10px;">Cancelar</button>
    </div>
  </div>
</div>

<!-- SEGUNDO POPUP: Dados de Conclus√£o -->
<div id="popupConclusao" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#2c2f3f;padding:20px;border-radius:12px;width:90%;max-width:450px;">
    <h3>Dados do Contrato Conclu√≠do</h3>

    <label>Chassi</label>
    <input type="text" id="chassiFinal" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Horas Iniciais</label>
    <input type="number" id="horasIniciais" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Horas Finais</label>
    <input type="number" id="horasFinais" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Data Inicial do Contrato</label>
    <input type="date" id="dataInicioContrato" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Data Final do Contrato</label>
    <input type="date" id="dataFimContrato" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <div style="text-align:right;">
      <button onclick="salvarConclusao()" style="background:#00205b;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;">Salvar</button>
      <button onclick="fecharPopupConclusao()" style="background:#444;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;margin-left:10px;">Cancelar</button>
    </div>
  </div>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    query,
    where,
    doc,
    getDoc,
    updateDoc,
    addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const tipoChecklist = "planosVigentes";
  window.tipoChecklist = tipoChecklist;

  const app = initializeApp({
    apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
    authDomain: "agro-divel.firebaseapp.com",
    projectId: "agro-divel"
  });

  const db = getFirestore(app);
  let dadosTotais = [];

  document.getElementById("dynamic-title").textContent =
    tipoChecklist === "checklistComercial" ? "Comercial" :
    tipoChecklist === "checklistRevisao" ? "Revis√£o" :
    tipoChecklist === "checklistPecas" ? "Pe√ßas" : "Painel";

  async function carregarFiliaisDoGestor() {
    const emailGestor = localStorage.getItem("gestorEmail") || "";
    if (!emailGestor) return;

    const gestoresRef = collection(db, "gestores");
    const q = query(gestoresRef, where("email", "==", emailGestor));
    const snapshot = await getDocs(q);

    if (!snapshot.empty) {
      const dados = snapshot.docs[0].data();
      const filiais = dados.filial || [];
      localStorage.setItem("gestorFilial", JSON.stringify(filiais));
      document.getElementById("dynamic-title").textContent = `Filiais: ${filiais.join(", ")}`;
      carregarDados();
    } else {
      alert("Gestor n√£o encontrado no banco.");
    }
  }

  async function carregarDados() {
    const querySnapshot = await getDocs(collection(db, tipoChecklist));
    dadosTotais = [];

    const filiaisLogadas = JSON.parse(localStorage.getItem("gestorFilial") || "[]");

    querySnapshot.forEach(docItem => {
      const dados = docItem.data();
      if (filiaisLogadas.map(f => f.toLowerCase().trim()).includes((dados.filial || "").toLowerCase().trim())) {
        dadosTotais.push({ id: docItem.id, ...dados });
      }
    });

    console.log("Total encontrado:", dadosTotais.length, dadosTotais);
    aplicarFiltros();
  }

function aplicarFiltros() {
  const clienteFiltro = document.getElementById("filtro-cliente").value.toLowerCase();
  const statusFiltro = document.getElementById("filtro-status").value;
  const consultorFiltro = document.getElementById("filtro-consultor").value.toLowerCase();

  const instance = document.getElementById("filtro-periodo")._flatpickr;
  const selectedDates = instance ? instance.selectedDates : [];

  let dataInicio = "", dataFim = "";
  if (selectedDates.length === 2) {
    dataInicio = selectedDates[0].toISOString().slice(0, 10);
    dataFim = selectedDates[1].toISOString().slice(0, 10);
  } else if (selectedDates.length === 1) {
    dataInicio = dataFim = selectedDates[0].toISOString().slice(0, 10);
  }

  const painel = document.getElementById("painel-detalhes");
  painel.innerHTML = "";

  const filtrados = dadosTotais.filter(d => {
    const cliente = (d.nomeCliente || "").toLowerCase();
    const totalChecklist = (d.checklistRealizado || []).length;
    const preenchidos = (d.checklistRealizado || []).filter(item => {
      const dados = (d.datasChecklist || {})[item];
      return dados && dados.os && dados.data;
    });
    const statusChecklistAuto = totalChecklist > 0 && preenchidos.length === totalChecklist ? "Conclu√≠do" : "Em andamento";
    d.statusChecklist = statusChecklistAuto;

    const status = statusChecklistAuto;
    const consultor = (d.consultor || "").toLowerCase();
    const dataFormatada = d.dataInicioContrato || "";

    const dentroDoPeriodo =
      (!dataInicio && !dataFim) ||
      (
        (!dataInicio || dataFormatada >= dataInicio) &&
        (!dataFim || dataFormatada <= dataFim)
      );

    return cliente.includes(clienteFiltro) &&
      (statusFiltro === "" || status === statusFiltro) &&
      consultor.includes(consultorFiltro) &&
      dentroDoPeriodo;
  });

  // üî¢ Contagens
  const total = filtrados.length;
  const concluidos = filtrados.filter(d => {
    const totalChecklist = (d.checklistRealizado || []).length;
    const preenchidos = (d.checklistRealizado || []).filter(item => {
      const dados = (d.datasChecklist || {})[item];
      return dados && dados.os && dados.data;
    });
    return totalChecklist > 0 && preenchidos.length === totalChecklist;
  }).length;
  const cancelados = filtrados.filter(d => d.statusChecklist === "Cancelado").length;
  const andamento = total - concluidos - cancelados;

  document.getElementById("total-clientes").textContent = total;
  document.getElementById("total-concluidos").textContent = concluidos;
  document.getElementById("em-andamento").textContent = andamento;

  // üí≤ Valor total
  let totalValor = 0;
  filtrados.forEach(d => {
    const preco = typeof d.valorNegociado === "number" ? d.valorNegociado : parseFloat(d.valorNegociado);
    if (!isNaN(preco)) totalValor += preco;
  });
  document.getElementById("valor-total").textContent = totalValor.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });

// üîÅ Ordenar: Conclu√≠dos por √∫ltimo, alertas no topo
filtrados.sort((a, b) => {
  const statusOrder = (status) => status === "Conclu√≠do" ? 1 : 0;
  const alertaA = alertaDoItem(a);
  const alertaB = alertaDoItem(b);

  // Primeiro ordena por status (conclu√≠do vai para o final), depois por alerta (alerta vai para o topo)
  if (statusOrder(a.statusChecklist) !== statusOrder(b.statusChecklist)) {
    return statusOrder(a.statusChecklist) - statusOrder(b.statusChecklist);
  }

  return alertaB - alertaA;
});

  // üß† Fun√ß√£o para checar se item tem alerta
  function alertaDoItem(d) {
    const horasAtuais = parseFloat(d.horasAtuais || 0);
    const checklistsPendentes = (d.checklistRealizado || []).filter(item => !(d.datasChecklist || {})[item]);
    return checklistsPendentes.some(item => {
      const horasChecklist = parseFloat(item);
      return !isNaN(horasChecklist) && horasAtuais >= (horasChecklist - 60);
    }) ? 1 : 0;
  }

  // üñºÔ∏è Renderizar linhas
  filtrados.forEach(d => {
    const totalChecklist = (d.checklistRealizado || []).length;
    const preenchidos = (d.checklistRealizado || []).filter(item => (d.datasChecklist || {})[item]);
    const statusChecklistAuto = totalChecklist > 0 && preenchidos.length === totalChecklist ? "Conclu√≠do" : "Em andamento";
    const statusClass = statusChecklistAuto === "Conclu√≠do" ? "status-concluido" : "status-em-andamento";

    const horasAtuais = parseFloat(d.horasAtuais || 0);
    const checklistsPendentes = (d.checklistRealizado || []).filter(item => !(d.datasChecklist || {})[item]);
    const alerta = checklistsPendentes.some(item => {
      const horasChecklist = parseFloat(item);
      return !isNaN(horasChecklist) && horasAtuais >= (horasChecklist - 60);
    });
    const alertaClass = alerta ? "linha-alerta" : "";

    const checklistOrdenado = [...(d.checklistRealizado || [])];

// Coloca "√ìLEO" primeiro se existir
checklistOrdenado.sort((a, b) => {
  if (a === "√ìLEO") return -1;
  if (b === "√ìLEO") return 1;
  return parseFloat(a) - parseFloat(b);
});

const checklistHtml = checklistOrdenado.map(item => {
  const infoChecklist = (d.datasChecklist || {})[item];
  let dataFormatada = "";
  let osInfo = "";

  if (typeof infoChecklist === "object" && infoChecklist !== null) {
    dataFormatada = formatarDataBR(infoChecklist.data);
    osInfo = infoChecklist.os ? ` - OS.${infoChecklist.os}` : "";
  } else {
    dataFormatada = formatarDataBR(infoChecklist);
  }

  const isOleo = item === "√ìLEO";
  const corFundo = infoChecklist
    ? (isOleo ? '#006666' : '#4caf50') // Verde normal ou azul petr√≥leo se for √≥leo
    : '#fff';

  const corTexto = infoChecklist ? '#fff' : (isOleo ? '#006666' : '#00205b');

  const iconeOleo = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" style="margin-right:4px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path d="M12 3c.8 2.5 4 5.3 4 8.1a4 4 0 0 1-8 0c0-2.8 3.2-5.6 4-8.1Z"/>
    <path d="M9 21h6"/>
  </svg>`;

  const label = isOleo ? `${iconeOleo}`: item;

  return `<button 
    onclick="abrirDataChecklist('${d.id}','${item}','${infoChecklist?.data || infoChecklist || ''}', '${infoChecklist?.os || ''}')"
    style="background:${corFundo}; color:${corTexto}; padding:3px 8px; border:none; border-radius:5px; margin:2px; font-size:10px; cursor:pointer; display:flex; align-items:center; gap:4px;"
    ${infoChecklist ? 'disabled' : ''}
  >${label}${osInfo}${dataFormatada ? ` - ${dataFormatada}` : ''}</button>`;
}).join("");

    painel.innerHTML += `
      <tr class="${statusClass} ${alertaClass}">
        <td>${formatarDataBR(d.dataInicioContrato)}</td>
        <td>${formatarDataBR(d.dataFimContrato)}</td>
        <td>${d.nomeCliente || "-"}</td>
        <td>${d.planoVendido || "-"}</td>
        <td>${d.chassi || "-"}</td>
        <td>${d.modelo || "-"}</td>
        <td>${d.horasIniciais || "-"}</td>
        <td>${d.horasFinais || "-"}</td>
        <td>
          ${d.horasAtuais || "-"}
          ${alerta ? `<span title="Checklist se aproxima" style="color: orange; margin-left: 6px;">‚ö†Ô∏è</span>` : ""}
        </td>
        <td>${checklistHtml}</td>
      </tr>`;
  });
}


  // Expor Firebase e fun√ß√µes necess√°rias para os outros scripts
  window.db = db;
  window.doc = doc;
  window.getDoc = getDoc;
  window.updateDoc = updateDoc;
  window.addDoc = addDoc;
  window.collection = collection;
  window.carregarFiliaisDoGestor = carregarFiliaisDoGestor;
  window.carregarDados = carregarDados;

  async function abrirPopup(id) {
    document.getElementById("popup").style.display = "flex";
    document.getElementById("docIdSelecionado").value = id;
    const docRef = doc(db, tipoChecklist, id);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const dados = docSnap.data();
      document.getElementById("comentario").value = dados.comentarioResponsavel || "";
      document.getElementById("statusChecklist").value = dados.statusChecklist || "Em andamento";
      document.getElementById("valorNegociado").value = dados.valorNegociado || "";
    }
  }
  

  function fecharPopup() {
    document.getElementById("popup").style.display = "none";
  }

  async function salvarPopup() {
    const id = document.getElementById("docIdSelecionado").value;
    const comentario = document.getElementById("comentario").value;
    const status = document.getElementById("statusChecklist").value;
    const valor = parseFloat(document.getElementById("valorNegociado").value) || 0;
    const docRef = doc(db, tipoChecklist, id);
    await updateDoc(docRef, {
      comentarioResponsavel: comentario,
      statusChecklist: status,
      valorNegociado: valor
    });

    fecharPopup();

    if (status === "Conclu√≠do") {
      // Abre o segundo popup
      document.getElementById("popupConclusao").style.display = "flex";
    } else {
      carregarDados(); // s√≥ recarrega se n√£o for conclu√≠do
    }

  }

  window.fecharPopup = fecharPopup;
  window.salvarPopup = salvarPopup;

  async function salvarConclusao() {
  const id = document.getElementById("docIdSelecionado").value;

  // Busca os dados originais do checklist (nome do cliente e outros)
  const docRefOriginal = doc(db, tipoChecklist, id);
  const docSnap = await getDoc(docRefOriginal);
  if (!docSnap.exists()) {
    alert("Erro: n√£o foi poss√≠vel encontrar os dados originais.");
    return;
  }

  const dadosOriginais = docSnap.data();
  const nomeCliente = dadosOriginais.nomeCliente || "";
  const consultor = dadosOriginais.consultor || "";
  const planoVendido = dadosOriginais.planoVendido || "";
  const modelo = dadosOriginais.modelo || "";
  const fazenda = dadosOriginais.nomeFazenda || "";

  // Dados do segundo popup
  const chassi = document.getElementById("chassiFinal").value;
  const horasIni = parseFloat(document.getElementById("horasIniciais").value) || 0;
  const horasFim = parseFloat(document.getElementById("horasFinais").value) || 0;
  const dataInicio = document.getElementById("dataInicioContrato").value;
  const dataFim = document.getElementById("dataFimContrato").value;

  const checkboxes = document.querySelectorAll('#popupConclusao input[type="checkbox"]:checked');
  const checklistRealizado = Array.from(checkboxes).map(cb => cb.value);

  // Salva na cole√ß√£o `planosVigentes`
  const novaEntrada = {
    nomeCliente,
    consultor,
    PlanoVendido,
    modelo,
    fazenda,
    chassi,
    horasIniciais: horasIni,
    horasFinais: horasFim,
    dataInicioContrato: dataInicio,
    dataFimContrato: dataFim,
    checklistRealizado,
    dataCriacao: new Date().toISOString()
  };

  await addDoc(collection(db, "planosVigentes"), novaEntrada);

  fecharPopupConclusao();
  carregarDados(); // Atualiza a tela
  
}


function fecharPopupConclusao() {
  document.getElementById("popupConclusao").style.display = "none";
}

window.salvarConclusao = salvarConclusao;
window.fecharPopupConclusao = fecharPopupConclusao;
window.abrirPopup = abrirPopup;

    
  document.addEventListener("DOMContentLoaded", () => {
  carregarFiliaisDoGestor();
  lucide.createIcons();

  document.getElementById("filtro-cliente").addEventListener("input", aplicarFiltros);
  document.getElementById("filtro-status").addEventListener("change", aplicarFiltros);
  document.getElementById("filtro-consultor").addEventListener("input", aplicarFiltros);

  flatpickr("#filtro-periodo", {
    mode: "range",
    dateFormat: "Y-m-d",
    locale: "pt",
    onChange: aplicarFiltros
  });

  // ‚è± Atualizar automaticamente a cada 60 segundos
  setInterval(() => {
    console.log("Atualizando dados do painel...");
    carregarDados();
  }, 60000); // 1 minuto
});
//Fun√ß√£o exportar.

document.getElementById("btn-exportar").addEventListener("click", () => {
  const headers = [
    "Data In√≠cio", "Data Fim", "Cliente", "Chassi", "Modelo",
    "Horas Iniciais", "Horas Finais", "Horas Atuais", "Checklist"
  ];

  const linhas = Array.from(document.querySelectorAll("#painel-detalhes tr")).map(tr => {
    const tds = tr.querySelectorAll("td");
    return [
    tds[0]?.textContent.trim(), // Data In√≠cio
    tds[1]?.textContent.trim(), // Data Fim
    tds[2]?.textContent.trim(), // Cliente
    tds[3]?.textContent.trim(), // Consultor
    tds[4]?.textContent.trim(), // Fazenda
    tds[5]?.textContent.trim(), // Munic√≠pio
    tds[6]?.textContent.trim(), // Modelo
    tds[7]?.textContent.trim(), // Horas Iniciais
    tds[8]?.textContent.trim(), // Horas Finais
    tds[9]?.innerText.trim()    // Checklist
    ];
  });

  const planilha = XLSX.utils.aoa_to_sheet([headers, ...linhas]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, planilha, "Checklist");

  XLSX.writeFile(wb, "checklists_filtrados.xlsx");
});


//script importar

document.getElementById("btn-importar").addEventListener("click", () => {
  document.getElementById("arquivo-importar").click();
});

document.getElementById("arquivo-importar").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const loading = document.getElementById("loadingImport");
  loading.style.display = "flex"; // Mostrar overlay escuro

  const reader = new FileReader();
  reader.onload = async function (e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const registros = XLSX.utils.sheet_to_json(sheet);

      let atualizados = 0;

      for (const linha of registros) {
        const chassi = String(linha["PIN"] || "").trim();
        const horas = parseFloat(String(linha["Horas totais do motor"]).replace(",", "."));

        if (!chassi || isNaN(horas)) continue;

        const q = query(collection(db, "planosVigentes"), where("chassi", "==", chassi));
        const snapshot = await getDocs(q);

        if (snapshot.empty) continue;

        for (const docSnap of snapshot.docs) {
          const ref = doc(db, "planosVigentes", docSnap.id);
          await updateDoc(ref, { horasAtuais: horas });
          atualizados++;
        }
      }

      alert(`‚úÖ Importa√ß√£o conclu√≠da.\n\nüîÑ Atualizados: ${atualizados}`);
      carregarDados(); // Atualiza a tabela

    } catch (err) {
      alert("‚ùå Erro durante a importa√ß√£o: " + err.message);
    } finally {
      loading.style.display = "none"; // Esconde o overlay
    }
  };

  reader.readAsArrayBuffer(file);
});

//fim import


//fim type="module">
</script>

  <script>
  if (localStorage.getItem("gestorLogado") !== "true") {
    alert("Acesso restrito! Fa√ßa login como gestor.");
    window.location.href = "index.html";
  } else {
    const filiais = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
    document.getElementById("dynamic-title").textContent = `Filiais: ${filiais.join(", ") || "Desconhecida"}`;
  }
</script> 

<script>
function abrirFormularioNovoPlano() {
  document.getElementById("popupNovoPlano").style.display = "flex";
}

function fecharNovoPlano() {
  document.getElementById("popupNovoPlano").style.display = "none";
}

async function buscarPrimeiraFilialDoGestor() {
  try {
    // Pega o email salvo no login do gestor
    const emailGestor = localStorage.getItem("gestorEmail") || "";

    // Se n√£o tiver email no localStorage, tenta o primeiro doc do Firestore via t√≠tulo/fluxo atual
    if (!emailGestor) {
      // fallback r√°pido para n√£o travar: usa localStorage gestorFilial (se existir)
      const filiaisLS = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
      return filiaisLS[0] || "N√£o informado";
    }

    // Busca no Firestore a cole√ß√£o "gestores" pelo e-mail
    const gestoresRef = collection(db, "gestores");
    const q = query(gestoresRef, where("email", "==", emailGestor));
    const snapshot = await getDocs(q);

    if (!snapshot.empty) {
      const dados = snapshot.docs[0].data();
      const filiais = Array.isArray(dados.filial) ? dados.filial : [];
      // guarda em localStorage para reuso
      localStorage.setItem("gestorFilial", JSON.stringify(filiais));
      return filiais[0] || "N√£o informado";
    }

    // se n√£o encontrou no banco, tenta localStorage
    const filiaisLS = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
    return filiaisLS[0] || "N√£o informado";
  } catch (e) {
    // fallback final
    const filiaisLS = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
    return filiaisLS[0] || "N√£o informado";
  }
}

async function salvarNovoPlano() {
  const nomeCliente = document.getElementById("novoCliente").value.trim();
  const planoVendido = document.getElementById("novoPlanoVendido").value.trim();
  const modelo = document.getElementById("novoModelo").value.trim();
  const chassi = document.getElementById("novoChassi").value.trim();
  const horasIniciais = parseFloat(document.getElementById("novoHorasIni").value) || 0;
  const horasFinais = parseFloat(document.getElementById("novoHorasFim").value) || 0;
  const dataInicioContrato = document.getElementById("novoDataIni").value;
  const dataFimContrato = document.getElementById("novoDataFim").value;
  const valorNegociado = parseFloat(document.getElementById("novoValorNegociado").value) || 0;

  // coleta checklists marcados
  const checkboxes = document.querySelectorAll(".checklistNovoPlano:checked");
  // normaliza valores para manter padr√£o (ex.: "√ìLEO" em mai√∫sculas)
  const checklistRealizado = Array.from(checkboxes).map(cb => {
    const v = String(cb.value || "").trim();
    return (v.toUpperCase() === "√ìLEO" || v.toUpperCase() === "OLEO") ? "√ìLEO" : v;
  });

  // üîë filial: pega do Firestore (gestores) e usa sempre a PRIMEIRA
  const filial = await buscarPrimeiraFilialDoGestor();

  const novoPlano = {
    nomeCliente,
    planoVendido,
    modelo,
    chassi,
    horasIniciais,
    horasFinais,
    dataInicioContrato,
    dataFimContrato,
    checklistRealizado,
    datasChecklist: {},
    statusChecklist: "Em andamento",
    valorNegociado,
    comentarioResponsavel: "",
    dataCriacao: new Date().toISOString(),
    filial
  };

  await addDoc(collection(db, "planosVigentes"), novoPlano);

  fecharNovoPlano();
  carregarDados();
  limparFormularioNovoPlano();
}

function limparFormularioNovoPlano() {
  document.getElementById("novoCliente").value = "";
  document.getElementById("novoPlanoVendido").value = "";
  document.getElementById("novoModelo").value = "";
  document.getElementById("novoChassi").value = "";
  document.getElementById("novoHorasIni").value = "";
  document.getElementById("novoHorasFim").value = "";
  document.getElementById("novoDataIni").value = "";
  document.getElementById("novoDataFim").value = "";
  document.getElementById("novoValorNegociado").value = "";

  // Desmarca todos os checkboxes
  const checkboxes = document.querySelectorAll(".checklistNovoPlano");
  checkboxes.forEach(cb => cb.checked = false);

  // Remove checklists adicionados manualmente
  const container = document.getElementById("checklist-container");
  const fixos = ["√ìLEO", "50", "100", "300", "600", "900", "1200"];
  container.querySelectorAll("input[type='checkbox']").forEach(cb => {
    if (!fixos.includes(cb.value)) {
      cb.parentElement.remove(); // remove o <label> inteiro
    }
  });

  // Limpa campo de input manual (caso tenha esse ID no popup)
  const campoManual = document.getElementById("inputChecklistManual");
  if (campoManual) campoManual.value = "";
}

function adicionarChecklistManual() {
  const valor = document.getElementById("inputChecklistManual").value.trim();
  if (!valor || isNaN(valor)) return alert("Digite um n√∫mero v√°lido.");

  const container = document.getElementById("checklist-container");

  // Cria novo checkbox dinamicamente
  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" class="checklistNovoPlano" value="${valor}" checked /> ${valor}`;
  container.appendChild(label);

  document.getElementById("inputChecklistManual").value = ""; // limpa o campo
}
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    function abrirDataChecklist(id, valor, dataPreenchida, osPreenchida = "") {
      document.getElementById('docIdChecklistData').value = id;
      document.getElementById('valorChecklistData').value = valor;
      document.getElementById('inputDataChecklist').value = dataPreenchida || "";
      document.getElementById('osChecklistData').value = osPreenchida || "";
      document.getElementById('popupChecklistData').style.display = 'flex';
    }

  function fecharPopupDataChecklist() {
    document.getElementById('popupChecklistData').style.display = 'none';
  }

  async function salvarDataChecklist() {
    const id = document.getElementById('docIdChecklistData').value;
    const valor = document.getElementById('valorChecklistData').value;
    const data = document.getElementById('inputDataChecklist').value;
    const os = document.getElementById('osChecklistData').value.trim();
    if (!data) return alert("Preencha a data antes de salvar.");
    const docRef = doc(db, tipoChecklist, id);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) return alert("Erro ao salvar.");
    const dados = docSnap.data();
    const datasChecklist = dados.datasChecklist || {};
    datasChecklist[valor] = { data, os };
    await updateDoc(docRef, { datasChecklist });
    fecharPopupDataChecklist();
    carregarDados();
  }

  // Torna as fun√ß√µes acess√≠veis globalmente
  window.abrirDataChecklist = abrirDataChecklist;
  window.fecharPopupDataChecklist = fecharPopupDataChecklist;
  window.salvarDataChecklist = salvarDataChecklist;

function formatarDataBR(data) {
  if (!data) return "";

  // Se for objeto Date (ex: Firestore Timestamp convertido)
  if (data instanceof Date) {
    const dia = String(data.getDate()).padStart(2, '0');
    const mes = String(data.getMonth() + 1).padStart(2, '0');
    const ano = data.getFullYear();
    return `${dia}/${mes}/${ano}`;
  }

  // Se for string (ex: "2025-08-04" ou "2025/08/04")
  const partes = data.split(/[-/]/); // divide por "-" ou "/"
  if (partes.length !== 3) return data;

  // Garante formato dd/mm/aaaa
  return `${partes[2]}/${partes[1]}/${partes[0]}`;
}

</script>




<div id="popupChecklistData" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#2c2f3f;padding:20px;border-radius:12px;width:90%;max-width:350px;">
    <h3>Preencha as informa√ß√µes</h3>

    <label>OS</label>
    <input type="text" id="osChecklistData" style="width:100%;padding:10px;margin-bottom:15px;border:none;border-radius:6px;margin-top: 10px;">

    <input type="hidden" id="docIdChecklistData">
    <input type="hidden" id="valorChecklistData">
    
    <input type="date" id="inputDataChecklist" style="width:100%;padding:10px;margin-bottom:15px;border:none;border-radius:6px;">
    
    <div style="text-align:right;">
      <button onclick="salvarDataChecklist()" style="background:#00205b;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;">Salvar</button>
      <button onclick="fecharPopupDataChecklist()" style="background:#444;color:white;padding:8px 16px;border-radius:8px;border:none;margin-left:10px;cursor:pointer;">Cancelar</button>
    </div>
  </div>
</div>


<div id="popupNovoPlano" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#2c2f3f;padding:20px;border-radius:12px;width:90%;max-width:450px;">
    <h3>Novo Plano</h3>

    <label>Cliente</label>
    <input type="text" id="novoCliente" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Plano Vendido</label>
    <select id="novoPlanoVendido" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">
      <option value="">Selecione...</option>
      <option value="Serve + Pro">Serve + Pro</option>
      <option value="Serve Digital">Serve Digital</option>
    </select>

    <label>Modelo</label>
    <input type="text" id="novoModelo" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Chassi</label>
    <input type="text" id="novoChassi" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Horas Iniciais</label>
    <input type="number" id="novoHorasIni" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Horas Finais</label>
    <input type="number" id="novoHorasFim" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Data In√≠cio</label>
    <input type="date" id="novoDataIni" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Data Fim</label>
    <input type="date" id="novoDataFim" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <label>Valor Negociado (R$)</label>
    <input type="number" id="novoValorNegociado" style="width:100%;padding:8px;margin-bottom:10px;border:none;border-radius:6px;">

    <div id="checklist-container" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
      <label><input type="checkbox" class="checklistNovoPlano" value="√ìLEO" /> √ìLEO</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="50" /> 50</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="100" /> 100</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="300" /> 300</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="600" /> 600</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="900" /> 900</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="1200" /> 1200</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="Server+" /> Server+</label>
      <label><input type="checkbox" class="checklistNovoPlano" value="Lastragem" /> Lastragem</label>
    </div>

    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
      <input type="number" id="inputChecklistManual" placeholder="Ex: 1500" style="flex:1;padding:8px;border:none;border-radius:6px;">
      <button onclick="adicionarChecklistManual()" style="background:#00205b;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;">Adicionar</button>
    </div>

    <div style="text-align:right;">
      <button onclick="salvarNovoPlano()" style="background:#00205b;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;">Salvar</button>
      <button onclick="fecharNovoPlano()" style="background:#444;color:white;padding:8px 16px;border-radius:8px;border:none;margin-left:10px;cursor:pointer;">Cancelar</button>
    </div>
  </div>
</div>

<div id="loadingImport" style="
  display: none;
  position: fixed; z-index: 9999;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  color: white; font-size: 20px;
  align-items: center;
  justify-content: center;
  font-weight: bold;
">
  <div style="margin: auto;">Importando dados, por favor aguarde...</div>
</div>

</body>

</html> 
