<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Gestores - Agro Divel 360</title>
    
    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <!-- MANTENDO O CSS ORIGINAL DA PÁGINA -->
    <link rel="stylesheet" href="/assets/css/Pages/Cadastros/CadastroTecnico.css">

    <!-- ================================================== -->
    <!--            BLOCO DE CSS PARA CORREÇÕES             -->
    <!-- ================================================== -->
    <style>
        /* 1. Aplica o mesmo estilo do input de texto para o input de email */
        .form-group input[type="email"] {
            width: 100%;
            padding: 12px 15px;
            border-radius: 5px;
            border: 1px solid var(--border-color );
            background-color: #CDCED0;
            color: #343a40;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-group input[type="email"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0, 51, 102, 0.4);
        }

        /* 2. Ajusta a cor do texto do select para ser consistente */
        .form-group select {
            color: #343a40;
        }

        /* 3. Garante que o texto dos checkboxes tenha a cor correta */
        .checkbox-group label {
            color: #343a40; /* Cor escura para o texto */
            display: flex;
            align-items: center;
            gap: 8px; /* Espaço entre o checkbox e o texto */
        }
    </style>
    <!-- ================================================== -->

</head>
<body>

    <nav id="sidebar-placeholder"></nav>

    <!-- Conteúdo Principal da Página (Estrutura Original Mantida) -->
    <section class="home">
        <div class="text">
            <h1>Gerenciar Gestores</h1>
            <p>Adicione, edite ou remova gestores do sistema.</p>
        </div>

        <div class="content-card">
            <div class="content-card-header">
                <h2 id="form-title">Novo Gestor</h2>
            </div>
            <div class="content-card-body">
                <form id="form-cadastro-gestor" class="form-layout">
                    <input type="hidden" id="gestor-id">
                    
                    <div class="form-group">
                        <label for="uid-gestor">UID do Usuário (ID do Documento)</label>
                        <input type="text" id="uid-gestor" placeholder="Cole aqui o UID do Firebase Authentication" required>
                    </div>

                    <div class="form-group">
                        <label for="nome-gestor">Nome do Gestor</label>
                        <input type="text" id="nome-gestor" placeholder="Ex: João da Silva" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email-gestor">Email (para login)</label>
                        <input type="email" id="email-gestor" placeholder="Ex: joao.silva@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="grupo-gestor">Grupo de Permissão</label>
                        <select id="grupo-gestor" required>
                            <option value="" disabled selected>Selecione um grupo</option>
                            <option value="admin">Admin</option>
                            <option value="diretoria">Diretoria</option>
                            <option value="comercial">Comercial</option>
                            <option value="pecas">Peças</option>
                            <option value="servicos">Serviços</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Filiais de Acesso</label>
                        <div id="filiais-checkboxes" class="checkbox-group">
                            <label><input type="checkbox" name="filial" value="Campos Novos"> Campos Novos</label>
                            <label><input type="checkbox" name="filial" value="Rio do Sul"> Rio do Sul</label>
                            <label><input type="checkbox" name="filial" value="Lages"> Lages</label>
                        </div>
                    </div>
                    
                    <div class="form-group" style="flex-direction: row; gap: 10px;">
                        <button type="submit" class="btn-submit">Cadastrar Gestor</button>
                        <button type="button" id="btn-cancel-edit" class="btn-delete" style="display: none;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CONTAINER DA LISTA DE GESTORES -->
        <div class="content-card technician-list-container">
            <div class="content-card-header">
                <h2>Gestores Cadastrados</h2>
            </div>
            <div class="content-card-body">
                <table class="technician-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Grupo</th>
                            <th>Filiais</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="gestor-table-body">
                        <!-- Os dados serão inseridos aqui pelo JavaScript -->
                    </tbody>
                </table>
                <div id="loading-message">Carregando gestores...</div>
                <div id="empty-message" style="display: none;">Nenhum gestor cadastrado.</div>
            </div>
        </div>
    </section>

     <!-- SCRIPT DE GERENCIAMENTO DA PÁGINA (COM CORREÇÃO) -->
   <script type="module">
        import { db } from '/assets/js/firebase-config.js';
        import { collection, onSnapshot, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // --- Elementos do DOM ---
        const form = document.getElementById('form-cadastro-gestor' );
        const formTitle = document.getElementById('form-title');
        const submitButton = form.querySelector('.btn-submit');
        const cancelButton = document.getElementById('btn-cancel-edit');
        const tableBody = document.getElementById('gestor-table-body');
        const loadingMessage = document.getElementById('loading-message');
        const emptyMessage = document.getElementById('empty-message');
        
        const gestorIdInput = document.getElementById('gestor-id'); // Usado para saber se estamos editando
        const uidInput = document.getElementById('uid-gestor'); // Nosso novo campo
        const nomeInput = document.getElementById('nome-gestor');
        const emailInput = document.getElementById('email-gestor');
        const grupoSelect = document.getElementById('grupo-gestor');
        const filiaisCheckboxes = document.querySelectorAll('input[name="filial"]');

        // --- Funções (renderTable continua igual) ---
        const renderTable = (gestores) => {
            tableBody.innerHTML = '';
            loadingMessage.style.display = 'none';
            if (gestores.length === 0) {
                emptyMessage.style.display = 'block';
                return;
            }
            emptyMessage.style.display = 'none';
            gestores.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
            gestores.forEach(gestor => {
                const row = document.createElement('tr');
                row.dataset.id = gestor.id;
                row.innerHTML = `
                    <td>${gestor.nome || 'N/A'}</td>
                    <td>${gestor.email || 'N/A'}</td>
                    <td>${gestor.grupo || 'N/A'}</td>
                    <td>${Array.isArray(gestor.filial) ? gestor.filial.join(', ') : 'N/A'}</td>
                    <td class="action-buttons">
                        <button class="btn-edit">Editar</button>
                        <button class="btn-delete">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        // --- Função de Edição (setupEditForm) ---
        const setupEditForm = async (id) => {
            const docRef = doc(db, "gestores", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                gestorIdInput.value = id;
                uidInput.value = id; // Preenche o campo UID com o ID do documento
                uidInput.disabled = true; // Bloqueia a edição do UID no modo de edição
                nomeInput.value = data.nome || '';
                nomeInput.disabled = false; // Permite editar o nome
                emailInput.value = data.email || '';
                emailInput.disabled = true; // Mantém email bloqueado
                grupoSelect.value = data.grupo || '';
                filiaisCheckboxes.forEach(cb => cb.checked = false);
                if (Array.isArray(data.filial)) {
                    data.filial.forEach(f => {
                        const checkbox = document.querySelector(`input[name="filial"][value="${f}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                formTitle.textContent = 'Editando Gestor';
                submitButton.textContent = 'Salvar Alterações';
                cancelButton.style.display = 'inline-block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // --- Função para Resetar o Formulário ---
        const resetForm = () => {
            form.reset();
            gestorIdInput.value = '';
            uidInput.disabled = false; // Libera o campo UID para o próximo cadastro
            nomeInput.disabled = false;
            emailInput.disabled = false;
            formTitle.textContent = 'Novo Gestor';
            submitButton.textContent = 'Cadastrar Gestor';
            cancelButton.style.display = 'none';
        };

        // --- Listener Principal do Formulário (Agora faz CADASTRO e EDIÇÃO) ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const isEditing = gestorIdInput.value !== '';
            
            // Pega o UID do campo de texto. Este será o ID do nosso documento.
            const docId = uidInput.value.trim();
            
            const nome = nomeInput.value.trim();
            const email = emailInput.value.trim();
            const grupo = grupoSelect.value;
            const filiaisSelecionadas = Array.from(filiaisCheckboxes)
                                            .filter(cb => cb.checked)
                                            .map(cb => cb.value);

            if (!docId || !nome || !email || !grupo) {
                alert('Por favor, preencha todos os campos: UID, Nome, Email e Grupo.');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            try {
                // Usa o UID fornecido como ID do documento
                const docRef = doc(db, "gestores", docId);
                
                const dados = { nome, email, grupo, filial: filiaisSelecionadas };

                // setDoc irá criar o documento se não existir, ou sobrescrever se existir.
                // Usamos { merge: true } na edição para não apagar outros campos por acidente.
                await setDoc(docRef, dados, { merge: isEditing });
                
                alert(`Gestor "${nome}" ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
                resetForm();

            } catch (error) {
                console.error("Erro ao salvar gestor: ", error);
                alert("Ocorreu um erro ao salvar o gestor.");
            } finally {
                submitButton.disabled = false;
            }
        });

        // --- Outros Listeners (sem alterações) ---
        tableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const row = button.closest('tr');
            const id = row.dataset.id;
            if (button.classList.contains('btn-delete')) {
                const nome = row.cells[0].textContent;
                if (confirm(`Tem certeza que deseja excluir o gestor "${nome}"?`)) {
                    try {
                        await deleteDoc(doc(db, "gestores", id));
                        alert('Gestor excluído com sucesso!');
                        resetForm();
                    } catch (error) {
                        console.error("Erro ao excluir gestor: ", error);
                        alert("Ocorreu um erro ao excluir.");
                    }
                }
            }
            if (button.classList.contains('btn-edit')) {
                setupEditForm(id);
            }
        });

        cancelButton.addEventListener('click', resetForm);

        // --- Carregamento em tempo real (sem alterações) ---
        onSnapshot(collection(db, "gestores"), (querySnapshot) => {
            const gestores = [];
            querySnapshot.forEach((doc) => {
                gestores.push({ id: doc.id, ...doc.data() });
            });
            renderTable(gestores);
        }, (error) => {
            console.error("Erro ao buscar gestores: ", error);
            loadingMessage.textContent = 'Erro ao carregar dados.';
        });
    </script>

    <!-- Scripts Globais -->
      <script type="module" src="/assets/js/firebase-config.js"></script>
      <script type="module" src="/assets/js/auth.js"></script>
      <script src="/assets/js/main.js"></script> 
      <script src="/assets/js/components/Sidebar.js"></script>
    
</body>
</html>
